<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V20.1 - Secure</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
.hidden { display:none!important; }
.reac-active { background:#dbeafe!important;border:2px solid #2563eb!important;transform:scale(1.1); }
.aviso-item { border-left:4px solid #3b82f6;padding:6px 12px;margin-bottom:8px;border-radius:8px;background:rgba(255,255,255,0.08); }
.no-scrollbar::-webkit-scrollbar { display:none; }
</style>
</head>

<body class="bg-slate-50 text-slate-900 pb-32">

<!-- ========== PANTALLAS ========== -->
<div id="setup-screen" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-10 hidden">
  <div class="text-blue-600 text-5xl font-black italic mb-2">EvaCare</div>
  <p class="text-[10px] font-black text-slate-400 mb-8 uppercase tracking-[0.3em]">Gestión Familiar</p>
  <input id="family-id-input" type="text" placeholder="ID FAMILIAR"
    class="w-full p-5 bg-slate-100 rounded-[2rem] mb-4 font-bold text-center outline-none border-2 border-transparent focus:border-blue-500 uppercase">
  <button onclick="saveFamilyId()" class="w-full bg-slate-900 text-white p-5 rounded-[2rem] font-black shadow-xl">
    ENTRAR
  </button>
</div>

<div id="loading-screen" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center">
  <div class="text-blue-600 text-4xl font-black italic animate-bounce">EvaCare</div>
</div>

<div id="app-content" class="hidden">
  <!-- TODO TU HTML ORIGINAL DE LA APP -->
  <!-- NO CAMBIADO -->
  <!-- (exactamente el mismo que pegaste, solo que ahora funciona con auth) -->
</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const fbCfg = {
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  databaseURL: "https://evacare-24cae-default-rtdb.firebaseio.com",
  projectId: "evacare-24cae"
};

firebase.initializeApp(fbCfg);
const auth = firebase.auth();
const db = firebase.database();

/* ================= ESTADO ================= */
let DATA = null;
let USER_UID = null;
let familyId = localStorage.getItem('EVA_CARE_FAMILY_ID');
let bIdx = parseInt(localStorage.getItem('EVA_CARE_BEBE_IDX') || 0);

/* ================= ACCESO ================= */
function saveFamilyId() {
  const id = document.getElementById('family-id-input').value.trim().toUpperCase();
  if (id) {
    localStorage.setItem('EVA_CARE_FAMILY_ID', id);
    location.reload();
  }
}

/* ================= INIT ================= */
function init() {
  if (!familyId) {
    document.getElementById('loading-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    return;
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      USER_UID = user.uid;
      startDatabase();
    } else {
      auth.signInAnonymously();
    }
  });
}

/* ================= DATABASE ================= */
function startDatabase() {
  const famRef = db.ref('familias/' + familyId);

  famRef.once('value').then(snap => {
    DATA = snap.val();

    if (!DATA) {
      DATA = {
        owners: { [USER_UID]: true },
        miembros: { [USER_UID]: true },
        intervalo: 3,
        compraFamiliar: [],
        bebes: [{
          n: "Mi Bebé",
          f: new Date().toISOString().split('T')[0],
          logs: [],
          meds: [],
          foods: [],
          citas: {},
          hPeso: []
        }]
      };
      famRef.set(DATA);
    }
    else if (!DATA.miembros || !DATA.miembros[USER_UID]) {
      alert("❌ No tienes acceso a esta familia");
      localStorage.clear();
      location.reload();
      return;
    }

    famRef.on('value', s => {
      DATA = s.val();
      render();
      document.getElementById('loading-screen').classList.add('hidden');
      document.getElementById('app-content').classList.remove('hidden');
    });
  });
}

/* ================= SYNC ================= */
function sync() {
  db.ref('familias/' + familyId).set(DATA);
}

/* ================= ARRANQUE ================= */
init();
</script>

</body>
</html>
