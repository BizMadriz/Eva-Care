<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V37.0</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
    .hidden { display: none !important; }
    .neon-card { background: #0f172a; color: white; border-radius: 2.5rem; }
    .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-radius: 2.5rem; border: 1px solid white; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="bg-slate-50 text-slate-900 pb-32">

<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-[999]"><div class="text-blue-600 text-5xl font-black italic animate-pulse">EvaCare</div></div>
<div id="login" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
    <div class="text-center mb-10"><h1 class="text-4xl font-black text-blue-600 italic">EvaCare</h1></div>
    <input id="email" type="email" class="w-full p-5 bg-white border rounded-2xl mb-2" placeholder="Email">
    <input id="pass" type="password" class="w-full p-5 bg-white border rounded-2xl mb-4" placeholder="Password">
    <button onclick="login()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black">ENTRAR</button>
</div>

<div id="app" class="hidden">
    <header class="p-6 flex justify-between items-center bg-white sticky top-0 z-50 border-b">
        <div>
            <select id="bebeSelector" onchange="switchBebe(this.value)" class="text-2xl font-black italic text-blue-600 outline-none border-none bg-transparent"></select>
            <p id="familySub" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest"></p>
        </div>
        <button onclick="openMenu()" class="text-slate-400 text-xl"><i class="fa-solid fa-bars"></i></button>
    </header>

    <main class="p-4 space-y-6">
        <section class="neon-card p-6 shadow-2xl">
            <h3 class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-4">Pr√≥ximos Eventos (15 d√≠as)</h3>
            <div id="visor-eventos" class="space-y-3">
                </div>
        </section>

        <div class="grid grid-cols-4 gap-2">
            <button onclick="quickLog('üí¶ Pis')" class="bg-white p-4 rounded-2xl border shadow-sm flex flex-col items-center gap-1"><i class="fa-solid fa-droplet text-cyan-500"></i><span class="text-[8px] font-black">PIS</span></button>
            <button onclick="quickLog('üí© Caca')" class="bg-white p-4 rounded-2xl border shadow-sm flex flex-col items-center gap-1"><i class="fa-solid fa-poop text-orange-800"></i><span class="text-[8px] font-black">CACA</span></button>
            <button onclick="quickLog('üõÅ Ba√±o')" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex flex-col items-center gap-1"><i class="fa-solid fa-bath text-blue-500"></i><span class="text-[8px] font-black">BA√ëO</span></button>
            <button onclick="openModal('modal-toma')" class="bg-pink-500 p-4 rounded-2xl text-white flex flex-col items-center gap-1"><i class="fa-solid fa-person-breastfeeding"></i><span class="text-[8px] font-black">TOMA</span></button>
        </div>

        <div class="bg-white rounded-[2.5rem] border shadow-sm">
            <div class="flex border-b text-[9px] font-black uppercase text-slate-400">
                <button onclick="showSec('diario')" id="b-diario" class="flex-1 p-5 border-b-2 border-blue-600 text-blue-600">Diario</button>
                <button onclick="showSec('medico')" id="b-medico" class="flex-1 p-5">M√©dico</button>
                <button onclick="showSec('comida')" id="b-comida" class="flex-1 p-5">Comida</button>
            </div>
            
            <div id="sec-diario" class="p-4 space-y-2 max-h-80 overflow-y-auto no-scrollbar"></div>

            <div id="sec-medico" class="hidden p-4 space-y-4">
                <div class="flex gap-2">
                    <button onclick="openModal('modal-medicina')" class="flex-1 p-3 bg-red-50 text-red-600 rounded-xl font-black text-[9px]">+ MEDICINA</button>
                    <button onclick="openModal('modal-crecimiento')" class="flex-1 p-3 bg-slate-100 text-slate-600 rounded-xl font-black text-[9px]">+ PESO/ALTURA</button>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl">
                    <h4 class="text-[10px] font-black mb-3">CALENDARIO OFICIAL REVISIONES</h4>
                    <div id="list-revisiones" class="space-y-2"></div>
                </div>
                <div id="med-activa" class="space-y-2"></div>
            </div>

            <div id="sec-comida" class="hidden p-4 space-y-4">
                <button onclick="openModal('modal-food')" class="w-full p-4 bg-green-50 text-green-600 rounded-2xl font-black text-[10px]">+ NUEVO ALIMENTO</button>
                <div id="food-list" class="space-y-2"></div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-20 glass-nav shadow-2xl flex justify-around items-center px-4 z-[40]">
        <button onclick="showSec('diario')" class="text-blue-600 text-xl"><i class="fa-solid fa-calendar-day"></i></button>
        <button onclick="openModal('modal-agenda')" class="bg-blue-600 w-12 h-12 rounded-2xl text-white shadow-lg"><i class="fa-solid fa-clock-rotate-left"></i></button>
        <button onclick="openModal('modal-lista')" class="text-slate-300 text-xl"><i class="fa-solid fa-cart-shopping"></i></button>
    </nav>
</div>

<div id="modal-medicina" class="hidden fixed inset-0 bg-black/80 z-[600] flex items-center justify-center p-6">
    <div class="bg-white w-full rounded-[2.5rem] p-8 space-y-3">
        <h3 class="font-black italic">Nueva Medicaci√≥n</h3>
        <input id="m-nombre" placeholder="Nombre (ej: Apiretal)" class="w-full p-4 bg-slate-50 rounded-xl outline-none">
        <div class="grid grid-cols-2 gap-2">
            <input id="m-dosis" placeholder="Dosis (ej: 2ml)" class="p-4 bg-slate-50 rounded-xl outline-none">
            <input id="m-periodo" type="number" placeholder="Cada (horas)" class="p-4 bg-slate-50 rounded-xl outline-none">
        </div>
        <input id="m-total" type="number" placeholder="D√≠as totales de tratamiento" class="w-full p-4 bg-slate-50 rounded-xl outline-none">
        <button onclick="saveMed()" class="w-full bg-red-600 text-white p-4 rounded-xl font-black">ACTIVAR TRATAMIENTO</button>
        <button onclick="closeModal('modal-medicina')" class="w-full text-slate-400 font-bold text-[10px]">CANCELAR</button>
    </div>
</div>

<div id="modal-food" class="hidden fixed inset-0 bg-black/80 z-[600] flex items-center justify-center p-6">
    <div class="bg-white w-full rounded-[2.5rem] p-8 space-y-4">
        <h3 class="font-black italic">Registro Alimento</h3>
        <input id="f-nombre" placeholder="¬øQu√© ha probado?" class="w-full p-4 bg-slate-50 rounded-xl outline-none">
        <div class="flex justify-around text-3xl">
            <button onclick="f_like=1" class="grayscale focus:grayscale-0">üòã</button>
            <button onclick="f_like=0" class="grayscale focus:grayscale-0">üòê</button>
            <button onclick="f_like=-1" class="grayscale focus:grayscale-0">ü§¢</button>
        </div>
        <label class="flex items-center gap-2 text-xs font-bold text-red-500">
            <input type="checkbox" id="f-alergia"> ¬øHa tenido reacci√≥n / alergia?
        </label>
        <button onclick="saveFood()" class="w-full bg-green-600 text-white p-4 rounded-xl font-black">GUARDAR</button>
    </div>
</div>

<script>
/* LOGICA DE NEGOCIO V37 */
// (Aqu√≠ ir√≠a la inicializaci√≥n de Firebase igual que antes)

const REVISIONES_BASE = [
    {id: '7d', t: "7 D√çAS", q: "Enfermer√≠a + Pediatr√≠a", v: "NO"},
    {id: '15d', t: "15 D√çAS", q: "Pediatr√≠a", v: "NO"},
    {id: '1m', t: "1 MES", q: "Enfermer√≠a", v: "NO"},
    {id: '2m', t: "2 MESES", q: "Enfermer√≠a + Pediatr√≠a", v: "S√ç"},
    {id: '4m', t: "4 MESES", q: "Enfermer√≠a", v: "S√ç"},
    {id: '6m', t: "6 MESES", q: "Enfermer√≠a + Pediatr√≠a", v: "NO"},
    {id: '11m', t: "11 MESES*", q: "S√≥lo vacuna (enfermer√≠a)", v: "S√ç"},
    {id: '12m', t: "12 MESES", q: "Enfermer√≠a + Pediatr√≠a", v: "S√ç"},
    {id: '15m', t: "15 MESES", q: "Enfermer√≠a", v: "S√ç"},
    {id: '2a', t: "2 A√ëOS", q: "Enfermer√≠a", v: "NO"},
    {id: '3a', t: "3 A√ëOS*", q: "S√≥lo vacuna (enfermer√≠a)", v: "S√ç"},
    {id: '4a', t: "4 A√ëOS", q: "Enfermer√≠a", v: "NO"},
    {id: '6a', t: "6 A√ëOS", q: "Enfermer√≠a + Pediatr√≠a", v: "S√ç"},
    {id: '9a', t: "9 A√ëOS", q: "Enfermer√≠a", v: "NO"},
    {id: '12a', t: "12 A√ëOS", q: "Enfermer√≠a", v: "S√ç"},
    {id: '14a', t: "14 A√ëOS", q: "Enfermer√≠a + Pediatr√≠a", v: "S√ç"}
]; // Basado en

let f_like = 0;

function render() {
    const keys = Object.keys(familyData.children || {});
    if(keys.length === 0) { show("familySetup"); return; }
    
    const b = familyData.children[keys[bIdx]];
    
    // 1. VISOR DE EVENTOS (Monitor Global)
    let eventosHTML = "";
    
    // Pr√≥xima toma (si existe intervalo)
    const proximaToma = (b.lastToma || 0) + (familyData.intervalo * 3600000);
    if(proximaToma > Date.now() && proximaToma < Date.now() + 86400000) {
        eventosHTML += `<div class="flex justify-between items-center bg-blue-500/10 p-3 rounded-xl border border-blue-500/20">
            <span class="text-[10px] font-black italic">üçº PR√ìXIMA TOMA</span>
            <span class="text-xs font-black">${new Date(proximaToma).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        </div>`;
    }

    // Medicinas activas
    Object.values(b.meds || {}).forEach(m => {
        // L√≥gica para calcular siguiente dosis basada en periodo
        eventosHTML += `<div class="flex justify-between items-center bg-red-500/10 p-3 rounded-xl border border-red-500/20 text-red-400">
            <span class="text-[10px] font-black uppercase">üíä ${m.nombre} (${m.dosis})</span>
            <span class="text-xs font-black">Faltan 2h</span>
        </div>`;
    });

    // Citas de calendario pr√≥ximas (15 d√≠as)
    Object.values(b.agenda || {}).forEach(a => {
        const diff = a.ts - Date.now();
        if(diff > 0 && diff < 15 * 86400000) {
            eventosHTML += `<div class="flex justify-between items-center bg-green-500/10 p-3 rounded-xl border border-green-500/20 text-green-400">
                <span class="text-[10px] font-black uppercase">üìÖ CITA: ${a.tit}</span>
                <span class="text-[9px] font-black">${new Date(a.ts).toLocaleDateString()}</span>
            </div>`;
        }
    });

    document.getElementById('visor-eventos').innerHTML = eventosHTML || '<p class="text-center text-slate-500 text-[10px]">No hay eventos pr√≥ximos</p>';

    // 2. CALENDARIO DE REVISIONES
    document.getElementById('list-revisiones').innerHTML = REVISIONES_BASE.map(r => `
        <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-slate-100">
            <div class="flex items-center gap-3">
                <input type="checkbox" ${b.revisiones && b.revisiones[r.id] ? 'checked' : ''} onchange="toggleRev('${r.id}')" class="w-4 h-4 rounded">
                <div>
                    <p class="text-[10px] font-black">${r.t}</p>
                    <p class="text-[8px] text-slate-400">${r.q} | Vacuna: ${r.v}</p>
                </div>
            </div>
            <button onclick="addAgenda('${r.t}')" class="text-blue-500 text-xs"><i class="fa-solid fa-calendar-plus"></i></button>
        </div>
    `).join('');

    // 3. COMIDA CON LIKES Y ALERGIA
    document.getElementById('food-list').innerHTML = Object.values(b.foods || {}).map(f => `
        <div class="bg-white p-4 rounded-2xl border ${f.alergia ? 'border-red-500 bg-red-50' : ''} flex justify-between items-center">
            <div>
                <span class="text-xs font-black">${f.like==1?'üòã':f.like==0?'üòê':'ü§¢'} ${f.nombre}</span>
                ${f.alergia ? '<p class="text-[8px] font-black text-red-600 uppercase">‚ö†Ô∏è ALERGIA DETECTADA</p>' : ''}
            </div>
            <span class="text-[9px] text-slate-300 font-black uppercase">${f.h}</span>
        </div>
    `).join('');
}

/* FUNCIONES DE REGISTRO */
function saveMed() {
    const cid = Object.keys(familyData.children)[bIdx];
    const ts = Date.now();
    db.ref(`familias/${familyId}/children/${cid}/meds/${ts}`).set({
        nombre: document.getElementById('m-nombre').value,
        dosis: document.getElementById('m-dosis').value,
        periodo: document.getElementById('m-periodo').value,
        total: document.getElementById('m-total').value,
        inicio: ts
    }).then(() => closeModal('modal-medicina'));
}

function saveFood() {
    const cid = Object.keys(familyData.children)[bIdx];
    const ts = Date.now();
    db.ref(`familias/${familyId}/children/${cid}/foods/${ts}`).set({
        nombre: document.getElementById('f-nombre').value,
        like: f_like,
        alergia: document.getElementById('f-alergia').checked,
        h: new Date().toLocaleDateString(),
        ts: ts
    }).then(() => closeModal('modal-food'));
}

function toggleRev(id) {
    const cid = Object.keys(familyData.children)[bIdx];
    const val = event.target.checked;
    db.ref(`familias/${familyId}/children/${cid}/revisiones/${id}`).set(val);
}

function addAgenda(titulo) {
    const fecha = prompt("Introduce fecha de la cita (YYYY-MM-DD):");
    if(!fecha) return;
    const cid = Object.keys(familyData.children)[bIdx];
    const ts = new Date(fecha).getTime();
    db.ref(`familias/${familyId}/children/${cid}/agenda/${ts}`).set({ tit: "REVISI√ìN " + titulo, ts });
}
</script>
</body>
</html>
