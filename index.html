<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V40.0</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
body{font-family:'Plus Jakarta Sans',sans-serif;background:#f8fafc;color:#1e293b}
.hidden{display:none!important}
.tab-active{color:#2563eb;border-bottom:3px solid #2563eb}
.card-shadow{box-shadow:0 10px 25px -5px rgba(0,0,0,.05)}
</style>
</head>

<body class="pb-28">

<!-- LOADING -->
<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-[999]">
  <div class="text-blue-600 text-5xl font-black italic animate-bounce">EvaCare</div>
  <p class="text-[10px] font-bold text-slate-400 mt-4 tracking-[0.3em] uppercase">Sincronizando</p>
</div>

<!-- LOGIN -->
<div id="sec-login" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
  <h1 class="text-4xl font-black text-blue-600 italic mb-2">EvaCare</h1>
  <p class="text-slate-400 font-bold text-xs mb-8 uppercase tracking-widest">Gesti√≥n Familiar</p>
  <div class="space-y-3">
    <input id="log-email" type="email" class="w-full p-5 border rounded-2xl" placeholder="Email">
    <input id="log-pass" type="password" class="w-full p-5 border rounded-2xl" placeholder="Contrase√±a">
    <button onclick="login()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black">ENTRAR</button>
    <button onclick="register()" class="w-full bg-slate-100 p-5 rounded-2xl font-bold">CREAR CUENTA</button>
  </div>
</div>

<!-- FAMILY -->
<div id="sec-family" class="hidden min-h-screen p-8 flex justify-center items-center">
  <div class="bg-white p-8 rounded-3xl w-full max-w-md space-y-4">
    <input id="fam-name" class="w-full p-4 bg-slate-100 rounded-xl" placeholder="Nombre de familia">
    <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">CREAR FAMILIA</button>
    <hr>
    <input id="fam-code" class="w-full p-4 bg-slate-100 rounded-xl uppercase" placeholder="C√≥digo invitaci√≥n">
    <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">UNIRSE</button>
  </div>
</div>

<!-- APP -->
<div id="sec-app" class="hidden">

<header class="p-4 bg-white flex justify-between items-center border-b">
  <select id="bebeSelector" onchange="switchBebe(this.value)" class="text-xl font-black text-blue-600"></select>
  <button onclick="toggleMenu()" class="text-slate-500"><i class="fa-solid fa-bars"></i></button>
</header>

<main class="p-4 space-y-6">

<!-- CITAS -->
<section>
<h3 class="text-xs font-black text-slate-400 uppercase mb-2">Pr√≥ximos 15 d√≠as</h3>
<div id="visor-citas" class="flex gap-4 overflow-x-auto"></div>
</section>

<!-- QUICK -->
<div class="grid grid-cols-4 gap-2">
<button onclick="quickLog('üí¶ Pis')" class="bg-white p-4 rounded-2xl">Pis</button>
<button onclick="quickLog('üí© Caca')" class="bg-white p-4 rounded-2xl">Caca</button>
<button onclick="quickLog('‚ú® Ba√±o')" class="bg-white p-4 rounded-2xl">Ba√±o</button>
<button onclick="openModal('modal-toma')" class="bg-blue-600 text-white p-4 rounded-2xl">Toma</button>
</div>

<!-- TABS -->
<div class="bg-white rounded-3xl border overflow-hidden">
<div class="flex text-xs font-black uppercase">
<button id="btn-tab-diario" onclick="showTab('tab-diario')" class="flex-1 p-4 tab-active">Diario</button>
<button id="btn-tab-salud" onclick="showTab('tab-salud')" class="flex-1 p-4">Salud</button>
<button id="btn-tab-food" onclick="showTab('tab-food')" class="flex-1 p-4">Alimentos</button>
</div>

<div id="tab-diario" class="p-4 space-y-2"></div>

<div id="tab-salud" class="hidden p-4 space-y-2">
<button onclick="openModal('modal-med')" class="w-full bg-red-100 p-3 rounded-xl">+ Medicina</button>
<button onclick="openModal('modal-cita')" class="w-full bg-orange-100 p-3 rounded-xl">+ Cita</button>
<div id="med-list"></div>
</div>

<div id="tab-food" class="hidden p-4 space-y-2">
<button onclick="openModal('modal-food')" class="w-full bg-orange-500 text-white p-3 rounded-xl">+ Alimento</button>
<div id="food-list"></div>
</div>

</div>
</main>
</div>

<!-- SIDE MENU -->
<div id="side-menu" class="hidden fixed inset-0 bg-black/50 z-50">
<div class="bg-white w-3/4 h-full p-6">
<button onclick="addChild()">+ A√±adir Beb√©</button>
<hr>
<button onclick="logout()" class="text-red-500">Cerrar sesi√≥n</button>
</div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
 apiKey:"AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
 authDomain:"evacare-24cae.firebaseapp.com",
 databaseURL:"https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
 projectId:"evacare-24cae"
});
const auth=firebase.auth(), db=firebase.database();
firebase.database().ref().keepSynced(true);

/* ========= STATE ========= */
let uid,familyId,familyData,bIdx=0,authResolved=false;

/* ========= FAILSAFE ========= */
setTimeout(()=>{
 if(!authResolved){ show("sec-login"); hide("loading"); }
},3000);

/* ========= AUTH ========= */
auth.onAuthStateChanged(user=>{
 authResolved=true; hide("loading");
 if(user){
  uid=user.uid;
  db.ref(`usuarios/${uid}/familyId`).once("value").then(s=>{
   familyId=s.val();
   familyId?loadApp():show("sec-family");
  });
 } else show("sec-login");
});

/* ========= LOGIN ========= */
function login(){
 auth.signInWithEmailAndPassword(log-email.value,log-pass.value).catch(e=>alert(e.message));
}
function register(){
 auth.createUserWithEmailAndPassword(log-email.value,log-pass.value).catch(e=>alert(e.message));
}

/* ========= APP ========= */
function loadApp(){
 db.ref("familias/"+familyId).on("value",s=>{
  familyData=s.val();
  if(!familyData.children){
   const n=prompt("Nombre del beb√©");
   if(n) db.ref(`familias/${familyId}/children/${Date.now()}`).set({name:n});
   return;
  }
  render(); show("sec-app");
 });
}

function render(){
 const keys=Object.keys(familyData.children);
 const b=familyData.children[keys[bIdx]];
 bebeSelector.innerHTML=keys.map((k,i)=>`<option value="${i}">${familyData.children[k].name}</option>`).join("");

 tab-diario.innerHTML=Object.values(b.logs||{}).sort((a,b)=>b.ts-a.ts)
 .map(l=>`<div class="p-3 bg-white rounded-xl border">${l.txt}<div class="text-xs">${l.h}</div></div>`).join("");

 med-list.innerHTML=Object.values(b.meds||{}).map(m=>`
 <div class="p-3 bg-white rounded-xl border">${m.nombre} ‚Ä¢ ${m.dosis}</div>`).join("");

 food-list.innerHTML=Object.values(b.foods||{}).map(f=>`
 <div class="p-3 bg-white rounded-xl border">${f.reaccion} ${f.nombre}</div>`).join("");
}

/* ========= ACTIONS ========= */
function quickLog(txt){
 const cid=Object.keys(familyData.children)[bIdx];
 const ts=Date.now();
 db.ref(`familias/${familyId}/children/${cid}/logs/${ts}`).set({
  txt,ts,h:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
 });
}
function addChild(){
 const n=prompt("Nombre del beb√©");
 if(n) db.ref(`familias/${familyId}/children/${Date.now()}`).set({name:n});
}

/* ========= FAMILY ========= */
function createFamily(){
 const n=fam-name.value.trim();
 const fid=db.ref("familias").push().key;
 const code=Math.random().toString(36).substring(2,8).toUpperCase();
 db.ref("familias/"+fid).set({name:n,inviteCode:code})
 .then(()=>db.ref(`usuarios/${uid}/familyId`).set(fid));
}
function joinFamily(){
 db.ref("familias").orderByChild("inviteCode").equalTo(fam-code.value.toUpperCase())
 .once("value",s=>{
  if(!s.exists()) return alert("C√≥digo inv√°lido");
  db.ref(`usuarios/${uid}/familyId`).set(Object.keys(s.val())[0]);
 });
}

/* ========= UI ========= */
function show(id){["loading","sec-login","sec-family","sec-app"].forEach(hide);document.getElementById(id).classList.remove("hidden")}
function hide(id){document.getElementById(id).classList.add("hidden")}
function showTab(id){
 ["tab-diario","tab-salud","tab-food"].forEach(t=>{
  document.getElementById(t).classList.add("hidden");
  document.getElementById("btn-"+t).classList.remove("tab-active");
 });
 document.getElementById(id).classList.remove("hidden");
 document.getElementById("btn-"+id).classList.add("tab-active");
}
function switchBebe(i){bIdx=i;render()}
function toggleMenu(){document.getElementById("side-menu").classList.toggle("hidden")}
function logout(){auth.signOut().then(()=>location.reload())}
</script>

</body>
</html>
