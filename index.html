<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V32.0 - Auth Fix</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
    .hidden { display: none !important; }
</style>
</head>
<body class="bg-slate-50 text-slate-900">

<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-[500]">
  <div class="text-blue-600 text-5xl font-black italic animate-pulse">EvaCare</div>
  <p id="loading-msg" class="text-[10px] font-bold text-slate-400 mt-4 uppercase tracking-widest">Iniciando sesiÃ³n...</p>
  <button id="btn-emergency" onclick="location.reload()" class="hidden mt-8 text-red-500 font-bold text-xs underline">REINTENTAR CONEXIÃ“N</button>
</div>

<div id="login" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
  <h1 class="text-4xl font-black text-blue-600 mb-8 italic">EvaCare</h1>
  <div class="space-y-3">
    <input id="email" type="email" class="w-full p-5 bg-white border rounded-2xl outline-none" placeholder="Email">
    <input id="pass" type="password" class="w-full p-5 bg-white border rounded-2xl outline-none" placeholder="ContraseÃ±a">
    <button onclick="login()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black shadow-lg">Entrar</button>
    <button onclick="register()" class="w-full bg-slate-100 text-slate-500 p-5 rounded-2xl font-bold">Crear cuenta</button>
  </div>
</div>

<div id="familySetup" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
  <h2 class="text-2xl font-black mb-6">Configura tu Familia</h2>
  <div class="space-y-6">
    <div class="bg-white p-6 rounded-3xl border">
        <input id="familyName" class="w-full p-4 bg-slate-50 rounded-xl mb-3" placeholder="Nombre de tu familia">
        <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">Crear Nueva</button>
    </div>
    <div class="bg-slate-900 p-6 rounded-3xl">
        <input id="joinCode" class="w-full p-4 bg-white/10 text-white rounded-xl mb-3 uppercase" placeholder="CÃ³digo de InvitaciÃ³n">
        <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">Unirse a Familia</button>
    </div>
  </div>
</div>

<div id="app" class="hidden min-h-screen pb-20">
  <header class="p-6 bg-white border-b flex justify-between items-center sticky top-0 z-50">
    <div>
        <h1 id="familyTitle" class="text-lg font-black text-blue-600 italic leading-none"></h1>
        <span class="text-[9px] font-bold text-slate-400">ID: <span id="inviteCode" class="select-all"></span></span>
    </div>
    <button onclick="logout()" class="text-red-500 text-xl p-2"><i class="fa-solid fa-power-off"></i></button>
  </header>

  <main class="p-4 space-y-4">
    <div id="children-container" class="space-y-4"></div>
    <button onclick="addChild()" class="w-full p-4 bg-blue-50 text-blue-600 rounded-2xl font-black text-xs uppercase">+ AÃ±adir BebÃ©</button>
  </main>
</div>

<script>
/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  authDomain: "evacare-24cae.firebaseapp.com",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let uid = null;
let familyId = localStorage.getItem("familyId");
let familyData = null;

/* CONTROL DE VISTAS */
const show = id => {
  ["loading","login","familySetup","app"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
};

/* AUTH LISTENER */
auth.onAuthStateChanged(user => {
  if (user) {
    uid = user.uid;
    checkFamily();
  } else {
    document.getElementById('loading').classList.add('hidden');
    show("login");
  }
});

function login(){
  auth.signInWithEmailAndPassword(email.value, pass.value).catch(e=>alert("Error: " + e.message));
}

function register(){
  auth.createUserWithEmailAndPassword(email.value, pass.value).catch(e=>alert("Error: " + e.message));
}

function logout(){
  auth.signOut();
  localStorage.clear();
  location.reload();
}

/* LOGICA FAMILIA */
function checkFamily(){
  if(!familyId){ 
    show("familySetup"); 
  } else {
    loadFamily();
  }
}

function loadFamily(){
  document.getElementById('loading-msg').innerText = "Conectando a la nube...";
  
  // Timeout por si Firebase no responde
  const timeout = setTimeout(() => {
    document.getElementById('btn-emergency').classList.remove('hidden');
    document.getElementById('loading-msg').innerText = "La conexiÃ³n estÃ¡ tardando demasiado...";
  }, 7000);

  db.ref("familias/" + familyId).on("value", snap => {
    clearTimeout(timeout);
    familyData = snap.val();
    
    if(!familyData) {
      localStorage.removeItem("familyId");
      show("familySetup");
      return;
    }
    
    render();
    show("app");
  }, error => {
    alert("Error de Firebase: " + error.message);
  });
}

function createFamily(){
  const name = familyName.value.trim();
  if(!name) return alert("Pon un nombre");
  
  const newId = db.ref("familias").push().key;
  const invite = Math.random().toString(36).substring(2,8).toUpperCase();
  
  db.ref("familias/"+newId).set({
    name: name,
    inviteCode: invite,
    members: { [uid]: "owner" },
    children: {}
  }).then(() => {
    localStorage.setItem("familyId", newId);
    familyId = newId;
    loadFamily();
  });
}

function joinFamily(){
    const code = joinCode.value.trim().toUpperCase();
    db.ref("familias").orderByChild("inviteCode").equalTo(code).once("value", snap => {
        if(!snap.exists()) return alert("CÃ³digo no vÃ¡lido");
        const fid = Object.keys(snap.val())[0];
        localStorage.setItem("familyId", fid);
        familyId = fid;
        db.ref(`familias/${fid}/members/${uid}`).set("member");
        loadFamily();
    });
}

function render(){
  familyTitle.innerText = familyData.name;
  inviteCode.innerText = familyData.inviteCode;
  
  const container = document.getElementById('children-container');
  container.innerHTML = "";
  
  Object.entries(familyData.children || {}).forEach(([id, c]) => {
    container.innerHTML += `
        <div class="bg-white p-6 rounded-[2rem] border shadow-sm">
            <h3 class="font-black text-xl text-slate-700">${c.name}</h3>
            <p class="text-xs text-slate-400 mb-4">Registro de actividades</p>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="addLog('${id}', 'ðŸ’¦ Pis')" class="bg-slate-50 p-4 rounded-2xl font-bold text-xs">ðŸ’¦ PIS</button>
                <button onclick="addLog('${id}', 'ðŸ’© Caca')" class="bg-slate-50 p-4 rounded-2xl font-bold text-xs">ðŸ’© CACA</button>
            </div>
            <div id="logs-${id}" class="mt-4 space-y-1 text-[10px] text-slate-500 italic">
                ${Object.values(c.logs || {}).reverse().slice(0,3).map(l => `<div>â€¢ ${l.txt} (${l.h})</div>`).join('')}
            </div>
        </div>
    `;
  });
}

function addChild(){
    const n = prompt("Nombre del bebÃ©:");
    if(!n) return;
    const cid = Math.random().toString(36).substring(2,6);
    db.ref(`familias/${familyId}/children/${cid}`).set({ name: n, logs: {} });
}

function addLog(childId, txt){
    const ts = Date.now();
    const h = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    db.ref(`familias/${familyId}/children/${childId}/logs/${ts}`).set({ txt, h, ts });
}

</script>
</body>
</html>
