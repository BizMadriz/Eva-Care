<!DOCTYPE html>  
<html lang="es">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>EvaCare V21.0 - Acceso Corregido</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">  
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>  
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');  
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }  
        .hidden { display: none !important; }  
        .reac-active { background: #dbeafe !important; border: 2px solid #2563eb !important; transform: scale(1.1); }
        .aviso-item { border-left: 4px solid #3b82f6; padding: 10px; margin-bottom: 8px; border-radius: 12px; background: rgba(255,255,255,0.1); }
        input, button { outline: none !important; }
    </style>  
</head>  
<body class="bg-slate-50 text-slate-900 pb-32">

<div id="setup-screen" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-8 hidden">
    <div class="text-blue-600 text-5xl font-black italic mb-2">EvaCare</div>
    <p class="text-[10px] font-black text-slate-400 mb-10 uppercase tracking-[0.3em]">Gesti√≥n de Beb√©s</p>
    
    <div id="login-form" class="w-full space-y-4">
        <div class="bg-slate-100 p-6 rounded-[2.5rem]">
            <p class="text-[9px] font-black text-slate-400 uppercase mb-2 text-center">Introduce el nombre de tu familia</p>
            <input id="family-id-input" type="text" placeholder="Ej: FamiliaPerez" class="w-full bg-transparent text-center font-bold text-2xl uppercase text-slate-700">
        </div>
        <button onclick="checkFamily()" class="w-full bg-blue-600 text-white p-6 rounded-[2.5rem] font-black shadow-xl active:scale-95 transition-all">CONTINUAR</button>
    </div>

    <div id="create-form" class="w-full space-y-4 hidden animate-fade-in">
        <div class="bg-blue-50 p-6 rounded-[2.5rem] border-2 border-blue-100 text-center">
            <p class="text-blue-600 font-black text-sm mb-1">¬°Ese ID est√° disponible!</p>
            <p class="text-slate-500 text-[10px]">¬øQuieres crear una nueva cuenta familiar con este nombre?</p>
        </div>
        <button onclick="createNewFamily()" class="w-full bg-slate-900 text-white p-6 rounded-[2.5rem] font-black shadow-xl">S√ç, CREAR FAMILIA</button>
        <button onclick="location.reload()" class="w-full text-slate-400 font-bold text-xs">USAR OTRO NOMBRE</button>
    </div>
</div>

<div id="loading-screen" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center">
    <div class="text-blue-600 text-4xl font-black italic animate-pulse">EvaCare</div>
</div>

<div id="app-content" class="hidden">
    <header class="p-6 flex justify-between items-center bg-white/80 sticky top-0 z-40 border-b border-slate-100 backdrop-blur-md">
        <div class="flex flex-col">
            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Cuidando a:</span>
            <select id="bebe-selector" onchange="switchBebe(this.value)" class="bg-transparent font-black italic text-2xl outline-none text-blue-600 cursor-pointer"></select>
        </div>
        <div id="sync-status"></div>
        <button onclick="openModal('modal-menu')" class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center text-slate-400"><i class="fa-solid fa-bars-staggered"></i></button>
    </header>

    <main id="tab-inicio" class="p-4 space-y-4">
        <div class="bg-slate-900 rounded-[2.5rem] p-7 text-white shadow-2xl">
            <div id="panel-avisos-global" class="space-y-2"></div>
        </div>

        <div id="lista-compra-global" class="space-y-2"></div>

        <div class="grid grid-cols-4 gap-3">
            <button onclick="addLog('üí¶ Pis')" class="bg-white py-6 rounded-[2rem] font-black text-cyan-600 text-[10px] border shadow-sm flex flex-col items-center gap-2"><i class="fa-solid fa-droplet text-lg"></i>PIS</button>
            <button onclick="addLog('üí© Caca')" class="bg-white py-6 rounded-[2rem] font-black text-orange-800 text-[10px] border shadow-sm flex flex-col items-center gap-2"><i class="fa-solid fa-poop text-lg"></i>CACA</button>
            <button onclick="addLog('‚ú® Aseo')" class="bg-white py-6 rounded-[2rem] font-black text-purple-600 text-[10px] border shadow-sm flex flex-col items-center gap-2"><i class="fa-solid fa-sparkles text-lg"></i>ASEO</button>
            <button onclick="addCompra()" class="bg-yellow-400 text-slate-900 rounded-[2rem] flex items-center justify-center shadow-lg text-xl"><i class="fa-solid fa-cart-shopping"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="openModal('modal-pecho')" class="bg-white h-28 rounded-[2.5rem] border shadow-sm flex flex-col items-center justify-center active:bg-pink-50">
                <i class="fa-solid fa-person-breastfeeding text-pink-500 mb-2 text-2xl"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">Pecho</span>
            </button>
            <div class="space-y-3">
                <button onclick="openModal('modal-bibe')" class="w-full bg-white h-16 rounded-[1.8rem] border shadow-sm flex items-center justify-center gap-3 active:bg-blue-50">
                    <i class="fa-solid fa-bottle-water text-blue-500 text-xl"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">Biber√≥n</span>
                </button>
                <button id="btn-repetir" onclick="repetirBibe()" class="w-full bg-blue-600 text-white h-9 rounded-full text-[9px] font-black uppercase shadow-md hidden italic">Repetir √∫ltima</button>
            </div>
        </div>

        <div id="diario-hoy" class="space-y-2 pb-10"></div>
    </main>

    <main id="tab-nutricion" class="hidden p-4 space-y-5">
        <h2 class="text-3xl font-black italic text-orange-600 px-2">Comida</h2>
        <div class="bg-white p-7 rounded-[3rem] shadow-sm border space-y-5">
            <input id="food-input" type="text" placeholder="Ej: Pur√© de verduras" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-none">
            <div class="flex justify-around bg-slate-50 p-3 rounded-2xl">
                <button onclick="setReac('üòã', this)" class="reac-btn p-4 rounded-xl text-3xl">üòã</button>
                <button onclick="setReac('ü§¢', this)" class="reac-btn p-4 rounded-xl text-3xl">ü§¢</button>
                <button onclick="setReac('‚ö†Ô∏è', this)" class="reac-btn px-4 rounded-xl text-[10px] font-black text-red-500">ALERGIA</button>
            </div>
            <button onclick="saveFood()" class="w-full bg-orange-500 text-white p-5 rounded-2xl font-black">GUARDAR</button>
        </div>
        <div id="lista-alimentos" class="space-y-2"></div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-18 bg-white/90 backdrop-blur-xl rounded-full border shadow-2xl flex justify-around items-center z-50">  
        <button onclick="showTab('inicio')" id="nav-inicio" class="text-blue-600 p-4"><i class="fa-solid fa-house-chimney text-2xl"></i></button>  
        <button onclick="showTab('nutricion')" id="nav-nutricion" class="text-slate-300 p-4"><i class="fa-solid fa-carrot text-2xl"></i></button>  
        <button onclick="showTab('salud')" id="nav-salud" class="text-slate-300 p-4"><i class="fa-solid fa-suitcase-medical text-2xl"></i></button>  
        <button onclick="showTab('cal')" id="nav-cal" class="text-slate-300 p-4"><i class="fa-solid fa-calendar-day text-2xl"></i></button>  
    </nav>
</div>

<div id="modal-bibe" class="hidden fixed inset-0 bg-black/80 z-[11000] flex items-center justify-center p-6"><div class="bg-white w-full rounded-[3rem] p-10 space-y-5"><input id="in-ml" type="number" placeholder="ml" class="w-full p-8 bg-slate-100 rounded-3xl text-center text-6xl font-black"><button onclick="addBibe()" class="w-full bg-blue-600 text-white p-6 rounded-3xl font-black text-xl shadow-lg">GUARDAR</button><button onclick="closeModal('modal-bibe')" class="w-full text-slate-400 font-bold text-xs uppercase">Cerrar</button></div></div>
<div id="modal-pecho" class="hidden fixed inset-0 bg-black/80 z-[11000] flex items-end"><div class="bg-white w-full p-10 rounded-t-[4rem] grid grid-cols-3 gap-4 shadow-2xl"><button onclick="addLog('ü§± Izquierdo', true); closeModal('modal-pecho')" class="bg-pink-50 p-8 rounded-3xl font-black text-pink-600 text-[10px]">IZQUIERDO</button><button onclick="addLog('ü§± Ambos', true); closeModal('modal-pecho')" class="bg-pink-600 p-8 rounded-3xl font-black text-white text-[10px]">AMBOS</button><button onclick="addLog('ü§± Derecho', true); closeModal('modal-pecho')" class="bg-pink-50 p-8 rounded-3xl font-black text-pink-600 text-[10px]">DERECHO</button></div></div>
<div id="modal-menu" class="hidden fixed inset-0 bg-black/80 z-[11000] flex justify-end"><div class="bg-white w-4/5 h-full p-10 flex flex-col"><h2 class="text-4xl font-black italic mb-10">Ajustes</h2><div class="space-y-6 flex-1 overflow-y-auto no-scrollbar"><div class="bg-slate-50 p-6 rounded-[2rem]"><label class="text-[9px] font-black text-blue-600 uppercase">A√±adir otro Beb√©</label><input type="text" id="new-n" placeholder="Nombre" class="w-full p-4 bg-white rounded-2xl mt-2 font-bold"><button onclick="addNewBebe()" class="w-full bg-blue-600 text-white p-4 rounded-2xl mt-3 font-black text-[10px]">A√ëADIR</button></div><button onclick="localStorage.clear();location.reload()" class="w-full text-red-500 font-black text-[10px] uppercase p-6 rounded-3xl bg-red-50">Cerrar Sesi√≥n</button></div><button onclick="closeModal('modal-menu')" class="mt-4 p-4 text-slate-300 font-black">VOLVER</button></div></div>

<script>
    const fbCfg = { apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I", databaseURL: "https://evacare-24cae-default-rtdb.firebaseio.com", projectId: "evacare-24cae" };
    firebase.initializeApp(fbCfg); const db = firebase.database();

    let DATA = null, familyId = localStorage.getItem('EVA_CARE_FAMILY_ID'), bIdx = parseInt(localStorage.getItem('EVA_CARE_BEBE_IDX') || 0);
    let curReac = "";

    // --- SISTEMA DE ACCESO (FIXED) ---
    function checkFamily() {
        const id = document.getElementById('family-id-input').value.trim().toUpperCase();
        if(!id) return alert("Escribe un nombre para tu familia");
        
        db.ref('familias/' + id).once('value', snap => {
            if(snap.exists()) {
                localStorage.setItem('EVA_CARE_FAMILY_ID', id);
                location.reload();
            } else {
                // Si no existe, mostramos el formulario de creaci√≥n
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('create-form').classList.remove('hidden');
                // Guardamos el ID temporalmente en una variable global para el siguiente paso
                window.pendingId = id;
            }
        });
    }

    function createNewFamily() {
        const id = window.pendingId;
        const initialData = {
            intervalo: 3,
            compraFamiliar: [],
            bebes: [{
                n: "Mi Beb√©",
                logs: [], meds: [], foods: [], hPeso: [],
                f: new Date().toISOString().split('T')[0]
            }]
        };
        db.ref('familias/' + id).set(initialData).then(() => {
            localStorage.setItem('EVA_CARE_FAMILY_ID', id);
            location.reload();
        });
    }

    function init() {
        if(!familyId) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            return;
        }
        db.ref('familias/' + familyId).on('value', snap => {
            DATA = snap.val();
            if(!DATA) { localStorage.clear(); location.reload(); return; }
            if(!DATA.bebes[bIdx]) bIdx = 0;
            render();
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
        });
    }

    // --- RENDERIZADO Y BOTONES ---
    function render() {
        const b = DATA.bebes[bIdx];
        document.getElementById('bebe-selector').innerHTML = DATA.bebes.map((x,i)=>`<option value="${i}" ${i===bIdx?'selected':''}>${x.n.toUpperCase()}</option>`).join('');

        // Avisos Globales de todos los beb√©s
        let htmlAvisos = "";
        DATA.bebes.forEach(bebe => {
            const msProxima = (bebe.lastToma || 0) + (DATA.intervalo * 3600000);
            const restMs = msProxima - Date.now();
            if(restMs <= 0) {
                htmlAvisos += `<div class="aviso-item border-red-500 text-red-100 font-bold text-xs"><i class="fa-solid fa-clock mr-2"></i>${bebe.n}: Toca toma</div>`;
            }
        });
        document.getElementById('panel-avisos-global').innerHTML = htmlAvisos || '<p class="text-[10px] text-blue-400 font-black uppercase text-center tracking-widest">Sin alertas pendientes</p>';

        // Compra
        document.getElementById('lista-compra-global').innerHTML = (DATA.compraFamiliar || []).map((x,i)=>`
            <div class="bg-yellow-100 p-4 rounded-3xl flex justify-between items-center text-[10px] font-black uppercase text-yellow-800">
                <span>üõí ${x.txt} <small class="opacity-50">(${x.para})</small></span>
                <button onclick="removeCompra(${i})" class="bg-yellow-500 text-white w-8 h-8 rounded-full shadow-lg"><i class="fa-solid fa-check"></i></button>
            </div>`).join('');

        // Bot√≥n repetir
        const btnRep = document.getElementById('btn-repetir');
        if(b.lastMl) { btnRep.innerText=`Repetir ${b.lastMl}ml`; btnRep.classList.remove('hidden'); } else { btnRep.classList.add('hidden'); }

        // Historial
        document.getElementById('diario-hoy').innerHTML = (b.logs||[]).slice(0,10).map(l=>`<div class="bg-white p-5 rounded-3xl flex justify-between items-center border-b shadow-sm"><span class="font-bold text-xs text-slate-600">${l.txt}</span><span class="text-[9px] font-black text-slate-300">${l.h}</span></div>`).join('');
    }

    // --- ACCIONES ---
    function sync() { db.ref('familias/' + familyId).set(DATA); }
    function addLog(txt, resets = false) {
        const b = DATA.bebes[bIdx]; if(!b.logs) b.logs = [];
        const entry = { txt, h: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}), ts: Date.now() };
        b.logs.unshift(entry); if(resets) b.lastToma = entry.ts; sync();
    }
    function addBibe() { const ml = document.getElementById('in-ml').value; if(ml){ addLog(`üçº Biber√≥n ${ml}ml`, true); DATA.bebes[bIdx].lastMl = ml; closeModal('modal-bibe'); document.getElementById('in-ml').value=""; } }
    function repetirBibe() { if(DATA.bebes[bIdx].lastMl) addLog(`üçº Biber√≥n ${DATA.bebes[bIdx].lastMl}ml`, true); }
    function addCompra() { const item = prompt("Necesito comprar..."); if(item){ if(!DATA.compraFamiliar) DATA.compraFamiliar = []; DATA.compraFamiliar.push({txt:item, para:DATA.bebes[bIdx].n}); sync(); } }
    function removeCompra(i) { DATA.compraFamiliar.splice(i,1); sync(); }
    function switchBebe(v) { bIdx = parseInt(v); localStorage.setItem('EVA_CARE_BEBE_IDX', v); render(); }
    function saveFood() { const n = document.getElementById('food-input').value; if(n){ if(!DATA.bebes[bIdx].foods) DATA.bebes[bIdx].foods = []; DATA.bebes[bIdx].foods.push({n, r:curReac||'‚ùì'}); document.getElementById('food-input').value=""; curReac=""; document.querySelectorAll('.reac-btn').forEach(x=>x.classList.remove('reac-active')); sync(); } }
    function setReac(r, b) { curReac = r; document.querySelectorAll('.reac-btn').forEach(x=>x.classList.remove('reac-active')); b.classList.add('reac-active'); }
    function addNewBebe() { const n = document.getElementById('new-n').value; if(n) { DATA.bebes.push({n, logs:[], meds:[], foods:[], hPeso:[]}); sync(); closeModal('modal-menu'); } }
    function showTab(t) { document.querySelectorAll('main').forEach(m=>m.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b=>b.className='text-slate-300 p-4'); document.getElementById('nav-'+t).className='text-blue-600 p-4'; }
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    init();
    setInterval(render, 30000);
</script>
</body>
</html>
