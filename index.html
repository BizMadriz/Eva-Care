<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaCare V30 - Final</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
    .hidden { display: none !important; }
    .reac-active { background: #dbeafe !important; border: 2px solid #2563eb !important; transform: scale(1.05); }
    .aviso-item { border-left: 4px solid #3b82f6; padding: 6px 12px; margin-bottom: 8px; border-radius: 8px; background: rgba(255,255,255,0.08); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="bg-slate-50 text-slate-900">

<!-- Loading -->
<div id="loading-screen" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center p-6">
    <div class="text-blue-600 text-4xl font-black italic animate-bounce mb-4">EvaCare</div>
    <div id="status-msg" class="text-slate-400 text-[10px] uppercase tracking-widest">Iniciando...</div>
</div>

<!-- Login / Registro -->
<div id="login-screen" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-10 hidden">
    <div class="text-blue-600 text-5xl font-black italic mb-4">EvaCare</div>
    <input id="email-input" type="email" placeholder="Correo electrónico" class="w-full p-5 bg-slate-100 rounded-2xl mb-4 font-bold text-center outline-none">
    <input id="pass-input" type="password" placeholder="Contraseña" class="w-full p-5 bg-slate-100 rounded-2xl mb-4 font-bold text-center outline-none">
    <div class="flex gap-4 mb-4">
        <button onclick="login()" class="flex-1 bg-blue-600 text-white p-4 rounded-2xl font-black">Entrar</button>
        <button onclick="register()" class="flex-1 bg-green-600 text-white p-4 rounded-2xl font-black">Crear cuenta</button>
    </div>
    <p class="text-[10px] text-slate-400 italic">Después de registrarte, podrás crear o unirte a una familia.</p>
</div>

<!-- Familia -->
<div id="family-screen" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-10 hidden">
    <div class="text-blue-600 text-5xl font-black italic mb-4">EvaCare</div>
    <p class="text-[10px] font-black text-slate-400 mb-4 uppercase tracking-[0.3em]">Gestión Familiar</p>
    <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black mb-4">Crear familia</button>
    <input id="family-code-input" type="text" placeholder="Código de familia" class="w-full p-5 bg-slate-100 rounded-2xl mb-4 font-bold text-center outline-none">
    <button onclick="joinFamily()" class="w-full bg-green-600 text-white p-5 rounded-2xl font-black">Unirse a familia</button>
    <p id="family-msg" class="text-[10px] text-red-500 mt-2"></p>
</div>

<!-- App -->
<div id="app-content" class="hidden min-h-screen pb-32">

<header class="p-6 flex justify-between items-center bg-white border-b sticky top-0 z-50">
    <div>
        <p class="text-[8px] font-bold text-slate-400 uppercase">Familia:</p>
        <h1 id="display-family" class="text-xl font-black text-blue-600 italic">---</h1>
    </div>
    <button onclick="logout()" class="text-[10px] font-black text-red-400 bg-red-50 px-4 py-2 rounded-full">Salir</button>
</header>

<main class="p-4 space-y-4">
    <div id="panel-avisos-global" class="space-y-3"></div>
    <div id="child-list" class="space-y-4"></div>
    <button onclick="addChild()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black">Añadir hijo</button>
</main>

</div>

<script>
    // --- Config Firebase ---
    const fbCfg = {
        apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
        authDomain: "evacare-24cae.firebaseapp.com",
        databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "evacare-24cae"
    };
    firebase.initializeApp(fbCfg);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- Variables ---
    let uid = localStorage.getItem('EVA_CARE_UID');
    let familyId = localStorage.getItem('EVA_CARE_FAMILY_ID');
    let DATA = null;

    // --- Funciones de Login ---
    function showScreen(id){
        ['loading-screen','login-screen','family-screen','app-content'].forEach(x=>document.getElementById(x).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function login(){
        const email = document.getElementById('email-input').value.trim();
        const pass = document.getElementById('pass-input').value.trim();
        if(!email || !pass) return alert("Email y contraseña obligatorios");
        showScreen('loading-screen');
        auth.signInWithEmailAndPassword(email,pass)
        .then(res=>{
            uid=res.user.uid;
            localStorage.setItem('EVA_CARE_UID',uid);
            showScreen('family-screen');
        })
        .catch(err=>{ alert(err.message); showScreen('login-screen'); });
    }

    function register(){
        const email = document.getElementById('email-input').value.trim();
        const pass = document.getElementById('pass-input').value.trim();
        if(!email || !pass) return alert("Email y contraseña obligatorios");
        showScreen('loading-screen');
        auth.createUserWithEmailAndPassword(email,pass)
        .then(res=>{
            uid=res.user.uid;
            localStorage.setItem('EVA_CARE_UID',uid);
            showScreen('family-screen');
        })
        .catch(err=>{ alert(err.message); showScreen('login-screen'); });
    }

    // --- Funciones Familia ---
    function generateCode(len=6){
        return Math.random().toString(36).substring(2,len+2).toUpperCase();
    }

    function createFamily(){
        if(!uid) return;
        const code = generateCode();
        familyId = code;
        localStorage.setItem('EVA_CARE_FAMILY_ID',familyId);
        db.ref('familias/'+familyId).set({creator:uid, members:{[uid]:true}, children:{}, logs:{}})
        .then(()=>loadFamily());
        alert("Familia creada. Código: "+code);
    }

    function joinFamily(){
        const code = document.getElementById('family-code-input').value.trim().toUpperCase();
        if(!code) return;
        db.ref('familias/'+code+'/members/'+uid).set(true)
        .then(()=>{ familyId=code; localStorage.setItem('EVA_CARE_FAMILY_ID',familyId); loadFamily(); })
        .catch(err=>alert(err.message));
    }

    function loadFamily(){
        if(!uid || !familyId) return;
        showScreen('loading-screen');
        db.ref('familias/'+familyId).on('value',snap=>{
            DATA = snap.val();
            document.getElementById('display-family').innerText = familyId;
            renderChildren();
            renderAvisos();
            showScreen('app-content');
        });
    }

    function logout(){
        auth.signOut();
        localStorage.clear();
        location.reload();
    }

    // --- Funciones Hijos ---
    function renderChildren(){
        const container = document.getElementById('child-list');
        container.innerHTML='';
        if(!DATA.children) DATA.children={};
        Object.entries(DATA.children).forEach(([cid,c])=>{
            const div = document.createElement('div');
            div.className="bg-white p-4 rounded-2xl shadow flex justify-between items-center";
            div.innerHTML=`
                <div>
                    <p class="font-black text-sm">Nombre: <input value="${c.name}" onblur="updateChild('${cid}','name',this.value)" class="border p-1 rounded"/></p>
                    <p class="text-[10px]">Nacimiento: <input type="date" value="${c.birth}" onblur="updateChild('${cid}','birth',this.value)"/></p>
                    <p class="text-[10px]">Peso: <input type="number" value="${c.weight||''}" onblur="updateChild('${cid}','weight',this.value)" step="0.01"/> kg</p>
                    <p class="text-[10px]">Talla: <input type="number" value="${c.height||''}" onblur="updateChild('${cid}','height',this.value)"/> cm</p>
                </div>
                <button onclick="deleteChild('${cid}')" class="text-red-500 font-black">X</button>
            `;
            container.appendChild(div);
        });
    }

    function addChild(){
        const cid = generateCode(8);
        if(!DATA.children) DATA.children={};
        DATA.children[cid]={name:"Nuevo hijo",birth:"",weight:"",height:""};
        db.ref('familias/'+familyId+'/children/'+cid).set(DATA.children[cid]);
    }

    function updateChild(cid,field,value){
        db.ref('familias/'+familyId+'/children/'+cid+'/'+field).set(value);
    }

    function deleteChild(cid){
        db.ref('familias/'+familyId+'/children/'+cid).remove();
    }

    // --- Avisos ---
    function renderAvisos(){
        const container = document.getElementById('panel-avisos-global');
        container.innerHTML='';
        if(!DATA.logs) DATA.logs={};
        Object.values(DATA.logs).forEach(l=>{
            const div=document.createElement('div');
            div.className='aviso-item';
            div.innerText=l.txt;
            container.appendChild(div);
        });
    }

    // --- Inicio ---
    if(uid && familyId){
        loadFamily();
    } else {
        showScreen('login-screen');
    }
</script>
</body>
</html>
