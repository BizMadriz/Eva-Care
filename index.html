<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V35.0 - Master Edition</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
    .hidden { display: none !important; }
    .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); }
    .neon-card { background: #0f172a; border-radius: 2.5rem; color: white; }
    .btn-action:active { transform: scale(0.95); }
    .tab-active { color: #2563eb; font-weight: 800; border-bottom: 3px solid #2563eb; }
    ::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="bg-slate-50 text-slate-900 pb-32">

<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-[999]">
    <div class="text-blue-600 text-5xl font-black italic animate-bounce">EvaCare</div>
</div>

<div id="login" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
    <h1 class="text-4xl font-black text-blue-600 mb-8 italic">EvaCare</h1>
    <div class="space-y-3">
        <input id="email" type="email" class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl outline-none" placeholder="Email">
        <input id="pass" type="password" class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl outline-none" placeholder="Contrase√±a">
        <button onclick="login()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black shadow-xl">ENTRAR</button>
        <button onclick="register()" class="w-full bg-slate-100 text-slate-500 p-5 rounded-2xl font-bold">CREAR CUENTA</button>
    </div>
</div>

<div id="familySetup" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
    <h2 class="text-2xl font-black mb-8 italic text-blue-600">Configuraci√≥n Familiar</h2>
    <div class="space-y-6">
        <div class="bg-white p-6 rounded-[2rem] shadow-sm border">
            <input id="familyName" class="w-full p-4 bg-slate-50 rounded-xl mb-3" placeholder="Apellidos de la familia">
            <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">CREAR NUEVA</button>
        </div>
        <div class="bg-slate-900 p-6 rounded-[2rem] text-white">
            <input id="joinCode" class="w-full p-4 bg-white/10 rounded-xl mb-3 uppercase" placeholder="C√≥digo invitaci√≥n">
            <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">UNIRSE</button>
        </div>
    </div>
</div>

<div id="app" class="hidden">
    <header class="p-6 bg-white flex justify-between items-center sticky top-0 z-50 border-b border-slate-100">
        <div>
            <select id="bebeSelector" onchange="switchBebe(this.value)" class="text-2xl font-black italic text-blue-600 bg-transparent outline-none"></select>
            <p id="familyTitle" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1"></p>
        </div>
        <div class="flex gap-2">
            <button onclick="openModal('modal-perfil')" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-500"><i class="fa-solid fa-baby-carriage"></i></button>
            <button onclick="logout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-full flex items-center justify-center"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </header>

    <div class="flex bg-white border-b px-6 sticky top-[81px] z-40">
        <button onclick="setTab('home')" id="tab-home" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest tab-active">Inicio</button>
        <button onclick="setTab('salud')" id="tab-salud" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Salud</button>
        <button onclick="setTab('food')" id="tab-food" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Comida</button>
    </div>

    <main class="p-4 space-y-6">
        
        <div id="sec-home" class="space-y-6">
            <div class="neon-card p-8 shadow-2xl relative overflow-hidden">
                <h3 class="text-[9px] font-black text-blue-400 uppercase tracking-[0.3em] mb-4">Pr√≥xima Toma</h3>
                <div class="flex justify-between items-end">
                    <div>
                        <div id="timerDisplay" class="text-6xl font-black italic tracking-tighter">--:--</div>
                        <p id="lastLogText" class="text-[10px] text-slate-400 font-bold mt-2 uppercase italic">Esperando datos...</p>
                    </div>
                    <button onclick="openModal('modal-intervalo')" class="bg-white/10 p-3 rounded-2xl text-[10px] font-black text-blue-300">
                        <i class="fa-solid fa-clock"></i> <span id="valIntervalo">3</span>h
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-3">
                <button onclick="logQuick('üí¶ Pis')" class="btn-action bg-white h-24 border rounded-[2rem] flex flex-col items-center justify-center gap-2"><i class="fa-solid fa-droplet text-cyan-500"></i><span class="text-[8px] font-black uppercase">Pis</span></button>
                <button onclick="logQuick('üí© Caca')" class="btn-action bg-white h-24 border rounded-[2rem] flex flex-col items-center justify-center gap-2"><i class="fa-solid fa-poop text-orange-800"></i><span class="text-[8px] font-black uppercase">Caca</span></button>
                <button onclick="openModal('modal-bibe')" class="btn-action bg-white h-24 border rounded-[2rem] flex flex-col items-center justify-center gap-2"><i class="fa-solid fa-bottle-water text-blue-500"></i><span class="text-[8px] font-black uppercase">Bibe</span></button>
                <button onclick="openModal('modal-pecho')" class="btn-action bg-pink-500 h-24 rounded-[2rem] text-white flex flex-col items-center justify-center gap-2"><i class="fa-solid fa-person-breastfeeding"></i><span class="text-[8px] font-black uppercase">Pecho</span></button>
            </div>

            <div id="diarioList" class="space-y-2"></div>
        </div>

        <div id="sec-salud" class="hidden space-y-4">
            <div class="bg-red-50 p-6 rounded-[2.5rem] border border-red-100">
                <h3 class="font-black text-red-600 mb-4 uppercase text-xs tracking-widest text-center">Calendario M√©dico / Alertas</h3>
                <button onclick="addSalud()" class="w-full bg-red-600 text-white p-4 rounded-2xl font-black text-xs uppercase shadow-lg shadow-red-200">+ Registrar Medicina</button>
            </div>
            <div id="saludList" class="space-y-2"></div>
        </div>

        <div id="sec-food" class="hidden space-y-4">
            <div class="bg-green-50 p-6 rounded-[2.5rem] border border-green-100">
                <h3 class="font-black text-green-600 mb-4 uppercase text-xs tracking-widest text-center">Introducci√≥n Alimentaria</h3>
                <button onclick="addFood()" class="w-full bg-green-600 text-white p-4 rounded-2xl font-black text-xs uppercase shadow-lg shadow-green-200">+ Nuevo Alimento</button>
            </div>
            <div id="foodList" class="space-y-2"></div>
        </div>

    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-20 glass border border-white rounded-[2.5rem] shadow-2xl flex justify-around items-center px-4 z-50">
        <button onclick="setTab('home')" class="text-slate-300 text-xl"><i class="fa-solid fa-house"></i></button>
        <button onclick="openModal('modal-compra')" class="w-14 h-14 bg-blue-600 text-white rounded-2xl shadow-xl shadow-blue-200 flex items-center justify-center text-xl"><i class="fa-solid fa-cart-shopping"></i></button>
        <button onclick="addChild()" class="text-slate-300 text-xl"><i class="fa-solid fa-plus"></i></button>
    </nav>
</div>

<div id="modal-perfil" class="hidden fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-6">
    <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 space-y-4">
        <h2 class="font-black text-xl italic text-blue-600">Perfil del Beb√©</h2>
        <input id="editName" class="w-full p-4 bg-slate-100 rounded-xl font-bold" placeholder="Nombre">
        <div class="flex gap-2">
            <input id="editBirth" type="date" class="w-full p-4 bg-slate-100 rounded-xl text-xs font-bold">
            <input id="editPeso" type="number" step="0.01" class="w-full p-4 bg-slate-100 rounded-xl text-xs font-bold" placeholder="Peso (kg)">
        </div>
        <button onclick="savePerfil()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">GUARDAR CAMBIOS</button>
        <button onclick="deleteChild()" class="w-full text-red-500 font-bold text-[10px] uppercase">Eliminar Beb√©</button>
        <button onclick="closeModal('modal-perfil')" class="w-full text-slate-400 font-bold text-[10px]">CANCELAR</button>
    </div>
</div>

<div id="modal-bibe" class="hidden fixed inset-0 bg-black/80 z-[1000] flex items-center justify-center p-6"><div class="bg-white w-full max-w-xs rounded-[3rem] p-10 space-y-4"><input id="in-ml" type="number" placeholder="ml" class="w-full p-4 bg-slate-100 rounded-2xl text-center text-4xl font-black outline-none"><button onclick="saveBibe()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black uppercase">Guardar</button><button onclick="closeModal('modal-bibe')" class="w-full text-slate-400 font-bold text-xs uppercase">Cancelar</button></div></div>
<div id="modal-pecho" class="hidden fixed inset-0 bg-black/80 z-[1000] flex items-end"><div class="bg-white w-full p-10 rounded-t-[4rem] grid grid-cols-3 gap-3"><button onclick="logQuick('ü§± Izquierdo',true);closeModal('modal-pecho')" class="bg-pink-50 p-8 rounded-3xl font-black text-pink-600 text-[10px]">IZQ</button><button onclick="logQuick('ü§± Ambos',true);closeModal('modal-pecho')" class="bg-pink-600 p-8 rounded-3xl font-black text-white text-[10px]">AMBOS</button><button onclick="logQuick('ü§± Derecho',true);closeModal('modal-pecho')" class="bg-pink-50 p-8 rounded-3xl font-black text-pink-600 text-[10px]">DER</button></div></div>
<div id="modal-compra" class="hidden fixed inset-0 bg-black/80 z-[1000] flex items-center justify-center p-6"><div class="bg-white w-full max-w-xs rounded-[3rem] p-8 space-y-4"><h3 class="font-black italic text-xl">Lista Compra</h3><div id="compraList" class="space-y-2 max-h-48 overflow-y-auto"></div><button onclick="addCompraItem()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">+ A√ëADIR</button><button onclick="closeModal('modal-compra')" class="w-full text-slate-400 font-bold text-xs">CERRAR</button></div></div>
<div id="modal-intervalo" class="hidden fixed inset-0 bg-black/80 z-[1000] flex items-center justify-center p-6"><div class="bg-white w-full max-w-xs rounded-[3rem] p-10 space-y-4"><h3 class="font-black text-center text-xs uppercase tracking-widest">Intervalo de tomas (Horas)</h3><input id="in-intervalo" type="number" class="w-full p-4 bg-slate-100 rounded-2xl text-center text-4xl font-black outline-none"><button onclick="saveIntervalo()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">ACTUALIZAR</button></div></div>

<script>
/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  authDomain: "evacare-24cae.firebaseapp.com",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.database();

let uid = null, familyId = localStorage.getItem("familyId"), familyData = null, bIdx = 0;

/* AUTH */
auth.onAuthStateChanged(user => {
    if (user) { uid = user.uid; if(!familyId) show('familySetup'); else loadData(); }
    else { document.getElementById('loading').classList.add('hidden'); show('login'); }
});

function login() { auth.signInWithEmailAndPassword(email.value, pass.value).catch(e=>alert(e.message)); }
function register() { auth.createUserWithEmailAndPassword(email.value, pass.value).catch(e=>alert(e.message)); }
function logout() { auth.signOut(); localStorage.clear(); location.reload(); }

/* UI */
const show = id => { ["loading","login","familySetup","app"].forEach(x=>document.getElementById(x).classList.add("hidden")); document.getElementById(id).classList.remove("hidden"); };
const openModal = id => document.getElementById(id).classList.remove('hidden');
const closeModal = id => document.getElementById(id).classList.add('hidden');

function setTab(tab) {
    ["home","salud","food"].forEach(t => { document.getElementById('sec-'+t).classList.add('hidden'); document.getElementById('tab-'+t).classList.remove('tab-active'); document.getElementById('tab-'+t).classList.add('text-slate-400'); });
    document.getElementById('sec-'+tab).classList.remove('hidden');
    document.getElementById('tab-'+tab).classList.add('tab-active');
    document.getElementById('tab-'+tab).classList.remove('text-slate-400');
}

/* LOGICA FAMILIA */
function loadData() {
    db.ref("familias/" + familyId).on("value", snap => {
        familyData = snap.val();
        if(!familyData) { show('familySetup'); return; }
        render();
        show('app');
        document.getElementById('loading').classList.add('hidden');
    });
}

function createFamily() {
    const name = familyName.value.trim(); if(!name) return;
    const fid = db.ref("familias").push().key;
    const invite = Math.random().toString(36).substring(2,8).toUpperCase();
    db.ref("familias/"+fid).set({
        name, inviteCode: invite, members: {[uid]:"owner"}, intervalo: 3,
        children: { [Date.now()]: { name: "Beb√© 1", logs: {}, meds: {}, foods: {}, weight: 0, birth: "" } }
    }).then(() => { familyId=fid; localStorage.setItem("familyId", fid); loadData(); });
}

function joinFamily() {
    const code = joinCode.value.trim().toUpperCase();
    db.ref("familias").orderByChild("inviteCode").equalTo(code).once("value", snap => {
        if(!snap.exists()) return alert("C√≥digo inv√°lido");
        const fid = Object.keys(snap.val())[0];
        familyId=fid; localStorage.setItem("familyId", fid);
        db.ref(`familias/${fid}/members/${uid}`).set("member");
        loadData();
    });
}

/* RENDER */
function render() {
    const keys = Object.keys(familyData.children || {});
    if(!keys.length) { show('familySetup'); return; }
    const c = familyData.children[keys[bIdx]];

    bebeSelector.innerHTML = keys.map((k,i)=>`<option value="${i}" ${i==bIdx?'selected':''}>${familyData.children[k].name.toUpperCase()}</option>`).join('');
    familyTitle.innerText = familyData.name + " ‚Ä¢ ID: " + familyData.inviteCode;
    valIntervalo.innerText = familyData.intervalo;

    // TIMER
    const proxima = (c.lastToma || 0) + (familyData.intervalo * 3600000);
    const diff = proxima - Date.now();
    const mins = Math.round(diff / 60000);
    if(mins > 0) {
        const h = Math.floor(mins/60), m = mins%60;
        timerDisplay.innerText = `${h}:${m<10?'0'+m:m}`;
        timerDisplay.className = "text-6xl font-black italic tracking-tighter text-white";
    } else {
        timerDisplay.innerText = "¬°YA!";
        timerDisplay.className = "text-6xl font-black italic tracking-tighter text-red-500 animate-pulse";
    }

    // LISTAS
    const logs = Object.values(c.logs || {}).sort((a,b)=>b.ts - a.ts);
    if(logs[0]) lastLogText.innerText = `√öLTIMO: ${logs[0].txt} (${logs[0].h})`;
    
    diarioList.innerHTML = logs.slice(0,10).map(l => `<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-50 flex justify-between items-center"><span class="font-bold text-xs text-slate-700">${l.txt}</span><span class="text-[9px] font-black text-slate-300 uppercase">${l.h}</span></div>`).join('');
    
    saludList.innerHTML = Object.values(c.meds || {}).sort((a,b)=>b.ts - a.ts).map(m => `<div class="bg-red-50 p-4 rounded-2xl flex justify-between items-center"><div class="text-[10px] font-black text-red-600 uppercase">${m.txt}<br><span class="text-[8px] font-normal">${m.h}</span></div><button onclick="delItem('meds','${m.ts}')" class="text-red-200"><i class="fa-solid fa-trash"></i></button></div>`).join('');
    
    foodList.innerHTML = Object.values(c.foods || {}).sort((a,b)=>b.ts - a.ts).map(f => `<div class="bg-green-50 p-4 rounded-2xl flex justify-between items-center"><div class="text-[10px] font-black text-green-700 uppercase">${f.txt}<br><span class="text-[8px] font-normal">${f.h}</span></div><button onclick="delItem('foods','${f.ts}')" class="text-green-200"><i class="fa-solid fa-trash"></i></button></div>`).join('');

    // COMPRA
    compraList.innerHTML = Object.values(familyData.compra || {}).map(i => `<div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center text-xs font-bold"><span>üõí ${i.txt}</span><button onclick="db.ref('familias/${familyId}/compra/${i.ts}').remove()" class="text-green-500"><i class="fa-solid fa-check"></i></button></div>`).join('');

    // CARGAR PERFIL EN MODAL
    editName.value = c.name;
    editBirth.value = c.birth || "";
    editPeso.value = c.weight || "";
}

/* ACCIONES */
function logQuick(txt, esToma=false) {
    const cid = Object.keys(familyData.children)[bIdx], ts = Date.now();
    const h = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    db.ref(`familias/${familyId}/children/${cid}/logs/${ts}`).set({txt, ts, h});
    if(esToma) db.ref(`familias/${familyId}/children/${cid}/lastToma`).set(ts);
}

function saveBibe() {
    const ml = document.getElementById('in-ml').value; if(!ml) return;
    logQuick(`üçº Biber√≥n ${ml}ml`, true); closeModal('modal-bibe');
}

function addSalud() {
    const txt = prompt("Nombre medicina y dosis:"); if(!txt) return;
    const cid = Object.keys(familyData.children)[bIdx], ts = Date.now();
    db.ref(`familias/${familyId}/children/${cid}/meds/${ts}`).set({txt, ts, h: new Date().toLocaleString()});
}

function addFood() {
    const txt = prompt("¬øQu√© ha probado hoy?"); if(!txt) return;
    const cid = Object.keys(familyData.children)[bIdx], ts = Date.now();
    db.ref(`familias/${familyId}/children/${cid}/foods/${ts}`).set({txt, ts, h: new Date().toLocaleDateString()});
}

function savePerfil() {
    const cid = Object.keys(familyData.children)[bIdx];
    db.ref(`familias/${familyId}/children/${cid}`).update({
        name: editName.value, birth: editBirth.value, weight: editPeso.value
    }).then(() => closeModal('modal-perfil'));
}

function addCompraItem() {
    const txt = prompt("¬øQu√© falta?"); if(!txt) return;
    const ts = Date.now(); db.ref(`familias/${familyId}/compra/${ts}`).set({txt, ts});
}

function addChild() {
    const name = prompt("Nombre del nuevo beb√©:"); if(!name) return;
    db.ref(`familias/${familyId}/children/${Date.now()}`).set({name, logs: {}, meds: {}, foods: {}, weight: 0});
}

function saveIntervalo() {
    const val = document.getElementById('in-intervalo').value;
    if(val) db.ref(`familias/${familyId}/intervalo`).set(parseFloat(val)).then(() => closeModal('modal-intervalo'));
}

function delItem(p, ts) {
    const cid = Object.keys(familyData.children)[bIdx];
    if(confirm("¬øEliminar?")) db.ref(`familias/${familyId}/children/${cid}/${p}/${ts}`).remove();
}

function deleteChild() {
    const cid = Object.keys(familyData.children)[bIdx];
    if(confirm("¬øBORRAR BEB√â POR COMPLETO?")) db.ref(`familias/${familyId}/children/${cid}`).remove().then(()=>closeModal('modal-perfil'));
}

function switchBebe(i) { bIdx = i; render(); }

// Reloj interno para el timer
setInterval(render, 30000);
</script>
</body>
</html>
