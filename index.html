<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V39.0 - Gestión Integral</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
body { font-family: 'Plus Jakarta Sans', sans-serif; background:#f8fafc; color:#1e293b; }
.hidden { display:none !important; }
.tab-active { color:#2563eb; border-bottom:3px solid #2563eb; }
.card-shadow { box-shadow:0 10px 25px -5px rgba(0,0,0,.05); }
</style>
</head>

<body class="pb-28">

<!-- LOADING -->
<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-[999]">
  <div class="text-blue-600 text-5xl font-black italic animate-bounce">EvaCare</div>
  <p class="text-[10px] font-bold text-slate-400 mt-4 tracking-[0.3em] uppercase">Sincronizando</p>
</div>

<!-- LOGIN -->
<div id="sec-login" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
  <h1 class="text-4xl font-black text-blue-600 italic mb-2">EvaCare</h1>
  <p class="text-slate-400 font-bold text-xs mb-8 uppercase tracking-widest">Gestión Familiar</p>
  <div class="space-y-3">
    <input id="log-email" type="email" class="w-full p-5 bg-white border rounded-2xl" placeholder="Email">
    <input id="log-pass" type="password" class="w-full p-5 bg-white border rounded-2xl" placeholder="Contraseña">
    <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black">ENTRAR</button>
    <button onclick="handleRegister()" class="w-full bg-slate-100 text-slate-500 p-5 rounded-2xl font-bold">CREAR CUENTA</button>
  </div>
</div>

<!-- FAMILIA -->
<div id="sec-family" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
  <div class="bg-white p-8 rounded-[3rem] border card-shadow text-center space-y-6">
    <h2 class="text-2xl font-black italic">Tu Familia</h2>
    <input id="fam-name" class="w-full p-4 bg-slate-50 rounded-xl text-center" placeholder="Apellidos Familia">
    <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">CREAR</button>
    <hr>
    <input id="fam-code" class="w-full p-4 bg-slate-50 rounded-xl text-center uppercase font-bold" placeholder="Código invitación">
    <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">UNIRSE</button>
  </div>
</div>

<!-- APP -->
<div id="sec-app" class="hidden p-4">
  <header class="flex justify-between items-center mb-4">
    <select id="bebeSelector" onchange="switchBebe(this.value)" class="text-2xl font-black text-blue-600 bg-transparent"></select>
    <button onclick="logout()" class="text-red-500 font-black">SALIR</button>
  </header>
  <div id="tab-diario" class="space-y-2"></div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
// FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  authDomain: "evacare-24cae.firebaseapp.com",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
});

const auth = firebase.auth();
const db = firebase.database();
firebase.database().ref().keepSynced(true);

// STATE
let uid=null, familyId=null, familyData=null, bIdx=0;

// AUTH FIX
auth.onAuthStateChanged(user=>{
  document.getElementById("loading").classList.add("hidden");
  if(user){
    uid=user.uid;
    db.ref(`usuarios/${uid}/familyId`).once("value").then(s=>{
      familyId=s.val();
      familyId ? loadApp() : show("sec-family");
    });
  } else show("sec-login");
});

// LOGIN
function handleLogin(){
  const e=log-email.value.trim(), p=log-pass.value.trim();
  if(!e||!p) return alert("Datos requeridos");
  auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err.message));
}
function handleRegister(){
  const e=log-email.value.trim(), p=log-pass.value.trim();
  if(!e||!p) return alert("Datos requeridos");
  auth.createUserWithEmailAndPassword(e,p).catch(err=>alert(err.message));
}

// LOAD APP
function loadApp(){
  db.ref("familias/"+familyId).on("value",s=>{
    familyData=s.val();
    if(!familyData.children){
      const n=prompt("Nombre del bebé");
      if(n) db.ref(`familias/${familyId}/children/${Date.now()}`).set({name:n});
      return;
    }
    render();
    show("sec-app");
  });
}

// RENDER
function render(){
  const keys=Object.keys(familyData.children);
  const b=familyData.children[keys[bIdx]];
  bebeSelector.innerHTML=keys.map((k,i)=>`<option value="${i}">${familyData.children[k].name}</option>`).join("");
  tab-diario.innerHTML=Object.values(b.logs||{}).sort((a,b)=>b.ts-a.ts).map(l=>`
    <div class="bg-white p-4 rounded-xl border">
      <b>${l.txt}</b>
      <div class="text-xs text-slate-400">${l.h}</div>
    </div>`).join("");
}

// FAMILY
function createFamily(){
  const n=fam-name.value.trim();
  if(!n) return;
  const fid=db.ref("familias").push().key;
  const code=Math.random().toString(36).substring(2,8).toUpperCase();
  db.ref("familias/"+fid).set({name:n,inviteCode:code}).then(()=>{
    db.ref(`usuarios/${uid}/familyId`).set(fid);
  });
}
function joinFamily(){
  const c=fam-code.value.trim().toUpperCase();
  db.ref("familias").orderByChild("inviteCode").equalTo(c).once("value",s=>{
    if(!s.exists()) return alert("Código inválido");
    db.ref(`usuarios/${uid}/familyId`).set(Object.keys(s.val())[0]);
  });
}

// HELPERS
function show(id){
  ["loading","sec-login","sec-family","sec-app"].forEach(s=>document.getElementById(s).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function switchBebe(i){bIdx=i;render();}
function logout(){auth.signOut().then(()=>location.reload());}
</script>

</body>
</html>
