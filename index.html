<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaCare</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
.hidden{display:none!important}
.tab-active{border-bottom:3px solid #2563eb;color:#2563eb}
</style>
</head>

<body class="bg-slate-50 pb-24">

<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
  <h1 class="text-4xl font-black italic text-blue-600 animate-pulse">EvaCare</h1>
  <p class="mt-3 text-xs tracking-widest uppercase text-slate-400">Iniciando sesi贸n...</p>
</div>

<section id="sec-login" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md space-y-4">
    <h2 class="text-4xl font-black italic text-blue-600 text-center mb-8">EvaCare</h2>
    <div class="space-y-2">
      <input id="log-email" type="email" placeholder="Email" class="w-full p-4 rounded-xl border border-slate-200 outline-blue-500">
      <input id="log-pass" type="password" placeholder="Contrase帽a" class="w-full p-4 rounded-xl border border-slate-200 outline-blue-500">
    </div>
    <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black shadow-lg active:scale-95 transition-transform">Entrar</button>
    <button onclick="register()" class="w-full bg-white text-slate-600 p-4 rounded-xl font-bold border border-slate-200">Crear cuenta</button>
  </div>
</section>

<section id="sec-family" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="bg-white p-8 rounded-3xl w-full max-w-md space-y-6 shadow-xl border border-slate-100">
    <div class="text-center">
        <h3 class="text-2xl font-black text-slate-800">隆Bienvenido!</h3>
        <p class="text-slate-500 text-sm">Configura tu entorno familiar</p>
    </div>
    
    <div class="space-y-3">
        <input id="fam-name" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100" placeholder="Nombre de familia">
        <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">Crear nueva familia</button>
    </div>

    <div class="flex items-center gap-4 text-slate-300">
        <hr class="flex-1"><span>o</span><hr class="flex-1">
    </div>

    <div class="space-y-3">
        <input id="fam-code" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 uppercase text-center font-bold tracking-widest" placeholder="C贸digo">
        <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">Unirme con c贸digo</button>
    </div>
  </div>
</section>

<section id="sec-app" class="hidden">
    <header class="bg-white p-4 flex justify-between items-center border-b sticky top-0 z-20 shadow-sm">
      <div class="flex items-center gap-2">
          <span class="text-xl"></span>
          <select id="bebeSelector" onchange="switchBebe(this.value)" class="font-black text-blue-600 bg-transparent outline-none text-lg"></select>
      </div>
      <button onclick="toggleMenu()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50"><i class="fa-solid fa-bars text-slate-600"></i></button>
    </header>

    <main class="p-4 space-y-6 max-w-lg mx-auto">
        <div class="grid grid-cols-4 gap-3">
          <button onclick="quickLog(' Pis')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-1 active:bg-blue-50">
            <span class="text-xl"></span><span class="text-[10px] font-bold uppercase">Pis</span>
          </button>
          <button onclick="quickLog(' Caca')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-1 active:bg-blue-50">
            <span class="text-xl"></span><span class="text-[10px] font-bold uppercase">Caca</span>
          </button>
          <button onclick="quickLog(' Ba帽o')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-1 active:bg-blue-50">
            <span class="text-xl"></span><span class="text-[10px] font-bold uppercase">Ba帽o</span>
          </button>
          <button onclick="quickLog(' Toma')" class="bg-blue-600 text-white p-4 rounded-2xl shadow-md flex flex-col items-center gap-1 active:opacity-90">
            <span class="text-xl"></span><span class="text-[10px] font-bold uppercase">Toma</span>
          </button>
        </div>

        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
          <div class="flex text-[11px] font-black uppercase bg-slate-50/50 border-b">
            <button id="btn-tab-diario" onclick="showTab('tab-diario')" class="flex-1 py-4 tab-active">Diario</button>
            <button id="btn-tab-salud" onclick="showTab('tab-salud')" class="flex-1 py-4">Salud</button>
            <button id="btn-tab-food" onclick="showTab('tab-food')" class="flex-1 py-4">Comida</button>
          </div>

          <div id="tab-diario" class="p-4 space-y-3 min-h-[300px]"></div>

          <div id="tab-salud" class="hidden p-4 space-y-4">
            <button onclick="addMed()" class="w-full bg-red-50 text-red-600 p-4 rounded-2xl border border-red-100 font-black text-sm">+ MEDICACIN</button>
            <div id="med-list" class="space-y-2"></div>
          </div>

          <div id="tab-food" class="hidden p-4 space-y-4">
            <button onclick="addFood()" class="w-full bg-orange-50 text-orange-600 p-4 rounded-2xl border border-orange-100 font-black text-sm">+ ALIMENTO</button>
            <div id="food-list" class="space-y-2"></div>
          </div>
        </div>
    </main>
</section>

<div id="side-menu" class="hidden fixed inset-0 z-40">
  <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="toggleMenu()"></div>
  <div class="absolute inset-y-0 left-0 bg-white w-4/5 max-w-xs p-8 flex flex-col shadow-2xl">
    <div class="flex-1 space-y-6">
        <h3 class="text-3xl font-black italic text-blue-600">EvaCare</h3>
        <button onclick="addChild()" class="w-full text-left py-3 px-4 rounded-xl bg-slate-50 font-bold text-slate-700"><i class="fa-solid fa-baby mr-3 text-blue-500"></i>A帽adir Beb茅</button>
        
        <div class="p-5 bg-blue-600 rounded-3xl text-white shadow-lg shadow-blue-200">
            <p class="text-[10px] uppercase font-black opacity-70 mb-1">C贸digo de Invitaci贸n</p>
            <p id="display-code" class="text-2xl font-mono font-black tracking-widest">------</p>
            <p class="text-[9px] mt-2 leading-tight opacity-80">Comparte este c贸digo para que otros familiares se unan.</p>
        </div>
    </div>
    
    <button onclick="logout()" class="w-full text-left p-4 text-red-500 font-black border-t border-slate-100"><i class="fa-solid fa-power-off mr-3"></i>Cerrar Sesi贸n</button>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  authDomain: "evacare-24cae.firebaseapp.com",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

let uid, familyId, familyData, bebeIndex = 0;

/* ---------- AUTH OBSERVER ---------- */
auth.onAuthStateChanged(user => {
  if (user) {
    uid = user.uid;
    checkUserFamily();
  } else {
    document.getElementById("loading").classList.add("hidden");
    show("sec-login");
  }
});

function checkUserFamily() {
  db.ref(`usuarios/${uid}/familyId`).once("value").then(s => {
    familyId = s.val();
    document.getElementById("loading").classList.add("hidden");
    if (familyId) {
      loadApp();
    } else {
      show("sec-family");
    }
  });
}

/* ---------- LOGIN / REG ---------- */
function login() {
  const email = document.getElementById("log-email").value.trim();
  const pass = document.getElementById("log-pass").value;
  if(!email || !pass) return alert("Rellena todos los campos");

  auth.signInWithEmailAndPassword(email, pass)
    .then(() => { /* El observador har谩 el resto */ })
    .catch(e => alert("Error al entrar: " + e.message));
}

function register() {
  const email = document.getElementById("log-email").value.trim();
  const pass = document.getElementById("log-pass").value;
  if(pass.length < 6) return alert("La contrase帽a debe tener 6+ caracteres");

  auth.createUserWithEmailAndPassword(email, pass)
    .then(() => { /* El observador har谩 el resto */ })
    .catch(e => alert("Error al registrar: " + e.message));
}

/* ---------- APP LOGIC ---------- */
function loadApp() {
  db.ref("familias/" + familyId).on("value", snap => {
    familyData = snap.val();
    if (!familyData) return show("sec-family");

    document.getElementById("display-code").innerText = familyData.inviteCode || "---";

    if (!familyData.children) {
      show("sec-app");
      if(confirm("No hay beb茅s. 驴A帽adir uno?")) addChild();
      return;
    }
    render();
    show("sec-app");
  });
}

function render() {
  const keys = Object.keys(familyData.children);
  const childKey = keys[bebeIndex];
  const child = familyData.children[childKey];

  const selector = document.getElementById("bebeSelector");
  selector.innerHTML = keys.map((k,i)=>`<option value="${i}" ${i==bebeIndex?'selected':''}>${familyData.children[k].name}</option>`).join("");

  const diarioDiv = document.getElementById("tab-diario");
  if(child.logs) {
    diarioDiv.innerHTML = Object.values(child.logs)
      .sort((a,b) => b.ts - a.ts)
      .map(l => `
        <div class="p-4 bg-white rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm">
          <span class="font-bold text-slate-700">${l.txt}</span>
          <span class="text-[10px] text-slate-400 font-black bg-slate-50 px-2 py-1 rounded-lg">${l.h}</span>
        </div>
      `).join("");
  } else {
    diarioDiv.innerHTML = `<div class="text-center py-12 text-slate-300"><i class="fa-solid fa-moon text-4xl mb-3"></i><p class="text-sm font-bold">Todo tranquilo por ahora</p></div>`;
  }

  document.getElementById("med-list").innerHTML = child.meds 
    ? Object.values(child.meds).map(m=>`<div class="p-4 bg-white rounded-2xl border border-slate-100"><b class="text-red-500">${m.nombre}</b><p class="text-xs text-slate-500">${m.dosis}</p></div>`).join("")
    : "";

  document.getElementById("food-list").innerHTML = child.foods 
    ? Object.values(child.foods).map(f=>`<div class="p-4 bg-white rounded-2xl border border-slate-100"><b>${f.nombre}</b> <span class="text-xs text-orange-500 font-bold">${f.reaccion||""}</span></div>`).join("")
    : "";
}

/* ---------- ACTIONS ---------- */
function quickLog(txt) {
  const keys = Object.keys(familyData.children);
  const cid = keys[bebeIndex];
  const ts = Date.now();
  db.ref(`familias/${familyId}/children/${cid}/logs/${ts}`).set({
    txt, ts,
    h: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
  });
}

function addChild() {
  const n = prompt("Nombre del beb茅:");
  if (n) db.ref(`familias/${familyId}/children`).push({name: n});
}

function addMed() {
  const n = prompt("Medicamento:");
  const d = prompt("Dosis:");
  if(n && d) {
    const cid = Object.keys(familyData.children)[bebeIndex];
    db.ref(`familias/${familyId}/children/${cid}/meds`).push({nombre: n, dosis: d});
  }
}

function addFood() {
  const n = prompt("Alimento:");
  const r = prompt("Reacci贸n (opcional):");
  if(n) {
    const cid = Object.keys(familyData.children)[bebeIndex];
    db.ref(`familias/${familyId}/children/${cid}/foods`).push({nombre: n, reaccion: r});
  }
}

/* ---------- FAMILY ---------- */
function createFamily() {
  const name = document.getElementById("fam-name").value.trim();
  if(!name) return alert("Ponle un nombre a tu familia");
  const fid = db.ref("familias").push().key;
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  db.ref("familias/"+fid).set({name, inviteCode: code})
    .then(() => db.ref(`usuarios/${uid}/familyId`).set(fid));
}

function joinFamily() {
  const code = document.getElementById("fam-code").value.toUpperCase().trim();
  db.ref("familias").orderByChild("inviteCode").equalTo(code).once("value", s => {
    if(!s.exists()) return alert("C贸digo no v谩lido");
    const fid = Object.keys(s.val())[0];
    db.ref(`usuarios/${uid}/familyId`).set(fid);
  });
}

/* ---------- UI ---------- */
function show(id) {
  document.getElementById("sec-login").classList.add("hidden");
  document.getElementById("sec-family").classList.add("hidden");
  document.getElementById("sec-app").classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

function showTab(id) {
  ["tab-diario","tab-salud","tab-food"].forEach(t => {
    document.getElementById(t).classList.add("hidden");
    document.getElementById("btn-"+t).classList.remove("tab-active");
  });
  document.getElementById(id).classList.remove("hidden");
  document.getElementById("btn-"+id).classList.add("tab-active");
}

function switchBebe(i) { bebeIndex = i; render(); }
function toggleMenu() { document.getElementById("side-menu").classList.toggle("hidden"); }
function logout() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
