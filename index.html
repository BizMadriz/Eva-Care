<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaCare</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
.hidden{display:none!important}
.tab-active{border-bottom:3px solid #2563eb;color:#2563eb}
</style>
</head>

<body class="bg-slate-50 pb-24">

<!-- ================= LOADING ================= -->
<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
  <h1 class="text-4xl font-black italic text-blue-600 animate-pulse">EvaCare</h1>
  <p class="mt-3 text-xs tracking-widest uppercase text-slate-400">Sincronizando</p>
</div>

<!-- ================= LOGIN ================= -->
<section id="sec-login" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md space-y-4">
    <h2 class="text-3xl font-black italic text-blue-600">EvaCare</h2>
    <input id="log-email" type="email" placeholder="Email" class="w-full p-4 rounded-xl border">
    <input id="log-pass" type="password" placeholder="Contrase帽a" class="w-full p-4 rounded-xl border">
    <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">Entrar</button>
    <button onclick="register()" class="w-full bg-slate-200 p-4 rounded-xl font-bold">Crear cuenta</button>
  </div>
</section>

<!-- ================= FAMILY ================= -->
<section id="sec-family" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="bg-white p-6 rounded-2xl w-full max-w-md space-y-4">
    <input id="fam-name" class="w-full p-4 rounded-xl bg-slate-100" placeholder="Nombre de familia">
    <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">Crear familia</button>
    <hr>
    <input id="fam-code" class="w-full p-4 rounded-xl bg-slate-100 uppercase" placeholder="C贸digo invitaci贸n">
    <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">Unirse</button>
  </div>
</section>

<!-- ================= APP ================= -->
<section id="sec-app" class="hidden">

<header class="bg-white p-4 flex justify-between items-center border-b">
  <select id="bebeSelector" onchange="switchBebe(this.value)" class="font-black text-blue-600"></select>
  <button onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
</header>

<main class="p-4 space-y-6">

<!-- QUICK LOG -->
<div class="grid grid-cols-4 gap-2">
  <button onclick="quickLog(' Pis')" class="bg-white p-4 rounded-xl">Pis</button>
  <button onclick="quickLog(' Caca')" class="bg-white p-4 rounded-xl">Caca</button>
  <button onclick="quickLog(' Ba帽o')" class="bg-white p-4 rounded-xl">Ba帽o</button>
  <button onclick="quickLog(' Toma')" class="bg-blue-600 text-white p-4 rounded-xl">Toma</button>
</div>

<!-- TABS -->
<div class="bg-white rounded-2xl border">
  <div class="flex text-xs font-black uppercase">
    <button id="btn-tab-diario" onclick="showTab('tab-diario')" class="flex-1 p-3 tab-active">Diario</button>
    <button id="btn-tab-salud" onclick="showTab('tab-salud')" class="flex-1 p-3">Salud</button>
    <button id="btn-tab-food" onclick="showTab('tab-food')" class="flex-1 p-3">Alimentos</button>
  </div>

  <div id="tab-diario" class="p-4 space-y-2"></div>

  <div id="tab-salud" class="hidden p-4 space-y-2">
    <button onclick="addMed()" class="w-full bg-red-100 p-3 rounded-xl">+ Medicaci贸n</button>
    <div id="med-list"></div>
  </div>

  <div id="tab-food" class="hidden p-4 space-y-2">
    <button onclick="addFood()" class="w-full bg-orange-100 p-3 rounded-xl">+ Alimento</button>
    <div id="food-list"></div>
  </div>
</div>

</main>
</section>

<!-- ================= MENU ================= -->
<div id="side-menu" class="hidden fixed inset-0 bg-black/40 z-40">
  <div class="bg-white w-3/4 h-full p-6 space-y-4">
    <button onclick="addChild()">+ A帽adir beb茅</button>
    <hr>
    <button onclick="logout()" class="text-red-500">Cerrar sesi贸n</button>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ---------- Firebase ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  authDomain: "evacare-24cae.firebaseapp.com",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
});
const auth = firebase.auth();
const db   = firebase.database();

/* ---------- State ---------- */
let uid, familyId, familyData, bebeIndex = 0;
let authResolved = false;

/* ---------- FAILSAFE ---------- */
setTimeout(() => {
  if (!authResolved) {
    hide("loading");
    show("sec-login");
  }
}, 3000);

/* ---------- AUTH ---------- */
auth.onAuthStateChanged(user => {
  authResolved = true;
  hide("loading");

  if (user) {
    uid = user.uid;
    db.ref(`usuarios/${uid}/familyId`).once("value").then(s => {
      familyId = s.val();
      familyId ? loadApp() : show("sec-family");
    });
  } else {
    show("sec-login");
  }
});

/* ---------- LOGIN (FIX DEFINITIVO) ---------- */
function login(){
  const email = document.getElementById("log-email").value;
  const pass  = document.getElementById("log-pass").value;
  auth.signInWithEmailAndPassword(email, pass).catch(e=>alert(e.message));
}
function register(){
  const email = document.getElementById("log-email").value;
  const pass  = document.getElementById("log-pass").value;
  auth.createUserWithEmailAndPassword(email, pass).catch(e=>alert(e.message));
}

/* ---------- APP ---------- */
function loadApp(){
  db.ref("familias/"+familyId).on("value", snap => {
    familyData = snap.val();
    if (!familyData.children) {
      addChild();
      return;
    }
    render();
    show("sec-app");
  });
}

function render(){
  const keys = Object.keys(familyData.children);
  const child = familyData.children[keys[bebeIndex]];

  bebeSelector.innerHTML = keys.map((k,i)=>`<option value="${i}">${familyData.children[k].name}</option>`).join("");

  tab-diario.innerHTML = Object.values(child.logs||{})
    .sort((a,b)=>b.ts-a.ts)
    .map(l=>`<div class="p-3 bg-white rounded-xl border">${l.txt}<div class="text-xs text-slate-400">${l.h}</div></div>`).join("");

  med-list.innerHTML = Object.values(child.meds||{})
    .map(m=>`<div class="p-3 bg-white rounded-xl border">${m.nombre} 路 ${m.dosis}</div>`).join("");

  food-list.innerHTML = Object.values(child.foods||{})
    .map(f=>`<div class="p-3 bg-white rounded-xl border">${f.nombre} ${f.reaccion||""}</div>`).join("");
}

/* ---------- ACTIONS ---------- */
function quickLog(txt){
  const cid = Object.keys(familyData.children)[bebeIndex];
  const ts = Date.now();
  db.ref(`familias/${familyId}/children/${cid}/logs/${ts}`).set({
    txt, ts,
    h: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
  });
}

function addChild(){
  const n = prompt("Nombre del beb茅");
  if (n) db.ref(`familias/${familyId}/children/${Date.now()}`).set({name:n});
}

function addMed(){
  const n = prompt("Medicamento");
  const d = prompt("Dosis");
  if(!n||!d) return;
  const cid = Object.keys(familyData.children)[bebeIndex];
  db.ref(`familias/${familyId}/children/${cid}/meds/${Date.now()}`).set({nombre:n,dosis:d});
}

function addFood(){
  const n = prompt("Alimento");
  const r = prompt("Reacci贸n (opcional)");
  if(!n) return;
  const cid = Object.keys(familyData.children)[bebeIndex];
  db.ref(`familias/${familyId}/children/${cid}/foods/${Date.now()}`).set({nombre:n,reaccion:r});
}

/* ---------- FAMILY ---------- */
function createFamily(){
  const name = fam-name.value.trim();
  const fid = db.ref("familias").push().key;
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  db.ref("familias/"+fid).set({name,inviteCode:code})
    .then(()=>db.ref(`usuarios/${uid}/familyId`).set(fid));
}

function joinFamily(){
  db.ref("familias").orderByChild("inviteCode").equalTo(fam-code.value.toUpperCase())
    .once("value", s=>{
      if(!s.exists()) return alert("C贸digo inv谩lido");
      db.ref(`usuarios/${uid}/familyId`).set(Object.keys(s.val())[0]);
    });
}

/* ---------- UI ---------- */
function show(id){
  ["sec-login","sec-family","sec-app"].forEach(hide);
  document.getElementById(id).classList.remove("hidden");
}
function hide(id){ document.getElementById(id).classList.add("hidden"); }
function showTab(id){
  ["tab-diario","tab-salud","tab-food"].forEach(t=>{
    document.getElementById(t).classList.add("hidden");
    document.getElementById("btn-"+t).classList.remove("tab-active");
  });
  document.getElementById(id).classList.remove("hidden");
  document.getElementById("btn-"+id).classList.add("tab-active");
}
function switchBebe(i){ bebeIndex=i; render(); }
function toggleMenu(){ document.getElementById("side-menu").classList.toggle("hidden"); }
function logout(){ auth.signOut().then(()=>location.reload()); }
</script>

</body>
</html>
