// Busca esta función en tu código y reemplázala por esta versión mejorada:

function finishCreate() {
    const id = document.getElementById('setup-family').value.trim();
    const n = document.getElementById('setup-n').value.trim();
    const f = document.getElementById('setup-f').value;
    
    if(!id || !n || !f) { 
        alert("Por favor, completa todos los campos."); 
        return; 
    }
    
    document.getElementById('loading-text').innerText = "Verificando disponibilidad...";
    openLoading();

    // Comprobamos si el ID ya existe antes de escribir
    db.ref('familias/' + id).once('value', (snapshot) => {
        if (snapshot.exists()) {
            hideLoading();
            alert("⚠️ El ID '" + id + "' ya existe. Por favor, elige uno diferente o usa la opción 'Unirse a familia'.");
        } else {
            // El ID está libre, procedemos a crear
            document.getElementById('loading-text').innerText = "Creando familia...";
            familyId = id;
            localStorage.setItem('EVA_CARE_FAMILY_ID', id);
            
            DATA = { 
                idx: 0, 
                plazo: 3, 
                bebes: [{ 
                    n, 
                    f, 
                    logs: [], 
                    meds: [], 
                    compra: [], 
                    citas: {}, 
                    foods: [] 
                }] 
            };
            
            db.ref('familias/' + id).set(DATA).then(() => {
                location.reload();
            }).catch((error) => {
                hideLoading();
                alert("Error al guardar en la nube: " + error.message);
            });
        }
    });
}
