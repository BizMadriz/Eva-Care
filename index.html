<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaCare</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
.hidden{display:none!important}
.tab-active{border-bottom:3px solid #2563eb;color:#2563eb}
</style>
</head>

<body class="bg-slate-50 pb-24">

<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
  <h1 class="text-4xl font-black italic text-blue-600 animate-pulse">EvaCare</h1>
  <p class="mt-3 text-xs tracking-widest uppercase text-slate-400">Sincronizando</p>
</div>

<section id="sec-login" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md space-y-4">
    <h2 class="text-3xl font-black italic text-blue-600">EvaCare</h2>
    <input id="log-email" type="email" placeholder="Email" class="w-full p-4 rounded-xl border">
    <input id="log-pass" type="password" placeholder="Contrase帽a" class="w-full p-4 rounded-xl border">
    <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">Entrar</button>
    <button onclick="register()" class="w-full bg-slate-200 p-4 rounded-xl font-bold">Crear cuenta</button>
  </div>
</section>

<section id="sec-family" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="bg-white p-6 rounded-2xl w-full max-w-md space-y-4 shadow-lg">
    <h3 class="font-bold text-lg">Configuraci贸n de Familia</h3>
    <input id="fam-name" class="w-full p-4 rounded-xl bg-slate-100" placeholder="Nombre de familia (Ej: Familia P茅rez)">
    <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">Crear familia</button>
    <div class="relative py-4">
        <div class="absolute inset-0 flex items-center"><span class="w-full border-t"></span></div>
        <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-slate-500">O 煤nete a una</span></div>
    </div>
    <input id="fam-code" class="w-full p-4 rounded-xl bg-slate-100 uppercase" placeholder="C贸digo invitaci贸n">
    <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">Unirse</button>
  </div>
</section>

<section id="sec-app" class="hidden">

<header class="bg-white p-4 flex justify-between items-center border-b sticky top-0 z-10">
  <select id="bebeSelector" onchange="switchBebe(this.value)" class="font-black text-blue-600 bg-transparent outline-none"></select>
  <button onclick="toggleMenu()" class="text-xl p-2"><i class="fa-solid fa-bars"></i></button>
</header>

<main class="p-4 space-y-6">

<div class="grid grid-cols-4 gap-2">
  <button onclick="quickLog(' Pis')" class="bg-white p-4 rounded-xl shadow-sm border text-sm font-bold">Pis</button>
  <button onclick="quickLog(' Caca')" class="bg-white p-4 rounded-xl shadow-sm border text-sm font-bold">Caca</button>
  <button onclick="quickLog(' Ba帽o')" class="bg-white p-4 rounded-xl shadow-sm border text-sm font-bold">Ba帽o</button>
  <button onclick="quickLog(' Toma')" class="bg-blue-600 text-white p-4 rounded-xl shadow-md text-sm font-black">Toma</button>
</div>

<div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
  <div class="flex text-xs font-black uppercase bg-slate-50 border-b">
    <button id="btn-tab-diario" onclick="showTab('tab-diario')" class="flex-1 p-4 tab-active">Diario</button>
    <button id="btn-tab-salud" onclick="showTab('tab-salud')" class="flex-1 p-4 border-l">Salud</button>
    <button id="btn-tab-food" onclick="showTab('tab-food')" class="flex-1 p-4 border-l">Comida</button>
  </div>

  <div id="tab-diario" class="p-4 space-y-3 min-h-[300px]"></div>

  <div id="tab-salud" class="hidden p-4 space-y-4">
    <button onclick="addMed()" class="w-full bg-red-50 text-red-600 p-4 rounded-xl border border-red-100 font-bold">+ Registrar Medicaci贸n</button>
    <div id="med-list" class="space-y-2"></div>
  </div>

  <div id="tab-food" class="hidden p-4 space-y-4">
    <button onclick="addFood()" class="w-full bg-orange-50 text-orange-600 p-4 rounded-xl border border-orange-100 font-bold">+ Registrar Alimento</button>
    <div id="food-list" class="space-y-2"></div>
  </div>
</div>

</main>
</section>

<div id="side-menu" class="hidden fixed inset-0 z-40">
  <div class="absolute inset-0 bg-black/50" onclick="toggleMenu()"></div>
  <div class="absolute inset-y-0 left-0 bg-white w-3/4 max-w-xs p-6 flex flex-col shadow-2xl">
    <h3 class="text-xl font-black italic text-blue-600 mb-6">EvaCare</h3>
    
    <div class="flex-1 space-y-4">
        <button onclick="addChild()" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 font-bold"><i class="fa-solid fa-plus mr-2 text-blue-500"></i>A帽adir beb茅</button>
        <div class="p-3 bg-blue-50 rounded-xl">
            <p class="text-[10px] uppercase font-black text-blue-400">C贸digo de Familia</p>
            <p id="display-code" class="text-lg font-mono font-black tracking-widest text-blue-700">-</p>
        </div>
    </div>
    
    <hr class="my-4">
    <button onclick="logout()" class="w-full text-left p-3 text-red-500 font-bold"><i class="fa-solid fa-right-from-bracket mr-2"></i>Cerrar sesi贸n</button>
  </div>
</div>

<script>
/* ---------- Firebase ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  authDomain: "evacare-24cae.firebaseapp.com",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
});
const auth = firebase.auth();
const db   = firebase.database();

/* ---------- State ---------- */
let uid, familyId, familyData, bebeIndex = 0;
let authResolved = false;

/* ---------- FAILSAFE ---------- */
setTimeout(() => {
  if (!authResolved) {
    hide("loading");
    show("sec-login");
  }
}, 3000);

/* ---------- AUTH ---------- */
auth.onAuthStateChanged(user => {
  authResolved = true;
  hide("loading");

  if (user) {
    uid = user.uid;
    db.ref(`usuarios/${uid}/familyId`).once("value").then(s => {
      familyId = s.val();
      familyId ? loadApp() : show("sec-family");
    });
  } else {
    show("sec-login");
  }
});

function login(){
  const email = document.getElementById("log-email").value;
  const pass  = document.getElementById("log-pass").value;
  if(!email || !pass) return alert("Introduce email y contrase帽a");
  auth.signInWithEmailAndPassword(email, pass).catch(e=>alert("Error: " + e.message));
}

function register(){
  const email = document.getElementById("log-email").value;
  const pass  = document.getElementById("log-pass").value;
  if(pass.length < 6) return alert("La contrase帽a debe tener al menos 6 caracteres");
  auth.createUserWithEmailAndPassword(email, pass).catch(e=>alert(e.message));
}

/* ---------- APP CORE ---------- */
function loadApp(){
  db.ref("familias/" + familyId).on("value", snap => {
    familyData = snap.val();
    if (!familyData) return show("sec-family");
    
    document.getElementById("display-code").innerText = familyData.inviteCode || "---";

    if (!familyData.children) {
      show("sec-app");
      addChild();
      return;
    }
    render();
    show("sec-app");
  });
}

function render(){
  const keys = Object.keys(familyData.children);
  const childKey = keys[bebeIndex];
  const child = familyData.children[childKey];

  // Selector de beb茅s
  const selector = document.getElementById("bebeSelector");
  selector.innerHTML = keys.map((k,i)=>`<option value="${i}" ${i==bebeIndex?'selected':''}> ${familyData.children[k].name}</option>`).join("");

  // Render Diario
  const diarioDiv = document.getElementById("tab-diario");
  if(child.logs){
    diarioDiv.innerHTML = Object.values(child.logs)
        .sort((a,b)=>b.ts-a.ts)
        .map(l=>`<div class="p-3 bg-white rounded-xl border flex justify-between items-center shadow-sm">
                    <span class="font-bold text-slate-700">${l.txt}</span>
                    <span class="text-xs text-slate-400 font-mono">${l.h}</span>
                 </div>`).join("");
  } else {
    diarioDiv.innerHTML = `<p class="text-center text-slate-400 py-10 italic">No hay actividad hoy</p>`;
  }

  // Render Salud
  document.getElementById("med-list").innerHTML = child.meds 
    ? Object.values(child.meds).map(m=>`<div class="p-3 bg-white rounded-xl border"><b>${m.nombre}</b> 路 ${m.dosis}</div>`).join("")
    : "";

  // Render Comida
  document.getElementById("food-list").innerHTML = child.foods 
    ? Object.values(child.foods).map(f=>`<div class="p-3 bg-white rounded-xl border"><b>${f.nombre}</b> ${f.reaccion ? `<span class="text-xs ml-2 bg-orange-100 p-1 rounded">Reacci贸n: ${f.reaccion}</span>` : ""}</div>`).join("")
    : "";
}

/* ---------- ACTIONS ---------- */
function quickLog(txt){
  const keys = Object.keys(familyData.children);
  const cid = keys[bebeIndex];
  const ts = Date.now();
  db.ref(`familias/${familyId}/children/${cid}/logs/${ts}`).set({
    txt, ts,
    h: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
  });
}

function addChild(){
  const n = prompt("Nombre del beb茅");
  if (n) db.ref(`familias/${familyId}/children`).push({name:n});
}

function addMed(){
  const n = prompt("Nombre del medicamento:");
  const d = prompt("Dosis (ej: 1.5 ml):");
  if(!n || !d) return;
  const cid = Object.keys(familyData.children)[bebeIndex];
  db.ref(`familias/${familyId}/children/${cid}/meds`).push({nombre:n, dosis:d});
}

function addFood(){
  const n = prompt("Alimento:");
  const r = prompt("Reacci贸n o notas (opcional):");
  if(!n) return;
  const cid = Object.keys(familyData.children)[bebeIndex];
  db.ref(`familias/${familyId}/children/${cid}/foods`).push({nombre:n, reaccion:r});
}

/* ---------- FAMILY MANAGEMENT ---------- */
function createFamily(){
  const name = document.getElementById("fam-name").value.trim();
  if(!name) return alert("Escribe un nombre para la familia");
  const fid = db.ref("familias").push().key;
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  db.ref("familias/"+fid).set({name, inviteCode:code})
    .then(()=>db.ref(`usuarios/${uid}/familyId`).set(fid));
}

function joinFamily(){
  const code = document.getElementById("fam-code").value.toUpperCase().trim();
  if(!code) return alert("Introduce un c贸digo");
  db.ref("familias").orderByChild("inviteCode").equalTo(code)
    .once("value", s=>{
      if(!s.exists()) return alert("C贸digo inv谩lido o familia no encontrada");
      const fid = Object.keys(s.val())[0];
      db.ref(`usuarios/${uid}/familyId`).set(fid);
    });
}

/* ---------- UI HELPERS ---------- */
function show(id){
  document.getElementById("sec-login").classList.add("hidden");
  document.getElementById("sec-family").classList.add("hidden");
  document.getElementById("sec-app").classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

function hide(id){ document.getElementById(id).classList.add("hidden"); }

function showTab(id){
  ["tab-diario","tab-salud","tab-food"].forEach(t=>{
    document.getElementById(t).classList.add("hidden");
    document.getElementById("btn-"+t).classList.remove("tab-active");
  });
  document.getElementById(id).classList.remove("hidden");
  document.getElementById("btn-"+id).classList.add("tab-active");
}

function switchBebe(i){ bebeIndex = i; render(); }

function toggleMenu(){ document.getElementById("side-menu").classList.toggle("hidden"); }

function logout(){ auth.signOut().then(()=>location.reload()); }
</script>

</body>
</html>
