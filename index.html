<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V25.0</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Firebase v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
body { font-family: 'Plus Jakarta Sans', sans-serif; }
.hidden { display: none !important; }
</style>
</head>

<body class="bg-slate-50 text-slate-900">

<!-- SETUP -->
<div id="setup-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-10 hidden">
  <h1 class="text-5xl font-black text-blue-600 italic mb-6">EvaCare</h1>
  <input id="family-id-input" placeholder="ID DE TU FAMILIA"
    class="w-full p-6 bg-slate-100 rounded-2xl font-black text-center uppercase mb-4">
  <button onclick="saveFamilyId()"
    class="w-full bg-blue-600 text-white p-6 rounded-2xl font-black">
    ENTRAR / CREAR
  </button>
</div>

<!-- LOADING -->
<div id="loading-screen" class="fixed inset-0 bg-white z-40 flex items-center justify-center hidden">
  <div class="text-blue-600 text-3xl font-black animate-bounce">Cargando...</div>
</div>

<!-- APP -->
<div id="app-content" class="hidden min-h-screen p-4 pb-32">

<header class="flex justify-between items-center mb-6">
  <select id="bebe-selector" onchange="switchBebe(this.value)"
    class="bg-transparent font-black italic text-2xl text-blue-600"></select>
  <button onclick="openModal('modal-menu')">
    <i class="fa-solid fa-bars text-xl text-slate-400"></i>
  </button>
</header>

<div id="panel-avisos-global" class="mb-6"></div>
<div id="diario-hoy" class="space-y-2"></div>

<div class="grid grid-cols-4 gap-3 mt-6">
  <button onclick="addLog('üí¶ Pis')" class="bg-white py-6 rounded-2xl font-black">PIS</button>
  <button onclick="addLog('üí© Caca')" class="bg-white py-6 rounded-2xl font-black">CACA</button>
  <button onclick="addLog('‚ú® Aseo')" class="bg-white py-6 rounded-2xl font-black">ASEO</button>
  <button onclick="addCompra()" class="bg-yellow-400 py-6 rounded-2xl font-black">üõí</button>
</div>

<button id="btn-repetir"
  onclick="repetirBibe()"
  class="hidden mt-6 bg-blue-600 text-white p-4 rounded-full font-black w-full">
</button>

</div>

<!-- MODAL BIBER√ìN -->
<div id="modal-bibe" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center">
  <div class="bg-white p-10 rounded-3xl w-full max-w-sm">
    <input id="in-ml" type="number" placeholder="ml"
      class="w-full p-6 bg-slate-100 rounded-2xl text-center text-4xl font-black mb-4">
    <button onclick="addBibe()" class="bg-blue-600 text-white p-4 rounded-2xl font-black w-full">
      Guardar
    </button>
    <button onclick="closeModal('modal-bibe')" class="mt-3 text-slate-400 w-full">
      Cancelar
    </button>
  </div>
</div>

<!-- MODAL MENU -->
<div id="modal-menu" class="hidden fixed inset-0 bg-black/80 flex justify-end">
  <div class="bg-white w-3/4 p-8">
    <button onclick="localStorage.clear();location.reload()"
      class="text-red-500 font-black mb-6">
      Cerrar sesi√≥n
    </button>
    <button onclick="closeModal('modal-menu')" class="block">
      Cerrar
    </button>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
const fbCfg = {
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
};

let DATA = null;
let familyId = localStorage.getItem('EVA_CARE_FAMILY_ID');
let bebeId = localStorage.getItem('EVA_CARE_BEBE_ID');
let db;

// ---------- SETUP ----------
function saveFamilyId() {
  const v = document.getElementById('family-id-input').value.trim().toUpperCase();
  if (!v) return alert("Introduce un ID");
  localStorage.setItem('EVA_CARE_FAMILY_ID', v);
  location.reload();
}

// ---------- START ----------
function startApp() {
  if (!familyId) {
    document.getElementById('setup-screen').classList.remove('hidden');
    return;
  }

  document.getElementById('loading-screen').classList.remove('hidden');

  if (!firebase.apps.length) {
    firebase.initializeApp(fbCfg);
  }
  db = firebase.database();

  db.ref('familias/' + familyId).on(
    'value',
    snap => {
      DATA = snap.val();

      if (!DATA) {
        const id = Date.now().toString();
        DATA = {
          intervalo: 3,
          compraFamiliar: {},
          bebes: {
            [id]: { n: "Mi Beb√©", logs: {}, lastToma: Date.now() }
          }
        };
        bebeId = id;
        localStorage.setItem('EVA_CARE_BEBE_ID', id);
        db.ref('familias/' + familyId).set(DATA);
      }

      if (!bebeId || !DATA.bebes[bebeId]) {
        bebeId = Object.keys(DATA.bebes)[0];
        localStorage.setItem('EVA_CARE_BEBE_ID', bebeId);
      }

      render();
      document.getElementById('loading-screen').classList.add('hidden');
      document.getElementById('app-content').classList.remove('hidden');
    },
    error => {
      console.error("Firebase error:", error);
      alert("Error de conexi√≥n con Firebase");
      document.getElementById('loading-screen').classList.add('hidden');
    }
  );
}

// ---------- SYNC ----------
function sync() {
  db.ref('familias/' + familyId).set(DATA);
}

// ---------- RENDER ----------
function render() {
  const selector = document.getElementById('bebe-selector');
  selector.innerHTML = Object.entries(DATA.bebes)
    .map(([id, b]) =>
      `<option value="${id}" ${id === bebeId ? 'selected' : ''}>${b.n.toUpperCase()}</option>`
    ).join('');

  const b = DATA.bebes[bebeId];
  const logs = Object.values(b.logs || {})
    .sort((a, b) => b.ts - a.ts)
    .slice(0, 10);

  document.getElementById('diario-hoy').innerHTML = logs.map(l => `
    <div class="bg-white p-4 rounded-xl shadow flex justify-between">
      <span>${l.txt}</span>
      <span class="text-xs text-slate-400">${l.h}</span>
    </div>
  `).join('');

  const btn = document.getElementById('btn-repetir');
  if (b.lastMl) {
    btn.innerText = `Repetir ${b.lastMl}ml`;
    btn.classList.remove('hidden');
  } else btn.classList.add('hidden');
}

// ---------- ACTIONS ----------
function addLog(txt, reset = false) {
  const ts = Date.now();
  const b = DATA.bebes[bebeId];
  b.logs[ts] = {
    txt,
    ts,
    h: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
  };
  if (reset) b.lastToma = ts;
  sync();
}

function addBibe() {
  const v = document.getElementById('in-ml').value;
  if (!v) return;
  addLog(`üçº Biber√≥n ${v}ml`, true);
  DATA.bebes[bebeId].lastMl = v;
  document.getElementById('in-ml').value = "";
  closeModal('modal-bibe');
}

function repetirBibe() {
  const b = DATA.bebes[bebeId];
  if (b.lastMl) addLog(`üçº Biber√≥n ${b.lastMl}ml`, true);
}

function addCompra() {
  const i = prompt("¬øQu√© falta?");
  if (!i) return;
  DATA.compraFamiliar[Date.now()] = { txt: i };
  sync();
}

function switchBebe(id) {
  bebeId = id;
  localStorage.setItem('EVA_CARE_BEBE_ID', id);
  render();
}

// ---------- MODALS ----------
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ---------- RUN ----------
startApp();
</script>

</body>
</html>
