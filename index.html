<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EvaCare V39.0 - Gesti√≥n Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; background: #f8fafc; color: #1e293b; }
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select { outline: none !important; }
        .tab-active { color: #2563eb; border-bottom: 3px solid #2563eb; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="pb-28">

<div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-[999]">
    <div class="text-blue-600 text-5xl font-black italic animate-bounce">EvaCare</div>
    <p class="text-[10px] font-bold text-slate-400 mt-4 tracking-[0.3em] uppercase">Sincronizando</p>
</div>

<div id="sec-login" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
    <h1 class="text-4xl font-black text-blue-600 italic mb-2">EvaCare</h1>
    <p class="text-slate-400 font-bold text-xs mb-8 uppercase tracking-widest">Gesti√≥n Familiar</p>
    <div class="space-y-3">
        <input id="log-email" type="email" class="w-full p-5 bg-white border rounded-2xl" placeholder="Email">
        <input id="log-pass" type="password" class="w-full p-5 bg-white border rounded-2xl" placeholder="Contrase√±a">
        <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black shadow-lg hover:bg-blue-700 transition-all">ENTRAR</button>
        <button onclick="handleRegister()" class="w-full bg-slate-100 text-slate-500 p-5 rounded-2xl font-bold">CREAR CUENTA</button>
    </div>
</div>

<div id="sec-family" class="hidden min-h-screen p-8 flex flex-col justify-center max-w-md mx-auto">
    <div class="bg-white p-8 rounded-[3rem] border card-shadow text-center space-y-6">
        <h2 class="text-2xl font-black italic">Tu Familia</h2>
        <div>
            <input id="fam-name" class="w-full p-4 bg-slate-50 rounded-xl mb-2 text-center" placeholder="Apellidos Familia (Ej: Garc√≠a)">
            <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">CREAR NUEVA</button>
        </div>
        <div class="flex items-center gap-4 text-slate-300"><hr class="flex-1"><span>O</span><hr class="flex-1"></div>
        <div>
            <input id="fam-code" class="w-full p-4 bg-slate-50 rounded-xl mb-2 text-center uppercase font-bold" placeholder="C√≥digo de invitaci√≥n">
            <button onclick="joinFamily()" class="w-full bg-green-500 text-white p-4 rounded-xl font-black">UNIRSE</button>
        </div>
    </div>
</div>

<div id="sec-app" class="hidden">
    <header class="p-6 bg-white/80 backdrop-blur-md flex justify-between items-center border-b sticky top-0 z-50">
        <div>
            <select id="bebeSelector" onchange="switchBebe(this.value)" class="text-2xl font-black text-blue-600 bg-transparent cursor-pointer"></select>
            <p id="sub-info" class="text-[9px] font-bold text-slate-400 mt-1 uppercase tracking-widest"></p>
        </div>
        <button onclick="toggleMenu()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600"><i class="fa-solid fa-bars"></i></button>
    </header>

    <main class="p-4 space-y-6">
        <section id="area-eventos">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-2">Pr√≥ximos 15 d√≠as</h3>
            <div id="visor-citas" class="flex gap-4 overflow-x-auto pb-2 no-scrollbar">
                </div>
        </section>

        <div class="grid grid-cols-4 gap-2">
            <button onclick="quickLog('üí¶ Pis')" class="bg-white p-4 rounded-2xl border flex flex-col items-center card-shadow"><i class="fa-solid fa-droplet text-cyan-500 mb-1"></i><span class="text-[8px] font-bold uppercase text-slate-400">Pis</span></button>
            <button onclick="quickLog('üí© Caca')" class="bg-white p-4 rounded-2xl border flex flex-col items-center card-shadow"><i class="fa-solid fa-poop text-orange-800 mb-1"></i><span class="text-[8px] font-bold uppercase text-slate-400">Caca</span></button>
            <button onclick="quickLog('‚ú® Ba√±o')" class="bg-white p-4 rounded-2xl border flex flex-col items-center card-shadow"><i class="fa-solid fa-bath text-blue-400 mb-1"></i><span class="text-[8px] font-bold uppercase text-slate-400">Ba√±o</span></button>
            <button onclick="openModal('modal-toma')" class="bg-blue-600 text-white p-4 rounded-2xl shadow-lg flex flex-col items-center"><i class="fa-solid fa-bottle-water mb-1"></i><span class="text-[8px] font-bold uppercase">Toma</span></button>
        </div>

        <div class="bg-white rounded-[2.5rem] border card-shadow overflow-hidden">
            <div class="flex border-b text-[10px] font-black uppercase tracking-tighter text-slate-400">
                <button onclick="showTab('tab-diario')" id="btn-tab-diario" class="flex-1 p-5 tab-active">Diario</button>
                <button onclick="showTab('tab-salud')" id="btn-tab-salud" class="flex-1 p-5">Salud</button>
                <button onclick="showTab('tab-food')" id="btn-tab-food" class="flex-1 p-5">Alimentos</button>
            </div>

            <div id="tab-diario" class="p-4 space-y-2 max-h-96 overflow-y-auto"></div>

            <div id="tab-salud" class="hidden p-5 space-y-4">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openModal('modal-med')" class="bg-red-50 text-red-600 p-4 rounded-2xl font-black text-[9px] uppercase tracking-widest">+ MEDICINA</button>
                    <button onclick="openModal('modal-cita')" class="bg-orange-50 text-orange-600 p-4 rounded-2xl font-black text-[9px] uppercase tracking-widest">+ CITA M√âDICA</button>
                </div>
                <button onclick="openModal('modal-peso')" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black text-[9px] uppercase tracking-widest">+ REGISTRAR PESO/ALTURA</button>
                <div id="med-list" class="space-y-2 pt-2"></div>
            </div>

            <div id="tab-food" class="hidden p-5 space-y-4">
                <button onclick="openModal('modal-food')" class="w-full bg-orange-500 text-white p-4 rounded-2xl font-black text-[10px] tracking-widest">+ PROBAR ALIMENTO</button>
                <div id="food-list" class="space-y-2"></div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-20 bg-white/90 backdrop-blur-md border border-white rounded-[2.5rem] shadow-2xl flex justify-around items-center px-4 z-[40]">
        <button onclick="showTab('tab-diario')" class="text-blue-600 text-xl"><i class="fa-solid fa-house"></i></button>
        <button onclick="openModal('modal-compra')" class="bg-blue-600 w-14 h-14 rounded-2xl text-white shadow-xl flex items-center justify-center -mt-10 border-4 border-slate-50"><i class="fa-solid fa-cart-shopping"></i></button>
        <button onclick="toggleMenu()" class="text-slate-300 text-xl"><i class="fa-solid fa-user-group"></i></button>
    </nav>
</div>

<div id="modal-med" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4">
        <h3 class="font-black text-xl italic">Nuevo Tratamiento</h3>
        <input id="m-nombre" class="w-full p-4 bg-slate-50 rounded-xl" placeholder="Nombre (Ej: Apiretal)">
        <div class="grid grid-cols-2 gap-2">
            <input id="m-dosis" class="p-4 bg-slate-50 rounded-xl" placeholder="Dosis (Ej: 1.5ml)">
            <input id="m-cada" type="number" class="p-4 bg-slate-50 rounded-xl" placeholder="Cada (horas)">
        </div>
        <input id="m-total" type="number" class="w-full p-4 bg-slate-50 rounded-xl" placeholder="D√≠as totales">
        <button onclick="saveMed()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black">GUARDAR</button>
        <button onclick="closeModal('modal-med')" class="w-full text-slate-400 font-bold text-xs uppercase">Cerrar</button>
    </div>
</div>

<div id="modal-cita" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4">
        <h3 class="font-black text-xl italic">Programar Cita</h3>
        <input id="c-titulo" class="w-full p-4 bg-slate-50 rounded-xl" placeholder="Motivo (Ej: Pediatra)">
        <input id="c-fecha" type="date" class="w-full p-4 bg-slate-50 rounded-xl">
        <button onclick="saveCita()" class="w-full bg-orange-500 text-white p-5 rounded-2xl font-black">AGENDAR</button>
        <button onclick="closeModal('modal-cita')" class="w-full text-slate-400 font-bold text-xs uppercase">Cerrar</button>
    </div>
</div>

<div id="modal-food" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 text-center">
        <h3 class="font-black text-xl">Nuevo Alimento</h3>
        <input id="f-nombre" class="w-full p-4 bg-slate-50 rounded-2xl text-center" placeholder="¬øQu√© ha probado?">
        <div class="flex justify-center gap-6 py-4">
            <button onclick="selReac('üòç')" class="text-4xl re-btn">üòç</button>
            <button onclick="selReac('üòê')" class="text-4xl re-btn opacity-30">üòê</button>
            <button onclick="selReac('ü§¢')" class="text-4xl re-btn opacity-30">ü§¢</button>
        </div>
        <label class="flex items-center justify-center gap-2 text-red-500 font-black text-xs uppercase">
            <input type="checkbox" id="f-alergia"> ¬øReacci√≥n al√©rgica?
        </label>
        <button onclick="saveFood()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black">REGISTRAR</button>
    </div>
</div>

<div id="modal-toma" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4">
        <h3 class="font-black text-xl italic text-center">Registrar Toma</h3>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="quickLog('ü§± Pecho Izq'); closeModal('modal-toma')" class="bg-pink-50 p-4 rounded-xl text-[10px] font-bold text-pink-600">PECHO IZQ</button>
            <button onclick="quickLog('ü§± Pecho Der'); closeModal('modal-toma')" class="bg-pink-50 p-4 rounded-xl text-[10px] font-bold text-pink-600">PECHO DER</button>
        </div>
        <input id="t-ml" type="number" class="w-full p-4 bg-slate-50 rounded-xl text-center" placeholder="ml de Biber√≥n (opcional)">
        <button onclick="if(document.getElementById('t-ml').value) quickLog('üçº Bibe '+document.getElementById('t-ml').value+'ml'); closeModal('modal-toma')" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">GUARDAR</button>
    </div>
</div>

<div id="side-menu" class="hidden fixed inset-0 bg-black/50 z-[500]">
    <div class="bg-white w-3/4 h-full p-8 space-y-6 flex flex-col">
        <h2 class="text-2xl font-black italic">Ajustes</h2>
        <button onclick="addChild()" class="text-left font-bold py-2"><i class="fa-solid fa-plus mr-3 text-blue-500"></i> A√±adir Beb√©/Ni√±o</button>
        <button onclick="alert('C√≥digo de invitaci√≥n: ' + familyData.inviteCode)" class="text-left font-bold py-2"><i class="fa-solid fa-user-plus mr-3 text-blue-500"></i> Invitar a Familia</button>
        <button onclick="leaveFamily()" class="text-left font-bold py-2 text-orange-500"><i class="fa-solid fa-right-from-bracket mr-3"></i> Abandonar Familia</button>
        <hr>
        <button onclick="logout()" class="text-left font-bold py-2 text-red-500"><i class="fa-solid fa-power-off mr-3"></i> Cerrar Sesi√≥n</button>
        <button onclick="toggleMenu()" class="mt-auto bg-slate-100 p-5 rounded-2xl font-black">CERRAR</button>
    </div>
</div>

<script>
// CONFIGURACI√ìN FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
    authDomain: "evacare-24cae.firebaseapp.com",
    databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "evacare-24cae"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let uid, familyId, familyData, bIdx = 0, currentReac = 'üòç';

// CONTROL DE ACCESO
auth.onAuthStateChanged(user => {
    if (user) {
        uid = user.uid;
        db.ref(`usuarios/${uid}/familyId`).on('value', snap => {
            familyId = snap.val();
            if (familyId) loadApp();
            else showSection("sec-family");
        });
    } else {
        showSection("sec-login");
    }
});

function handleLogin() {
    const e = document.getElementById('log-email').value;
    const p = document.getElementById('log-pass').value;
    auth.signInWithEmailAndPassword(e, p).catch(err => alert("Error: " + err.message));
}

function handleRegister() {
    const e = document.getElementById('log-email').value;
    const p = document.getElementById('log-pass').value;
    auth.createUserWithEmailAndPassword(e, p).catch(err => alert("Error: " + err.message));
}

function loadApp() {
    db.ref("familias/" + familyId).on("value", snap => {
        familyData = snap.val();
        if(!familyData) { showSection("sec-family"); return; }
        if(!familyData.children) {
            const n = prompt("No hay beb√©s registrados. Nombre del beb√©/ni√±o:");
            if(n) db.ref(`familias/${familyId}/children/${Date.now()}`).set({name: n});
        } else {
            render();
            showSection("sec-app");
        }
    });
}

function render() {
    const keys = Object.keys(familyData.children);
    const b = familyData.children[keys[bIdx]];
    
    // Header
    document.getElementById('bebeSelector').innerHTML = keys.map((k, i) => 
        `<option value="${i}" ${i==bIdx?'selected':''}>${familyData.children[k].name.toUpperCase()}</option>`
    ).join('');
    document.getElementById('sub-info').innerText = `${familyData.name} ‚Ä¢ C√ìDIGO: ${familyData.inviteCode}`;

    // Visor de Citas (15 d√≠as)
    const hoy = new Date();
    const limite = new Date(); limite.setDate(hoy.getDate() + 15);
    const citas = Object.values(b.citas || {}).filter(c => {
        const fc = new Date(c.fecha);
        return fc >= hoy.setHours(0,0,0,0) && fc <= limite;
    }).sort((a,b) => new Date(a.fecha) - new Date(b.fecha));

    document.getElementById('visor-citas').innerHTML = citas.map(c => `
        <div class="min-w-[150px] bg-white p-4 rounded-3xl border-l-4 border-orange-500 shadow-sm relative">
            <p class="text-[8px] font-black text-orange-500 uppercase mb-1">Cita M√©dica</p>
            <p class="font-bold text-slate-700 text-xs truncate">${c.titulo}</p>
            <p class="text-[9px] text-slate-400 mt-1">${c.fecha.split('-').reverse().join('/')}</p>
            <button onclick="deleteItem('citas', '${c.id}')" class="absolute top-2 right-2 text-slate-200"><i class="fa-solid fa-circle-xmark"></i></button>
        </div>
    `).join('') || '<p class="text-[10px] text-slate-300 font-bold p-4">Sin citas en los pr√≥ximos 15 d√≠as</p>';

    // Diario
    const logs = Object.values(b.logs || {}).sort((a,b)=>b.ts - a.ts);
    document.getElementById('tab-diario').innerHTML = logs.map(l => `
        <div class="bg-white p-4 rounded-2xl border flex justify-between items-center mb-2">
            <span class="font-bold text-slate-700 text-xs">${l.txt}</span>
            <span class="text-[9px] font-black text-slate-300 uppercase">${l.h}</span>
        </div>
    `).join('');

    // Salud
    const meds = Object.values(b.meds || {});
    document.getElementById('med-list').innerHTML = meds.map(m => `
        <div class="bg-white p-4 rounded-2xl border flex justify-between items-center mb-2">
            <div>
                <p class="font-black text-slate-700 text-xs uppercase">${m.nombre}</p>
                <p class="text-[9px] text-slate-400">${m.dosis} cada ${m.cada}h ‚Ä¢ ${m.total} d√≠as</p>
            </div>
            <button onclick="deleteItem('meds','${m.ts}')" class="text-red-200"><i class="fa-solid fa-trash"></i></button>
        </div>
    `).join('');

    // Alimentos
    const foods = Object.values(b.foods || {}).sort((a,b)=>b.ts - a.ts);
    document.getElementById('food-list').innerHTML = foods.map(f => `
        <div class="bg-white p-4 rounded-2xl border flex justify-between items-center ${f.alergia?'border-red-200 bg-red-50':''}">
            <div class="flex items-center gap-3">
                <span class="text-2xl">${f.reaccion}</span>
                <div>
                    <p class="font-bold text-slate-700 text-xs">${f.nombre}</p>
                    ${f.alergia ? '<span class="text-[8px] font-black text-red-500 uppercase tracking-tighter">Alergia / Reacci√≥n</span>' : ''}
                </div>
            </div>
            <button onclick="deleteItem('foods','${f.ts}')" class="text-slate-200"><i class="fa-solid fa-trash"></i></button>
        </div>
    `).join('');
}

// ACCIONES
function quickLog(txt) {
    const cid = Object.keys(familyData.children)[bIdx];
    const ts = Date.now();
    const h = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    db.ref(`familias/${familyId}/children/${cid}/logs/${ts}`).set({txt, ts, h});
}

function saveMed() {
    const cid = Object.keys(familyData.children)[bIdx];
    const ts = Date.now();
    const data = {
        nombre: document.getElementById('m-nombre').value,
        dosis: document.getElementById('m-dosis').value,
        cada: document.getElementById('m-cada').value,
        total: document.getElementById('m-total').value,
        ts
    };
    if(!data.nombre) return;
    db.ref(`familias/${familyId}/children/${cid}/meds/${ts}`).set(data);
    closeModal('modal-med');
}

function saveCita() {
    const cid = Object.keys(familyData.children)[bIdx];
    const id = Date.now();
    const data = {
        titulo: document.getElementById('c-titulo').value,
        fecha: document.getElementById('c-fecha').value,
        id
    };
    if(!data.titulo || !data.fecha) return;
    db.ref(`familias/${familyId}/children/${cid}/citas/${id}`).set(data);
    closeModal('modal-cita');
}

function selReac(r) {
    currentReac = r;
    document.querySelectorAll('.re-btn').forEach(b => {
        b.classList.add('opacity-30');
        if(b.innerText === r) b.classList.remove('opacity-30');
    });
}

function saveFood() {
    const cid = Object.keys(familyData.children)[bIdx];
    const ts = Date.now();
    const data = {
        nombre: document.getElementById('f-nombre').value,
        reaccion: currentReac,
        alergia: document.getElementById('f-alergia').checked,
        ts
    };
    if(!data.nombre) return;
    db.ref(`familias/${familyId}/children/${cid}/foods/${ts}`).set(data);
    closeModal('modal-food');
}

// GESTI√ìN FAMILIAR
function createFamily() {
    const name = document.getElementById('fam-name').value.trim();
    if(!name) return alert("Pon un nombre");
    const fid = db.ref("familias").push().key;
    const code = Math.random().toString(36).substring(2,8).toUpperCase();
    db.ref("familias/"+fid).set({ name, inviteCode: code, members: {[uid]: 'owner'} })
      .then(() => db.ref(`usuarios/${uid}/familyId`).set(fid));
}

function joinFamily() {
    const code = document.getElementById('fam-code').value.trim().toUpperCase();
    db.ref("familias").orderByChild("inviteCode").equalTo(code).once("value", snap => {
        if(!snap.exists()) return alert("C√≥digo no v√°lido");
        const fid = Object.keys(snap.val())[0];
        db.ref(`usuarios/${uid}/familyId`).set(fid);
    });
}

function addChild() {
    const n = prompt("Nombre del nuevo beb√©/ni√±o:");
    if(n) db.ref(`familias/${familyId}/children/${Date.now()}`).set({name: n});
}

function leaveFamily() {
    if(confirm("¬øAbandonar esta familia?")) {
        db.ref(`usuarios/${uid}/familyId`).remove().then(() => location.reload());
    }
}

// UI HELPERS
function showTab(id) {
    ["tab-diario", "tab-salud", "tab-food"].forEach(t => {
        document.getElementById(t).classList.add('hidden');
        document.getElementById('btn-'+t).classList.remove('tab-active');
    });
    document.getElementById(id).classList.remove('hidden');
    document.getElementById('btn-'+id).classList.add('tab-active');
}

function showSection(id) {
    ["loading", "sec-login", "sec-family", "sec-app"].forEach(s => document.getElementById(s).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function toggleMenu() { document.getElementById('side-menu').classList.toggle('hidden'); }
function switchBebe(i) { bIdx = i; render(); }
function logout() { auth.signOut().then(() => location.reload()); }
function deleteItem(p, ts) { 
    const cid = Object.keys(familyData.children)[bIdx]; 
    if(confirm("¬øEliminar este registro?")) db.ref(`familias/${familyId}/children/${cid}/${p}/${ts}`).remove(); 
}
</script>
</body>
</html>
