<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V31 - Gestión Completa</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
<style>
body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
.hidden { display: none !important; }
.input { @apply w-full p-4 rounded-2xl border border-slate-300 mb-4 outline-none; }
.btn { @apply w-full p-4 rounded-2xl font-black text-white text-center shadow-md mb-2; }
</style>
</head>
<body class="bg-slate-50 text-slate-900">

<!-- Pantalla de carga -->
<div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center">
    <div class="text-blue-600 text-4xl font-black italic animate-bounce mb-4">EvaCare</div>
    <div id="status-msg" class="text-slate-400 text-[10px] uppercase tracking-widest">Iniciando...</div>
</div>

<!-- Login/Registro -->
<div id="auth-screen" class="hidden p-10 max-w-md mx-auto mt-20 space-y-4">
    <h2 class="text-3xl font-black text-blue-600 text-center mb-6">EvaCare</h2>
    <input id="email-input" type="email" placeholder="Email" class="input">
    <input id="pass-input" type="password" placeholder="Contraseña" class="input">
    <button id="btn-login" class="btn bg-blue-600" onclick="loginUser()">Iniciar sesión</button>
    <button id="btn-register" class="btn bg-green-600" onclick="registerUser()">Crear cuenta</button>
    <button id="btn-reset" class="btn bg-orange-500" onclick="resetPassword()">Olvidé mi contraseña</button>
    <div id="auth-msg" class="text-red-500 text-sm text-center mt-2"></div>
</div>

<!-- App principal -->
<div id="app-content" class="hidden p-6 max-w-xl mx-auto space-y-6">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-black text-blue-600 italic" id="display-email">---</h1>
            <p class="text-slate-400 text-sm" id="family-id-display">---</p>
        </div>
        <button class="px-4 py-2 bg-red-500 text-white rounded-2xl font-bold" onclick="logoutUser()">Cerrar sesión</button>
    </header>

    <!-- Panel miembros -->
    <section class="bg-white p-6 rounded-2xl shadow-md space-y-4">
        <h2 class="text-lg font-black text-blue-600 mb-2">Miembros de la familia</h2>
        <div id="members-list" class="space-y-2"></div>
        <button class="btn bg-green-600" onclick="openMemberModal()">Añadir miembro</button>
    </section>

    <!-- Logs -->
    <section class="bg-white p-6 rounded-2xl shadow-md space-y-4">
        <h2 class="text-lg font-black text-blue-600 mb-2">Logs de la familia</h2>
        <button class="btn bg-blue-600" onclick="addTestLog()">Añadir log de prueba</button>
        <div id="log-list" class="space-y-2 mt-4"></div>
    </section>
</div>

<!-- Modal añadir/editar miembro -->
<div id="modal-member" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-6">
    <div class="bg-white w-full max-w-md p-6 rounded-3xl space-y-4 shadow-2xl">
        <h2 class="text-xl font-black text-blue-600" id="member-modal-title">Añadir miembro</h2>
        <input id="member-name" type="text" placeholder="Nombre" class="input">
        <input id="member-birth" type="date" placeholder="Fecha de nacimiento" class="input">
        <input id="member-weight" type="number" step="0.01" placeholder="Peso al nacer (kg)" class="input">
        <input id="member-height" type="number" placeholder="Altura al nacer (cm)" class="input">
        <div class="flex gap-2">
            <button class="btn bg-green-600 flex-1" id="member-save-btn">Guardar</button>
            <button class="btn bg-red-500 flex-1" onclick="closeMemberModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
const fbCfg = {
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  databaseURL: "https://evacare-24cae-default-rtdb.firebaseio.com",
  projectId: "evacare-24cae"
};
firebase.initializeApp(fbCfg);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let familyId = null;
let editingMemberKey = null;

// === INICIALIZAR APP ===
function init(){
  auth.onAuthStateChanged(user => {
    if(user){
      currentUser = user;
      familyId = btoa(user.email).replace(/=/g,'');
      showApp();
      loadMembers();
      loadLogs();
    } else {
      document.getElementById('loading-screen').classList.add('hidden');
      document.getElementById('auth-screen').classList.remove('hidden');
    }
  });
}

// === AUTH ===
function loginUser(){
  const email = document.getElementById('email-input').value.trim();
  const pass = document.getElementById('pass-input').value;
  auth.signInWithEmailAndPassword(email, pass)
    .catch(err => { document.getElementById('auth-msg').innerText = err.message; });
}

function registerUser(){
  const email = document.getElementById('email-input').value.trim();
  const pass = document.getElementById('pass-input').value;
  auth.createUserWithEmailAndPassword(email, pass)
    .then(()=> document.getElementById('auth-msg').innerText="Cuenta creada correctamente")
    .catch(err=> document.getElementById('auth-msg').innerText=err.message);
}

function resetPassword(){
  const email = document.getElementById('email-input').value.trim();
  if(!email){ document.getElementById('auth-msg').innerText="Introduce tu email"; return; }
  auth.sendPasswordResetEmail(email)
    .then(()=> document.getElementById('auth-msg').innerText="Email de recuperación enviado")
    .catch(err=> document.getElementById('auth-msg').innerText=err.message);
}

function logoutUser(){ auth.signOut().then(()=>window.location.reload()); }

// === APP PRINCIPAL ===
function showApp(){
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app-content').classList.remove('hidden');
  document.getElementById('display-email').innerText = currentUser.email;
  document.getElementById('family-id-display').innerText = "ID familia: "+familyId;
}

// === GESTIÓN MIEMBROS ===
function loadMembers(){
  const membersRef = db.ref('familias/'+familyId+'/members');
  membersRef.on('value', snap=>{
    const data = snap.val() || {};
    const list = Object.entries(data).map(([key, m])=>`
      <div class="bg-slate-50 p-4 rounded-2xl flex justify-between items-center border shadow-sm">
        <div>
          <p class="font-bold">${m.name}</p>
          <p class="text-[10px] text-slate-400">Nac: ${m.birth} | Peso: ${m.weight||'-'}kg | Altura: ${m.height||'-'}cm</p>
        </div>
        <div class="flex gap-2">
          <button class="bg-blue-500 text-white px-2 py-1 rounded" onclick="editMember('${key}')">Editar</button>
          <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteMember('${key}')">Eliminar</button>
        </div>
      </div>
    `).join('');
    document.getElementById('members-list').innerHTML = list || '<p class="text-slate-400 text-sm">No hay miembros</p>';
  });
}

function openMemberModal(){
  editingMemberKey = null;
  document.getElementById('member-modal-title').innerText = "Añadir miembro";
  document.getElementById('member-name').value='';
  document.getElementById('member-birth').value='';
  document.getElementById('member-weight').value='';
  document.getElementById('member-height').value='';
  document.getElementById('modal-member').classList.remove('hidden');
}

function closeMemberModal(){ document.getElementById('modal-member').classList.add('hidden'); }

document.getElementById('member-save-btn').onclick = function(){
  const name = document.getElementById('member-name').value.trim();
  const birth = document.getElementById('member-birth').value;
  const weight = document.getElementById('member-weight').value;
  const height = document.getElementById('member-height').value;
  if(!name || !birth){ alert("Nombre y fecha obligatorios"); return; }
  const membersRef = db.ref('familias/'+familyId+'/members');
  if(editingMemberKey){
    membersRef.child(editingMemberKey).set({name,birth,weight,height});
  } else {
    const newKey = membersRef.push().key;
    membersRef.child(newKey).set({name,birth,weight,height});
  }
  closeMemberModal();
}

function editMember(key){
  editingMemberKey = key;
  db.ref('familias/'+familyId+'/members/'+key).get().then(snap=>{
    const m = snap.val();
    document.getElementById('member-modal-title').innerText = "Editar miembro";
    document.getElementById('member-name').value = m.name;
    document.getElementById('member-birth').value = m.birth;
    document.getElementById('member-weight').value = m.weight || '';
    document.getElementById('member-height').value = m.height || '';
    document.getElementById('modal-member').classList.remove('hidden');
  });
}

function deleteMember(key){
  if(confirm("Eliminar miembro?")) db.ref('familias/'+familyId+'/members/'+key).remove();
}

// === LOGS ===
function loadLogs(){
  const logRef = db.ref('familias/'+familyId+'/logs');
  logRef.on('value', snap=>{
    const data = snap.val() || {};
    const list = Object.values(data).reverse().map(l=>`
      <div class="bg-white p-4 rounded-2xl shadow-sm border-b font-bold text-slate-600">
        ${l.txt} <span class="text-[9px] text-slate-300 ml-2">${l.h||''}</span>
      </div>
    `).join('');
    document.getElementById('log-list').innerHTML = list;
  });
}

function addTestLog(){
  const ts = Date.now();
  db.ref('familias/'+familyId+'/logs/'+ts).set({ txt:"Log de prueba ✅", h:new Date().toLocaleTimeString() });
}

init();
</script>

</body>
</html>
