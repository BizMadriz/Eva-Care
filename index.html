<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvaCare V37.0 - Gesti√≥n Integral</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; background: #f8fafc; }
    .hidden { display: none !important; }
    .neon-card { background: #1e293b; color: white; border-radius: 2.5rem; }
    .tab-btn.active { background: #2563eb; color: white; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .event-card { border-left: 4px solid #2563eb; }
    .event-med { border-left-color: #ef4444; }
    .event-cal { border-left-color: #f59e0b; }
</style>
</head>
<body class="pb-24">

<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-[999]">
    <div class="text-blue-600 text-4xl font-black animate-pulse italic">EvaCare</div>
</div>

<div id="app" class="hidden">
    <header class="p-6 bg-white sticky top-0 z-50 border-b flex justify-between items-center">
        <div>
            <select id="bebeSelector" onchange="switchBebe(this.value)" class="text-2xl font-black text-blue-600 bg-transparent outline-none"></select>
            <p id="familySub" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"></p>
        </div>
        <button onclick="openMenu()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center"><i class="fa-solid fa-bars"></i></button>
    </header>

    <main class="p-4 space-y-6">
        <section>
            <h2 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-3 px-2">L√≠nea de Tiempo y Citas</h2>
            <div id="visor-eventos" class="space-y-3">
                </div>
        </section>

        <div class="grid grid-cols-4 gap-2">
            <button onclick="quickLog('üí¶ Pis')" class="bg-white p-4 rounded-2xl shadow-sm border flex flex-col items-center gap-1"><i class="fa-solid fa-droplet text-cyan-500"></i><span class="text-[8px] font-bold">PIS</span></button>
            <button onclick="quickLog('üí© Caca')" class="bg-white p-4 rounded-2xl shadow-sm border flex flex-col items-center gap-1"><i class="fa-solid fa-poop text-orange-700"></i><span class="text-[8px] font-bold">CACA</span></button>
            <button onclick="quickLog('‚ú® Ba√±o')" class="bg-white p-4 rounded-2xl shadow-sm border flex flex-col items-center gap-1"><i class="fa-solid fa-bath text-blue-400"></i><span class="text-[8px] font-bold">BA√ëO</span></button>
            <button onclick="openModal('modal-alimentacion')" class="bg-blue-600 p-4 rounded-2xl shadow-lg flex flex-col items-center gap-1 text-white"><i class="fa-solid fa-utensils"></i><span class="text-[8px] font-bold">TOMA</span></button>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-sm border overflow-hidden">
            <div class="flex border-b">
                <button onclick="showTab('tab-med')" id="btn-tab-med" class="tab-btn flex-1 p-4 text-[10px] font-black uppercase active">M√©dico</button>
                <button onclick="showTab('tab-food')" id="btn-tab-food" class="tab-btn flex-1 p-4 text-[10px] font-black uppercase">Comida</button>
                <button onclick="showTab('tab-cal')" id="btn-tab-cal" class="tab-btn flex-1 p-4 text-[10px] font-black uppercase">Citas</button>
            </div>

            <div id="tab-med" class="p-5 space-y-4">
                <div class="flex gap-2">
                    <button onclick="openModal('modal-add-med')" class="flex-1 bg-red-50 text-red-600 p-3 rounded-xl font-bold text-[10px]">+ MEDICINA</button>
                    <button onclick="openModal('modal-peso')" class="flex-1 bg-green-50 text-green-600 p-3 rounded-xl font-bold text-[10px]">+ PESO/ALTURA</button>
                </div>
                <div id="lista-medica" class="space-y-2"></div>
            </div>

            <div id="tab-food" class="hidden p-5 space-y-4">
                <button onclick="openModal('modal-add-food')" class="w-full bg-orange-50 text-orange-600 p-3 rounded-xl font-bold text-[10px] tracking-widest">+ PROBAR ALIMENTO</button>
                <div id="lista-alimentos" class="space-y-2"></div>
            </div>

            <div id="tab-cal" class="hidden p-5 space-y-4">
                <button onclick="openModal('modal-add-cita')" class="w-full bg-blue-50 text-blue-600 p-3 rounded-xl font-bold text-[10px]">+ NUEVA CITA M√âDICA</button>
                <div id="lista-citas" class="space-y-2"></div>
            </div>
        </div>
    </main>

    <div id="side-menu" class="hidden fixed inset-0 bg-black/50 z-[100]">
        <div class="bg-white w-3/4 h-full p-8 space-y-6 flex flex-col">
            <h2 class="text-2xl font-black italic">Ajustes</h2>
            <button onclick="addChild()" class="text-left font-bold text-slate-600"><i class="fa-solid fa-baby mr-3"></i> A√±adir Beb√©/Ni√±o</button>
            <button onclick="editBebe()" class="text-left font-bold text-slate-600"><i class="fa-solid fa-pen-to-square mr-3"></i> Editar Datos Beb√©</button>
            <button onclick="shareFamily()" class="text-left font-bold text-blue-600"><i class="fa-solid fa-user-plus mr-3"></i> Invitar a Familia</button>
            <hr>
            <button onclick="logout()" class="text-left font-bold text-red-500"><i class="fa-solid fa-power-off mr-3"></i> Cerrar Sesi√≥n</button>
            <button onclick="closeMenu()" class="mt-auto bg-slate-100 p-4 rounded-2xl font-black">CERRAR</button>
        </div>
    </div>
</div>

<div id="modal-add-med" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4">
        <h3 class="font-black text-xl italic">Nuevo Tratamiento</h3>
        <input id="m-nombre" class="w-full p-4 bg-slate-50 rounded-xl" placeholder="Nombre (Ej: Apiretal)">
        <div class="grid grid-cols-2 gap-2">
            <input id="m-dosis" class="p-4 bg-slate-50 rounded-xl text-sm" placeholder="Dosis (Ej: 1.5ml)">
            <input id="m-cada" type="number" class="p-4 bg-slate-50 rounded-xl text-sm" placeholder="Cada (h)">
        </div>
        <input id="m-total" type="number" class="w-full p-4 bg-slate-50 rounded-xl text-sm" placeholder="D√≠as totales">
        <button onclick="saveMed()" class="w-full bg-red-500 text-white p-4 rounded-xl font-black">EMPEZAR</button>
        <button onclick="closeModal('modal-add-med')" class="w-full text-slate-400 text-xs font-bold">CANCELAR</button>
    </div>
</div>

<div id="modal-add-food" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 text-center">
        <h3 class="font-black text-xl italic">Registro Alimentario</h3>
        <input id="f-nombre" class="w-full p-4 bg-slate-50 rounded-xl text-center" placeholder="¬øQu√© ha probado?">
        <div class="flex justify-center gap-4 py-2">
            <button onclick="selReaccion('üòç')" class="text-3xl filter grayscale hover:grayscale-0 reac-btn">üòç</button>
            <button onclick="selReaccion('üòê')" class="text-3xl filter grayscale hover:grayscale-0 reac-btn">üòê</button>
            <button onclick="selReaccion('ü§¢')" class="text-3xl filter grayscale hover:grayscale-0 reac-btn">ü§¢</button>
        </div>
        <label class="flex items-center justify-center gap-2 text-red-500 font-bold">
            <input type="checkbox" id="f-alergia"> ¬øReacci√≥n al√©rgica?
        </label>
        <button onclick="saveFood()" class="w-full bg-orange-500 text-white p-4 rounded-xl font-black">REGISTRAR</button>
    </div>
</div>

<script>
/* FIREBASE CONFIG & AUTH (Igual que V36) */
// [Aqu√≠ va tu inicializaci√≥n de Firebase]

let bIdx = 0, currentReac = 'üòê';

/* SISTEMA DE VISOR DE EVENTOS (MEZCLA) */
function renderVisor() {
    const cid = Object.keys(familyData.children)[bIdx];
    const c = familyData.children[cid];
    const container = document.getElementById('visor-eventos');
    let events = [];

    // 1. Logs Recientes (√∫ltimas 24h)
    Object.values(c.logs || {}).forEach(l => {
        if(Date.now() - l.ts < 86400000) events.push({...l, type: 'log'});
    });

    // 2. Medicinas Activas (Calculando pr√≥xima dosis)
    Object.values(c.meds || {}).forEach(m => {
        events.push({...m, type: 'med', txt: `Pr√≥xima dosis: ${m.nombre} (${m.dosis})`});
    });

    // 3. Citas pr√≥ximos 15 d√≠as
    Object.values(c.citas || {}).forEach(cita => {
        const diff = new Date(cita.fecha) - Date.now();
        if(diff > 0 && diff < 15 * 86400000) {
            events.push({...cita, type: 'cal', txt: `CITA: ${cita.titulo}`, ts: new Date(cita.fecha).getTime()});
        }
    });

    events.sort((a,b) => b.ts - a.ts);

    container.innerHTML = events.map(e => `
        <div class="bg-white p-4 rounded-2xl shadow-sm border event-card ${e.type=='med'?'event-med':''} ${e.type=='cal'?'event-cal':''}">
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-black uppercase text-slate-400">${e.type=='cal' ? 'Calendario' : 'Evento'}</span>
                <span class="text-[10px] font-bold text-blue-500">${new Date(e.ts).toLocaleDateString([], {day:'2-digit', month:'short'})}</span>
            </div>
            <p class="font-bold text-slate-700 mt-1">${e.txt || e.nombre}</p>
        </div>
    `).join('');
}

/* M√âDICO: MEDICINAS */
function saveMed() {
    const cid = Object.keys(familyData.children)[bIdx];
    const data = {
        nombre: document.getElementById('m-nombre').value,
        dosis: document.getElementById('m-dosis').value,
        cada: document.getElementById('m-cada').value,
        totalDias: document.getElementById('m-total').value,
        inicioTs: Date.now(),
        ts: Date.now()
    };
    db.ref(`familias/${familyId}/children/${cid}/meds/${data.ts}`).set(data);
    closeModal('modal-add-med');
}

/* M√âDICO: PESO/ALTURA */
function savePeso() {
    // Registro de peso y altura con fecha
}

/* ALIMENTACI√ìN */
function selReaccion(r) { currentReac = r; }
function saveFood() {
    const cid = Object.keys(familyData.children)[bIdx];
    const data = {
        nombre: document.getElementById('f-nombre').value,
        reaccion: currentReac,
        alergia: document.getElementById('f-alergia').checked,
        ts: Date.now()
    };
    db.ref(`familias/${familyId}/children/${cid}/foods/${data.ts}`).set(data);
    closeModal('modal-add-food');
}

/* GESTI√ìN DE HIJOS (Al crear familia) */
function createFamily() {
    // ... l√≥gica anterior ...
    // Despu√©s de crear familia, forzar prompt:
    const babyName = prompt("¬°Familia creada! Nombre del primer beb√©/ni√±o:");
    // Guardar en Firebase...
}

/* MEN√ö Y AJUSTES */
function openMenu() { document.getElementById('side-menu').classList.remove('hidden'); }
function closeMenu() { document.getElementById('side-menu').classList.add('hidden'); }

function shareFamily() {
    prompt("Copia este c√≥digo para invitar a alguien:", familyData.inviteCode);
}

// ... Resto de funciones auxiliares ...
</script>
</body>
</html>
