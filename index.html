<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaCare V30 Full</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
.hidden { display: none !important; }
.reac-active { background: #dbeafe !important; border: 2px solid #2563eb !important; transform: scale(1.1); }
.aviso-item { border-left: 4px solid #3b82f6; padding: 6px 12px; margin-bottom: 8px; border-radius: 8px; background: rgba(255,255,255,0.08); }
.no-scrollbar::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="bg-slate-50 text-slate-900 pb-32">

<!-- LOGIN / REGISTER -->
<div id="login-screen" class="fixed inset-0 bg-white z-[10000] flex flex-col items-center justify-center p-10">
    <div class="text-blue-600 text-5xl font-black italic mb-4">EvaCare</div>
    <input id="email" type="email" placeholder="Email" class="w-full p-5 mb-4 rounded-xl border border-slate-200 outline-none">
    <input id="password" type="password" placeholder="Contrase√±a" class="w-full p-5 mb-4 rounded-xl border border-slate-200 outline-none">
    <button onclick="login()" class="w-full bg-blue-600 text-white p-5 rounded-xl font-black mb-3">Iniciar sesi√≥n</button>
    <button onclick="register()" class="w-full bg-green-600 text-white p-5 rounded-xl font-black">Crear cuenta</button>
</div>

<!-- APP -->
<div id="app-content" class="hidden">

<header class="p-6 flex justify-between items-center bg-white/80 sticky top-0 z-50 border-b backdrop-blur-md">
    <div class="flex flex-col">
        <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Viendo a:</span>
        <select id="bebe-selector" onchange="switchBebe(this.value)" class="bg-transparent font-black italic text-2xl outline-none text-blue-600 cursor-pointer"></select>
    </div>
    <button onclick="forceReset()" class="text-[10px] font-black text-red-400 bg-red-50 px-4 py-2 rounded-full">SALIR</button>
</header>

<main class="p-4 space-y-4">
    <!-- Avisos -->
    <div class="bg-slate-900 rounded-[2.5rem] p-7 text-white shadow-2xl">
        <h3 class="text-[9px] font-black text-blue-400 uppercase tracking-[0.2em] mb-4">Avisos de la Familia</h3>
        <div id="panel-avisos-global" class="space-y-3"></div>
    </div>

    <!-- Lista compra -->
    <div id="lista-compra-global" class="space-y-2"></div>

    <!-- Botones logs -->
    <div class="grid grid-cols-4 gap-3">
        <button onclick="addLog('üí¶ Pis')" class="bg-white py-6 rounded-[2rem] font-black text-cyan-600 text-[10px] border shadow-sm flex flex-col items-center gap-2"><i class="fa-solid fa-droplet text-lg"></i>PIS</button>
        <button onclick="addLog('üí© Caca')" class="bg-white py-6 rounded-[2rem] font-black text-orange-800 text-[10px] border shadow-sm flex flex-col items-center gap-2"><i class="fa-solid fa-poop text-lg"></i>CACA</button>
        <button onclick="addLog('‚ú® Aseo')" class="bg-white py-6 rounded-[2rem] font-black text-purple-600 text-[10px] border shadow-sm flex flex-col items-center gap-2"><i class="fa-solid fa-sparkles text-lg"></i>ASEO</button>
        <button onclick="addCompra()" class="bg-yellow-400 text-slate-900 rounded-[2rem] flex items-center justify-center shadow-lg text-xl"><i class="fa-solid fa-cart-shopping"></i></button>
    </div>

    <!-- Diario hoy -->
    <div id="diario-hoy" class="space-y-2 pb-10"></div>
</main>

</div>

<script>
const fbCfg = {
    apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
    authDomain: "evacare-24cae.firebaseapp.com",
    databaseURL: "https://evacare-24cae-default-rtdb.firebaseio.com",
    projectId: "evacare-24cae"
};
firebase.initializeApp(fbCfg);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let familyId = null;
let DATA = null;
let bIdx = 0;

// --- LOGIN / REGISTER ---
function register(){
    const e = document.getElementById('email').value.trim();
    const p = document.getElementById('password').value.trim();
    if(!e||!p) return alert("Completa email y contrase√±a");
    auth.createUserWithEmailAndPassword(e,p).then(cred=>{
        currentUser=cred.user;
        familyId='FAM_'+Math.random().toString(36).substr(2,6).toUpperCase();
        db.ref('users/'+currentUser.uid).set({email:currentUser.email,familyId});
        db.ref('familias/'+familyId).set({owner:currentUser.uid,members:{[currentUser.uid]:true},data:{intervalo:3,compraFamiliar:[],bebes:[{n:"Mi Beb√©",f:new Date().toISOString().split('T')[0],logs:[],meds:[],foods:[],citas:{},hPeso:[]}]}});
        document.getElementById('login-screen').classList.add('hidden');
        startApp();
    }).catch(err=>alert("Error crear cuenta: "+err.message));
}

function login(){
    const e=document.getElementById('email').value.trim();
    const p=document.getElementById('password').value.trim();
    if(!e||!p) return alert("Completa email y contrase√±a");
    auth.signInWithEmailAndPassword(e,p).then(cred=>{
        currentUser=cred.user;
        db.ref('users/'+currentUser.uid+'/familyId').once('value').then(snap=>{
            familyId=snap.val();
            document.getElementById('login-screen').classList.add('hidden');
            startApp();
        });
    }).catch(err=>alert("Error login: "+err.message));
}

function forceReset(){
    auth.signOut();
    localStorage.clear();
    window.location.reload();
}

// --- APP ---
function startApp(){
    if(!familyId) return;
    const famRef=db.ref('familias/'+familyId+'/data');
    famRef.on('value',snap=>{
        DATA=snap.val();
        document.getElementById('app-content').classList.remove('hidden');
        render();
    });
}

// --- RENDER ---
function render(){
    if(!DATA) return;
    const b=DATA.bebes[bIdx];
    document.getElementById('bebe-selector').innerHTML=DATA.bebes.map((x,i)=>`<option value="${i}" ${i===bIdx?'selected':''}>${x.n.toUpperCase()}</option>`).join('');

    // Avisos
    let htmlAvisos="";
    DATA.bebes.forEach(bebe=>{
        const rest=bebe.lastToma ? (bebe.lastToma+(DATA.intervalo*3600000))-Date.now() : -1;
        if(rest<=0) htmlAvisos+=`<div class="aviso-item"><span class="text-red-500 font-black">${bebe.n}:</span> <span class="text-[11px]">Toca toma</span></div>`;
    });
    document.getElementById('panel-avisos-global').innerHTML=htmlAvisos||'<p class="text-[10px] text-slate-500 italic">Todo en orden</p>';

    // Diario
    document.getElementById('diario-hoy').innerHTML=(b.logs||[]).slice(0,10).map(l=>`<div class="bg-white p-4 rounded-2xl flex justify-between items-center border-b shadow-sm"><span class="font-bold text-xs">${l.txt}</span><span class="text-[9px] font-black text-slate-300">${l.h}</span></div>`).join('');
}

// --- LOGS ---
function addLog(txt){
    const b=DATA.bebes[bIdx];
    if(!b.logs) b.logs=[];
    const entry={txt,h:new Date().toLocaleTimeString(),ts:Date.now()};
    b.logs.unshift(entry);
    DATA.bebes[bIdx]=b;
    db.ref('familias/'+familyId+'/data').set(DATA);
}

// --- LISTA COMPRA ---
function addCompra(){
    const item=prompt("A√±adir a la compra...");
    if(item){
        if(!DATA.compraFamiliar) DATA.compraFamiliar=[];
        DATA.compraFamiliar.push({txt:item,para:DATA.bebes[bIdx].n});
        db.ref('familias/'+familyId+'/data').set(DATA);
    }
}

// --- CAMBIO DE BEBE ---
function switchBebe(idx){ bIdx=parseInt(idx); render(); }
</script>
<script src="https://kit.fontawesome.com/a2e7e6da20.js" crossorigin="anonymous"></script>
</body>
</html>
