<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaCare V30.0 - Final Full</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
<style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background:#f1f5f9; }
    .hidden { display:none!important; }
    .rounded-card { border-radius: 1.5rem; }
    .shadow-card { box-shadow:0 4px 10px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
    <h1 class="text-4xl font-black text-blue-600 italic mb-4 animate-bounce">EvaCare</h1>
    <p class="text-sm text-gray-400">Iniciando...</p>
</div>

<!-- LOGIN -->
<div id="auth-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50 hidden p-6">
    <h1 class="text-3xl font-black text-blue-600 mb-4">EvaCare</h1>
    <input id="email-input" type="email" placeholder="Email" class="w-full p-4 mb-3 rounded-card border">
    <input id="pass-input" type="password" placeholder="Contraseña" class="w-full p-4 mb-3 rounded-card border">
    <button onclick="login()" class="w-full bg-blue-600 text-white p-4 mb-2 rounded-card font-bold">Acceder</button>
    <button onclick="signup()" class="w-full bg-gray-200 p-4 mb-2 rounded-card font-bold">Crear Cuenta</button>
    <p id="auth-msg" class="text-red-500 text-sm mt-2"></p>
</div>

<!-- APP -->
<div id="app-screen" class="hidden p-6">
    <header class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-black text-blue-600">EvaCare</h1>
        <button onclick="logout()" class="text-sm bg-red-50 px-3 py-1 rounded-card font-bold text-red-500">Cerrar sesión</button>
    </header>

    <!-- HIJOS -->
    <section class="mb-6">
        <h2 class="font-black text-gray-700 mb-2">Hijos / Usuarios</h2>
        <div id="child-list" class="space-y-3 mb-3"></div>
        <button onclick="showAddChildModal()" class="bg-green-500 text-white px-4 py-2 rounded-card font-bold">Añadir Hijo / Usuario</button>
    </section>

    <!-- LOGS -->
    <section>
        <h2 class="font-black text-gray-700 mb-2">Logs de Actividad</h2>
        <div id="logs" class="space-y-2"></div>
        <button onclick="addLogPrompt()" class="bg-blue-600 text-white px-4 py-2 rounded-card font-bold mt-2">Añadir Log</button>
    </section>
</div>

<!-- MODAL AÑADIR/EDITAR HIJO -->
<div id="child-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-6">
    <div class="bg-white p-6 rounded-card w-full max-w-md shadow-card">
        <h3 class="text-xl font-black mb-4">Añadir / Editar Hijo</h3>
        <input id="child-name" type="text" placeholder="Nombre" class="w-full p-3 mb-2 rounded-card border">
        <input id="child-dob" type="date" placeholder="Fecha de nacimiento" class="w-full p-3 mb-2 rounded-card border">
        <input id="child-weight" type="number" placeholder="Peso nacimiento (kg)" class="w-full p-3 mb-2 rounded-card border">
        <input id="child-height" type="number" placeholder="Altura nacimiento (cm)" class="w-full p-3 mb-2 rounded-card border">
        <div class="flex justify-end gap-2 mt-4">
            <button onclick="saveChild()" class="bg-blue-600 text-white px-4 py-2 rounded-card font-bold">Guardar</button>
            <button onclick="closeChildModal()" class="bg-gray-200 px-4 py-2 rounded-card font-bold">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const fbCfg = {
        apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
        authDomain: "evacare-24cae.firebaseapp.com",
        databaseURL: "https://evacare-24cae-default-rtdb.firebaseio.com",
        projectId: "evacare-24cae"
    };
    firebase.initializeApp(fbCfg);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let editingChildKey = null;

    // --- INIT ---
    auth.onAuthStateChanged(user=>{
        document.getElementById('loading-screen').classList.add('hidden');
        if(user){
            currentUser = user;
            showApp();
            loadChildren();
            loadLogs();
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
        }
    });

    // --- LOGIN / SIGNUP ---
    function login(){
        const email = document.getElementById('email-input').value;
        const pass = document.getElementById('pass-input').value;
        auth.signInWithEmailAndPassword(email,pass)
            .catch(err=>{document.getElementById('auth-msg').innerText = err.message;});
    }
    function signup(){
        const email = document.getElementById('email-input').value;
        const pass = document.getElementById('pass-input').value;
        auth.createUserWithEmailAndPassword(email,pass)
            .catch(err=>{document.getElementById('auth-msg').innerText = err.message;});
    }
    function logout(){ auth.signOut(); }

    // --- APP SCREEN ---
    function showApp(){
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
    }

    // --- CHILD MANAGEMENT ---
    function loadChildren(){
        const ref = db.ref(`users/${currentUser.uid}/children`);
        ref.on('value', snap=>{
            const data = snap.val() || {};
            const list = document.getElementById('child-list');
            list.innerHTML = '';
            Object.entries(data).forEach(([key,child])=>{
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white p-3 rounded-card shadow-card';
                div.innerHTML = `<div>
                    <p class="font-bold">${child.name}</p>
                    <p class="text-sm text-gray-500">Nacimiento: ${child.dob || '-'} | Peso: ${child.weight || '-'}kg | Altura: ${child.height || '-'}cm</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="editChild('${key}')" class="text-blue-600 font-bold">Editar</button>
                    <button onclick="deleteChild('${key}')" class="text-red-500 font-bold">Eliminar</button>
                </div>`;
                list.appendChild(div);
            });
        });
    }

    function showAddChildModal(){ editingChildKey=null; document.getElementById('child-name').value=''; document.getElementById('child-dob').value=''; document.getElementById('child-weight').value=''; document.getElementById('child-height').value=''; document.getElementById('child-modal').classList.remove('hidden'); }
    function closeChildModal(){ document.getElementById('child-modal').classList.add('hidden'); }

    function saveChild(){
        const name = document.getElementById('child-name').value;
        const dob = document.getElementById('child-dob').value;
        const weight = document.getElementById('child-weight').value;
        const height = document.getElementById('child-height').value;
        if(!name) return alert('Nombre requerido');

        const ref = db.ref(`users/${currentUser.uid}/children`);
        if(editingChildKey){
            ref.child(editingChildKey).set({name,dob,weight,height});
        } else {
            const key = ref.push().key;
            ref.child(key).set({name,dob,weight,height});
        }
        closeChildModal();
    }

    function editChild(key){
        editingChildKey = key;
        db.ref(`users/${currentUser.uid}/children/${key}`).once('value').then(snap=>{
            const child = snap.val();
            document.getElementById('child-name').value = child.name;
            document.getElementById('child-dob').value = child.dob || '';
            document.getElementById('child-weight').value = child.weight || '';
            document.getElementById('child-height').value = child.height || '';
            document.getElementById('child-modal').classList.remove('hidden');
        });
    }

    function deleteChild(key){
        if(confirm('¿Eliminar este usuario?')) db.ref(`users/${currentUser.uid}/children/${key}`).remove();
    }

    // --- LOGS ---
    function loadLogs(){
        const ref = db.ref(`users/${currentUser.uid}/logs`);
        ref.on('value', snap=>{
            const data = snap.val() || {};
            const list = document.getElementById('logs');
            list.innerHTML = '';
            Object.values(data).reverse().forEach(log=>{
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded-card shadow-card text-sm';
                div.textContent = `${log.txt} (${log.h || ''})`;
                list.appendChild(div);
            });
        });
    }

    function addLogPrompt(){
        const txt = prompt("Descripción del log:");
        if(!txt) return;
        const ref = db.ref(`users/${currentUser.uid}/logs`);
        const ts = Date.now();
        ref.child(ts).set({txt,h:new Date().toLocaleTimeString()});
    }
</script>
</body>
</html>
