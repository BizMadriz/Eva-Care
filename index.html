<!DOCTYPE html>  
<html lang="es">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>EvaCare V19.0 - Global</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">  
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>  
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');  
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }  
        .hidden { display: none !important; }  
        .reac-active { background: #dbeafe !important; border: 2px solid #2563eb !important; }
        .cal-day { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 0.8rem; cursor: pointer; font-size: 0.75rem; font-weight: 700; }
        .aviso-item { border-left: 3px solid #3b82f6; padding-left: 10px; margin-bottom: 8px; }
    </style>  
</head>  
<body class="bg-slate-50 text-slate-900 pb-28">

<div id="loading-screen" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center">
    <div class="text-blue-600 text-4xl font-black italic animate-bounce">EvaCare</div>
</div>

<div id="app-content" class="hidden">
    <header class="p-6 flex justify-between items-center bg-white/80 sticky top-0 z-40 border-b border-slate-100 backdrop-blur-md">
        <div class="flex flex-col">
            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Editando a:</span>
            <select id="bebe-selector" onchange="switchBebe(this.value)" class="bg-transparent font-black italic text-xl outline-none text-blue-600"></select>
        </div>
        <div id="sync-status"></div>
        <button onclick="openModal('modal-menu')" class="text-slate-400 text-xl"><i class="fa-solid fa-bars-staggered"></i></button>
    </header>

    <main id="tab-inicio" class="p-4 space-y-4">
        <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white shadow-xl min-h-[100px]">
            <h3 class="text-[8px] font-black text-blue-400 uppercase tracking-[0.2em] mb-3">Alertas Familiares</h3>
            <div id="panel-avisos-global" class="space-y-3">
                </div>
        </div>

        <div id="lista-compra-global" class="space-y-2"></div>

        <div class="grid grid-cols-4 gap-2">
            <button onclick="addLog('ðŸ’¦ Pis')" class="bg-white py-5 rounded-3xl font-black text-cyan-600 text-[10px] border shadow-sm">PIS</button>
            <button onclick="addLog('ðŸ’© Caca')" class="bg-white py-5 rounded-3xl font-black text-orange-800 text-[10px] border shadow-sm">CACA</button>
            <button onclick="addLog('âœ¨ Aseo')" class="bg-white py-5 rounded-3xl font-black text-purple-600 text-[10px] border shadow-sm">ASEO</button>
            <button onclick="addCompra()" class="bg-yellow-400 text-slate-900 rounded-3xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-cart-shopping"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="openModal('modal-pecho')" class="bg-white h-24 rounded-[2rem] border shadow-sm flex flex-col items-center justify-center">
                <i class="fa-solid fa-person-breastfeeding text-pink-500 mb-1 text-xl"></i>
                <span class="text-[9px] font-black uppercase">Pecho</span>
            </button>
            <div class="space-y-2">
                <button onclick="openModal('modal-bibe')" class="w-full bg-white h-16 rounded-3xl border shadow-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bottle-water text-blue-500"></i>
                    <span class="text-[9px] font-black uppercase">BiberÃ³n</span>
                </button>
                <button id="btn-repetir" onclick="repetirBibe()" class="w-full bg-blue-50 text-blue-600 h-8 rounded-full text-[8px] font-black uppercase hidden">Repetir Ãºltima</button>
            </div>
        </div>

        <div id="diario-hoy" class="space-y-2 pb-10"></div>
    </main>

    <main id="tab-nutricion" class="hidden p-4 space-y-4">
        <h2 class="text-2xl font-black italic text-orange-600 px-2">Alimentos</h2>
        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border space-y-4">
            <input id="food-input" type="text" placeholder="Â¿QuÃ© ha probado?" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none">
            <div class="flex justify-around">
                <button onclick="setReac('ðŸ˜‹', this)" class="reac-btn p-4 rounded-2xl text-2xl border-2 border-transparent">ðŸ˜‹</button>
                <button onclick="setReac('ðŸ¤¢', this)" class="reac-btn p-4 rounded-2xl text-2xl border-2 border-transparent">ðŸ¤¢</button>
                <button onclick="setReac('âš ï¸', this)" class="reac-btn p-3 rounded-2xl text-[9px] font-black border-2 border-transparent text-red-500">ALERGIA</button>
            </div>
            <button onclick="saveFood()" class="w-full bg-orange-500 text-white p-5 rounded-2xl font-black">REGISTRAR</button>
        </div>
        <div id="lista-alimentos" class="space-y-2 pb-20"></div>
    </main>

    <main id="tab-salud" class="hidden p-4 space-y-6">
        <h2 class="text-2xl font-black italic text-indigo-600 px-2">Salud</h2>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="openModal('modal-peso')" class="bg-white p-6 rounded-[2rem] border shadow-sm flex flex-col items-center">
                <i class="fa-solid fa-weight-scale text-indigo-500 mb-1 text-xl"></i>
                <span id="cur-peso" class="font-black text-lg">--.- kg</span>
            </button>
            <button onclick="openModal('modal-peso')" class="bg-white p-6 rounded-[2rem] border shadow-sm flex flex-col items-center">
                <i class="fa-solid fa-ruler-vertical text-indigo-500 mb-1 text-xl"></i>
                <span id="cur-altura" class="font-black text-lg">-- cm</span>
            </button>
        </div>
        <div id="historial-pesos" class="flex gap-2 overflow-x-auto pb-2"></div>
        <button onclick="openModal('modal-med')" class="w-full bg-indigo-600 text-white p-5 rounded-[2rem] font-black shadow-lg">NUEVA MEDICACIÃ“N</button>
        <div id="lista-meds" class="space-y-3"></div>
        <div id="lista-revs" class="bg-white rounded-[2rem] border divide-y overflow-hidden shadow-sm mb-20"></div>
    </main>

    <main id="tab-cal" class="hidden p-4 space-y-6">
        <h2 class="text-2xl font-black italic text-blue-600 px-2">Agenda</h2>
        <div class="bg-white p-5 rounded-[2rem] shadow-sm border">
            <div class="flex justify-between items-center mb-4 px-2">
                <button onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left text-slate-300"></i></button>
                <h3 id="cal-month" class="font-black uppercase text-xs">---</h3>
                <button onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right text-slate-300"></i></button>
            </div>
            <div id="cal-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
        <div id="agenda-lista" class="space-y-2 pb-20"></div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-16 bg-white/90 backdrop-blur-xl rounded-full border border-slate-100 shadow-2xl flex justify-around items-center z-50">  
        <button onclick="showTab('inicio')" id="nav-inicio" class="text-blue-600 p-4"><i class="fa-solid fa-house-chimney text-xl"></i></button>  
        <button onclick="showTab('nutricion')" id="nav-nutricion" class="text-slate-300 p-4"><i class="fa-solid fa-carrot text-xl"></i></button>  
        <button onclick="showTab('salud')" id="nav-salud" class="text-slate-300 p-4"><i class="fa-solid fa-suitcase-medical text-xl"></i></button>  
        <button onclick="showTab('cal')" id="nav-cal" class="text-slate-300 p-4"><i class="fa-solid fa-calendar-day text-xl"></i></button>  
    </nav>
</div>

<div id="modal-peso" class="hidden fixed inset-0 bg-black/80 z-[9500] flex items-center justify-center p-6"><div class="bg-white w-full rounded-[2.5rem] p-8 space-y-4"><input id="in-kg" type="number" step="0.01" placeholder="Peso (kg)" class="w-full p-4 bg-slate-50 rounded-xl font-bold"><input id="in-cm" type="number" placeholder="Altura (cm)" class="w-full p-4 bg-slate-50 rounded-xl font-bold"><button onclick="savePeso()" class="w-full bg-indigo-600 text-white p-5 rounded-xl font-black">GUARDAR</button><button onclick="closeModal('modal-peso')" class="w-full text-slate-300 font-bold text-xs uppercase">Cerrar</button></div></div>
<div id="modal-bibe" class="hidden fixed inset-0 bg-black/80 z-[9500] flex items-center justify-center p-6"><div class="bg-white w-full rounded-[2.5rem] p-8 space-y-4"><input id="in-ml" type="number" placeholder="ml" class="w-full p-6 bg-slate-100 rounded-3xl text-center text-4xl font-black outline-none"><button onclick="addBibe()" class="w-full bg-blue-600 text-white p-6 rounded-3xl font-black">GUARDAR</button><button onclick="closeModal('modal-bibe')" class="w-full text-slate-300 font-bold text-xs uppercase">Cerrar</button></div></div>
<div id="modal-pecho" class="hidden fixed inset-0 bg-black/80 z-[9500] flex items-end"><div class="bg-white w-full p-10 rounded-t-[3rem] grid grid-cols-3 gap-4 shadow-2xl"><button onclick="addLog('ðŸ¤± Pecho Izq', true); closeModal('modal-pecho')" class="bg-pink-50 p-6 rounded-2xl font-black text-pink-600 text-xs">IZQ</button><button onclick="addLog('ðŸ¤± Pecho Ambos', true); closeModal('modal-pecho')" class="bg-pink-600 p-6 rounded-2xl font-black text-white text-xs">AMBOS</button><button onclick="addLog('ðŸ¤± Pecho Der', true); closeModal('modal-pecho')" class="bg-pink-50 p-6 rounded-2xl font-black text-pink-600 text-xs">DER</button></div></div>
<div id="modal-med" class="hidden fixed inset-0 bg-black/80 z-[9500] flex items-center justify-center p-6"><div class="bg-white w-full rounded-[2.5rem] p-8 space-y-4"><input id="m-name" type="text" placeholder="Medicamento" class="w-full p-4 bg-slate-50 rounded-xl font-bold"><input id="m-dose" type="text" placeholder="Dosis (2.5ml)" class="w-full p-4 bg-slate-50 rounded-xl font-bold"><div class="grid grid-cols-2 gap-2"><input id="m-gap" type="number" placeholder="Horas" class="w-full p-4 bg-slate-50 rounded-xl font-bold"><input id="m-days" type="number" placeholder="DÃ­as" class="w-full p-4 bg-slate-50 rounded-xl font-bold"></div><button onclick="saveMed()" class="w-full bg-indigo-600 text-white p-5 rounded-xl font-black">GUARDAR</button><button onclick="closeModal('modal-med')" class="w-full text-slate-300 font-bold text-xs uppercase">Cerrar</button></div></div>
<div id="modal-cal" class="hidden fixed inset-0 bg-black/80 z-[9500] flex items-center justify-center p-6"><div class="bg-white w-full rounded-[2.5rem] p-8 space-y-4"><input id="c-txt" type="text" placeholder="Evento" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none"><input id="c-time" type="time" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none"><button onclick="saveCita()" class="w-full bg-slate-900 text-white p-5 rounded-xl font-black uppercase text-xs">Guardar</button><button onclick="closeModal('modal-cal')" class="w-full text-slate-300 font-bold text-xs uppercase">Cancelar</button></div></div>
<div id="modal-menu" class="hidden fixed inset-0 bg-black/80 z-[9500] flex justify-end">
    <div class="bg-white w-4/5 h-full p-8 flex flex-col shadow-2xl">
        <h2 class="text-3xl font-black italic mb-8">Ajustes</h2>
        <div class="space-y-6 flex-1 overflow-y-auto">
            <div class="bg-slate-50 p-5 rounded-3xl"><label class="text-[9px] font-black uppercase text-blue-600">Intervalo Tomas (Horas)</label><input type="number" id="cfg-int" class="w-full p-3 bg-white rounded-xl mt-2 font-bold" onchange="updateCfg()"></div>
            <div class="bg-slate-50 p-5 rounded-3xl"><label class="text-[9px] font-black uppercase text-blue-600">AÃ±adir NiÃ±o/PlanificaciÃ³n</label>
                <input type="text" id="new-n" placeholder="Nombre" class="w-full p-3 bg-white rounded-xl mt-2 font-bold">
                <input type="date" id="new-f" class="w-full p-3 bg-white rounded-xl mt-2 font-bold">
                <button onclick="addNewBebe()" class="w-full bg-blue-600 text-white p-4 rounded-xl mt-3 font-black text-[10px]">AÃ‘ADIR</button>
            </div>
            <button onclick="localStorage.clear();location.reload()" class="w-full text-red-500 font-bold text-[10px] uppercase p-4 rounded-2xl bg-red-50">Cerrar SesiÃ³n</button>
        </div>
        <button onclick="closeModal('modal-menu')" class="mt-4 p-4 text-slate-300 font-black">VOLVER</button>
    </div>
</div>

<script>
    const fbCfg = { apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I", databaseURL: "https://evacare-24cae-default-rtdb.firebaseio.com", projectId: "evacare-24cae" };
    firebase.initializeApp(fbCfg); const db = firebase.database();

    let DATA = null, familyId = localStorage.getItem('EVA_CARE_FAMILY_ID'), bIdx = parseInt(localStorage.getItem('EVA_CARE_BEBE_IDX') || 0);
    let curMonth = new Date(), selDate = new Date().toISOString().split('T')[0], curReac = "";

    const REVS = [{e:"7 DÃ­as",c:"PediatrÃ­a"},{e:"15 DÃ­as",c:"PediatrÃ­a"},{e:"1 Mes",c:"Enf"},{e:"2 Meses",c:"Enf+Ped",v:true},{e:"4 Meses",c:"Enf",v:true},{e:"6 Meses",c:"Enf+Ped"},{e:"11 Meses",c:"Vac",v:true},{e:"12 Meses",c:"Enf+Ped",v:true},{e:"15 Meses",c:"Enf",v:true},{e:"2 AÃ±os",c:"Enf"},{e:"6 AÃ±os",c:"Enf+Ped",v:true}];

    function init() {
        if(!familyId) { familyId = prompt("ID Familia:"); if(familyId) { localStorage.setItem('EVA_CARE_FAMILY_ID', familyId); location.reload(); } return; }
        db.ref('familias/' + familyId).on('value', snap => {
            DATA = snap.val(); if(!DATA) { DATA = { intervalo:3, bebes:[{n:"BebÃ©",f:new Date().toISOString().split('T')[0]}] }; sync(); }
            render(); document.getElementById('loading-screen').classList.add('hidden'); document.getElementById('app-content').classList.remove('hidden');
        });
    }

    function sync() { 
        document.getElementById('sync-status').innerHTML = '<i class="fa-solid fa-cloud-arrow-up text-blue-500 animate-pulse"></i>';
        db.ref('familias/' + familyId).set(DATA).then(() => {
            document.getElementById('sync-status').innerHTML = '<i class="fa-solid fa-cloud-check text-green-500"></i>';
        });
    }

    // ACCIONES
    function addLog(txt, resets = false) {
        const b = DATA.bebes[bIdx]; if(!b.logs) b.logs = [];
        const entry = { txt, h: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}), ts: Date.now() };
        b.logs.unshift(entry);
        if(resets) b.lastToma = entry.ts;
        if(txt.includes('BiberÃ³n')) b.lastMl = txt.split('ml')[0].split(' ').pop();
        sync();
    }

    function addBibe() { const ml = document.getElementById('in-ml').value; if(ml){ addLog(`ðŸ¼ BiberÃ³n ${ml}ml`, true); closeModal('modal-bibe'); document.getElementById('in-ml').value=""; } }
    function repetirBibe() { if(DATA.bebes[bIdx].lastMl) addLog(`ðŸ¼ BiberÃ³n ${DATA.bebes[bIdx].lastMl}ml`, true); }
    
    function addCompra() { 
        const item = prompt("Necesito comprar..."); 
        if(item){ 
            if(!DATA.compraFamiliar) DATA.compraFamiliar = [];
            // AÃ±adimos quiÃ©n lo necesita para claridad global
            DATA.compraFamiliar.push({txt: item, para: DATA.bebes[bIdx].n}); 
            sync(); 
        } 
    }

    function savePeso() { 
        const b = DATA.bebes[bIdx], kg = document.getElementById('in-kg').value, cm = document.getElementById('in-cm').value;
        if(kg||cm){ if(!b.hPeso) b.hPeso = []; b.hPeso.unshift({kg,cm,f:new Date().toLocaleDateString()}); b.peso=kg||b.peso; b.altura=cm||b.altura; closeModal('modal-peso'); sync(); }
    }

    function saveFood() {
        const n = document.getElementById('food-input').value; if(!n) return;
        if(!DATA.bebes[bIdx].foods) DATA.bebes[bIdx].foods = [];
        DATA.bebes[bIdx].foods.push({n, r:curReac||'â“'}); document.getElementById('food-input').value=""; curReac=""; 
        document.querySelectorAll('.reac-btn').forEach(x=>x.classList.remove('reac-active')); sync();
    }

    function saveMed() {
        const n = document.getElementById('m-name').value, g = document.getElementById('m-gap').value;
        if(n&&g){ if(!DATA.bebes[bIdx].meds) DATA.bebes[bIdx].meds = []; DATA.bebes[bIdx].meds.push({n, d:document.getElementById('m-dose').value, g, p:document.getElementById('m-days').value, ts:Date.now()}); closeModal('modal-med'); sync(); }
    }

    function saveCita() {
        const t = document.getElementById('c-txt').value; if(!t) return;
        if(!DATA.bebes[bIdx].citas) DATA.bebes[bIdx].citas = {}; if(!DATA.bebes[bIdx].citas[selDate]) DATA.bebes[bIdx].citas[selDate] = [];
        DATA.bebes[bIdx].citas[selDate].push({t, h:document.getElementById('c-time').value}); closeModal('modal-cal'); sync();
    }

    // RENDERIZADO LÃ“GICO
    function render() {
        const bActivo = DATA.bebes[bIdx];
        document.getElementById('bebe-selector').innerHTML = DATA.bebes.map((x,i)=>`<option value="${i}" ${i===bIdx?'selected':''}>${x.n.toUpperCase()}</option>`).join('');
        
        // --- 1. PANEL DE AVISOS GLOBAL ---
        let htmlAvisos = "";
        const hoyStr = new Date().toISOString().split('T')[0];
        
        DATA.bebes.forEach(bebe => {
            // Tomas
            const intMs = (DATA.intervalo || 3) * 3600000;
            const rest = bebe.lastToma ? (bebe.lastToma + intMs) - Date.now() : -1;
            if(rest <= 0) {
                htmlAvisos += `<div class="aviso-item"><span class="text-red-500 font-black">${bebe.n}:</span> <span class="text-xs">Â¡Toca toma ya!</span></div>`;
            } else {
                const h = Math.floor(rest/3600000), m = Math.floor((rest%3600000)/60000);
                htmlAvisos += `<div class="aviso-item"><span class="text-blue-400 font-black">${bebe.n}:</span> <span class="text-xs">Toma en ${h}h ${m}m</span></div>`;
            }
            // Medicinas (solo si existen)
            (bebe.meds || []).forEach(m => {
                htmlAvisos += `<div class="aviso-item" style="border-left-color: #a855f7"><span class="text-purple-400 font-black">${bebe.n}:</span> <span class="text-xs">${m.n} (${m.d})</span></div>`;
            });
            // Citas prÃ³ximas (15 dÃ­as)
            const citas = bebe.citas || {};
            Object.keys(citas).forEach(fecha => {
                if(fecha >= hoyStr) {
                    citas[fecha].forEach(c => {
                        htmlAvisos += `<div class="aviso-item" style="border-left-color: #f97316"><span class="text-orange-400 font-black">${bebe.n} (${fecha}):</span> <span class="text-xs">${c.t}</span></div>`;
                    });
                }
            });
        });
        document.getElementById('panel-avisos-global').innerHTML = htmlAvisos || '<p class="text-[10px] text-slate-500">No hay avisos pendientes.</p>';

        // --- 2. COMPRA GLOBAL ---
        document.getElementById('lista-compra-global').innerHTML = (DATA.compraFamiliar || []).map((x,i)=>`
            <div class="bg-yellow-100 p-4 rounded-3xl flex justify-between items-center text-[10px] font-black uppercase text-yellow-700 shadow-sm border border-yellow-200">
                <span>ðŸ›’ ${x.txt} <small class="opacity-50">(${x.para})</small></span>
                <button onclick="DATA.compraFamiliar.splice(${i},1);sync()"><i class="fa-solid fa-check-circle text-xl"></i></button>
            </div>`).join('');

        // --- 3. DIARIO Y BOTONES (DEL NIÃ‘O SELECCIONADO) ---
        const btnRep = document.getElementById('btn-repetir');
        if(bActivo.lastMl) { btnRep.innerText=`Repetir ${bActivo.lastMl}ml`; btnRep.classList.remove('hidden'); } else { btnRep.classList.add('hidden'); }
        
        document.getElementById('diario-hoy').innerHTML = (bActivo.logs||[]).slice(0,10).map(l=>`
            <div class="bg-white p-4 rounded-2xl flex justify-between border-b shadow-sm"><span class="font-bold text-xs">${l.txt}</span><span class="text-[9px] font-black text-slate-300">${l.h}</span></div>`).join('');

        // Salud (NiÃ±o activo)
        document.getElementById('cur-peso').innerText = bActivo.peso ? bActivo.peso+"kg" : "--.-kg";
        document.getElementById('cur-altura').innerText = bActivo.altura ? bActivo.altura+"cm" : "--cm";
        document.getElementById('historial-pesos').innerHTML = (bActivo.hPeso||[]).slice(0,5).map(h=>`<div class="bg-indigo-50 p-2 rounded-xl text-[10px] font-bold text-indigo-700 min-w-[70px] text-center border">${h.f}<br>${h.kg}kg</div>`).join('');
        document.getElementById('lista-meds').innerHTML = (bActivo.meds||[]).map((m,i)=>`<div class="bg-white p-4 rounded-2xl border shadow-sm flex justify-between"><div><p class="font-black text-xs text-indigo-600">${m.n}</p><p class="text-[8px] font-bold text-slate-400">Cada ${m.g}h</p></div><button onclick="DATA.bebes[bIdx].meds.splice(${i},1);sync()" class="text-red-200"><i class="fa-solid fa-trash"></i></button></div>`).join('');
        document.getElementById('lista-revs').innerHTML = REVS.map((r,i)=>`<div class="p-4 flex justify-between items-center"><div class="text-xs font-black">${r.e}</div><div class="flex gap-2"><button onclick="agendarRev('${r.e}')" class="text-[8px] font-bold bg-slate-100 p-2 rounded-lg text-slate-500">+CITA</button><input type="checkbox" onchange="toggleRev(${i})" ${bActivo.revs&&bActivo.revs[i]?'checked':''} class="w-5 h-5 accent-blue-600"></div></div>`).join('');
        document.getElementById('lista-alimentos').innerHTML = (bActivo.foods||[]).map(f=>`<div class="bg-white p-4 rounded-2xl flex justify-between shadow-sm font-bold text-xs"><span>${f.n}</span><span>${f.r}</span></div>`).join('');

        renderCal();
        document.getElementById('cfg-int').value = DATA.intervalo;
    }

    function renderCal() {
        const grid = document.getElementById('cal-grid'); grid.innerHTML = "";
        const y = curMonth.getFullYear(), m = curMonth.getMonth();
        document.getElementById('cal-month').innerText = new Intl.DateTimeFormat('es',{month:'long',year:'numeric'}).format(curMonth);
        const start = (new Date(y,m,1).getDay()+6)%7, days = new Date(y,m+1,0).getDate();
        for(let i=0;i<start;i++) grid.innerHTML+=`<div></div>`;
        for(let i=1;i<=days;i++){
            const d = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const has = DATA.bebes[bIdx].citas && DATA.bebes[bIdx].citas[d];
            grid.innerHTML += `<div onclick="selDate='${d}';render()" class="cal-day ${d===selDate?'bg-blue-600 text-white shadow-lg':(has?'bg-blue-100 text-blue-600':'bg-slate-50')}">${i}</div>`;
        }
        let list = ""; const citas = DATA.bebes[bIdx].citas || {};
        if(citas[selDate]) citas[selDate].forEach((c,i) => {
            list += `<div class="bg-white p-4 rounded-2xl border-l-4 border-blue-600 flex justify-between items-center shadow-sm"><div><p class="text-[8px] font-black text-blue-500">${c.h||'--:--'}</p><p class="text-xs font-bold">${c.t}</p></div><button onclick="DATA.bebes[bIdx].citas['${selDate}'].splice(${i},1);sync()" class="text-slate-200"><i class="fa-solid fa-xmark"></i></button></div>`;
        });
        document.getElementById('agenda-lista').innerHTML = list || '<p class="text-center text-[9px] font-bold text-slate-300 py-10">SIN CITAS</p>';
    }

    // UTILS
    function toggleRev(i) { if(!DATA.bebes[bIdx].revs) DATA.bebes[bIdx].revs = {}; DATA.bebes[bIdx].revs[i] = !DATA.bebes[bIdx].revs[i]; sync(); }
    function agendarRev(txt) { selDate = new Date().toISOString().split('T')[0]; document.getElementById('c-txt').value = "RevisiÃ³n "+txt; showTab('cal'); openModal('modal-cal'); }
    function switchBebe(v) { bIdx = parseInt(v); localStorage.setItem('EVA_CARE_BEBE_IDX', v); render(); }
    function updateCfg() { DATA.intervalo = document.getElementById('cfg-int').value; sync(); }
    function setReac(r, b) { curReac = r; document.querySelectorAll('.reac-btn').forEach(x=>x.classList.remove('reac-active')); b.classList.add('reac-active'); }
    function addNewBebe() {
        const n = document.getElementById('new-n').value, f = document.getElementById('new-f').value;
        if(n && f) { 
            const existe = DATA.bebes.find(x => x.n.toLowerCase() === n.toLowerCase());
            if(existe) { alert("Ya existe alguien con ese nombre."); return; }
            DATA.bebes.push({n,f,logs:[],meds:[],foods:[],citas:{},compra:[],hPeso:[]}); 
            sync(); closeModal('modal-menu'); 
        }
    }
    function showTab(t) { document.querySelectorAll('main').forEach(m=>m.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b=>b.className='text-slate-300 p-4'); document.getElementById('nav-'+t).className='text-blue-600 p-4'; }
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function changeMonth(v) { curMonth.setMonth(curMonth.getMonth()+v); render(); }

    init();
    setInterval(render, 30000); // Actualiza avisos cada 30s
</script>
</body>
</html>
