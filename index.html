<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EvaCare Final</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
body { font-family: system-ui; }
.hidden { display:none; }
</style>
</head>

<body class="bg-slate-50">

<!-- LOADING -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
  <div class="text-blue-600 text-4xl font-black animate-pulse">EvaCare</div>
</div>

<!-- LOGIN -->
<div id="login" class="hidden p-8 max-w-md mx-auto">
  <h1 class="text-3xl font-black text-blue-600 mb-6">EvaCare</h1>
  <input id="email" class="w-full p-4 mb-3 bg-slate-100 rounded-xl" placeholder="Email">
  <input id="pass" type="password" class="w-full p-4 mb-4 bg-slate-100 rounded-xl" placeholder="Contraseña">
  <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black mb-2">Entrar</button>
  <button onclick="register()" class="w-full bg-green-600 text-white p-4 rounded-xl font-black">Crear cuenta</button>
</div>

<!-- FAMILY SETUP -->
<div id="familySetup" class="hidden p-8 max-w-md mx-auto">
  <h2 class="text-xl font-black mb-4">Configurar familia</h2>

  <div class="mb-6">
    <input id="familyName" class="w-full p-4 bg-slate-100 rounded-xl mb-2" placeholder="Nombre de la familia">
    <button onclick="createFamily()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">
      Crear familia
    </button>
  </div>

  <div class="border-t pt-4">
    <input id="joinCode" class="w-full p-4 bg-slate-100 rounded-xl mb-2" placeholder="Código de familia">
    <button onclick="joinFamily()" class="w-full bg-green-600 text-white p-4 rounded-xl font-black">
      Unirse a familia
    </button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden p-6 max-w-3xl mx-auto">
  <header class="flex justify-between items-center mb-6">
    <div>
      <h1 id="familyTitle" class="text-2xl font-black text-blue-600"></h1>
      <p class="text-xs text-slate-400">Código: <span id="inviteCode"></span></p>
    </div>
    <button onclick="logout()" class="text-red-500 font-black">Salir</button>
  </header>

  <h2 class="font-black mb-2">Hijos</h2>
  <div id="children"></div>

  <button onclick="addChild()" class="mt-4 bg-blue-600 text-white p-4 rounded-xl font-black w-full">
    Añadir hijo
  </button>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAvFcHDaFUg_sPWyN6YmdMRJe3YiEHaq0I",
  authDomain: "evacare-24cae.firebaseapp.com",
  databaseURL: "https://evacare-24cae-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "evacare-24cae"
});

const auth = firebase.auth();
const db = firebase.database();

/* STATE */
let uid = localStorage.getItem("uid");
let familyId = localStorage.getItem("familyId");
let familyData = null;

/* UTILS */
const show = id => {
  ["loading","login","familySetup","app"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
};

const genCode = () => Math.random().toString(36).substring(2,8).toUpperCase();

/* AUTH */
function login(){
  auth.signInWithEmailAndPassword(email.value, pass.value)
  .then(r=>{
    uid=r.user.uid;
    localStorage.setItem("uid",uid);
    checkFamily();
  }).catch(e=>alert(e.message));
}

function register(){
  auth.createUserWithEmailAndPassword(email.value, pass.value)
  .then(r=>{
    uid=r.user.uid;
    localStorage.setItem("uid",uid);
    show("familySetup");
  }).catch(e=>alert(e.message));
}

function logout(){
  auth.signOut();
  localStorage.clear();
  location.reload();
}

/* FAMILY */
function checkFamily(){
  if(!familyId){ show("familySetup"); return; }
  loadFamily();
}

function createFamily(){
  const name = familyName.value.trim();
  if(!name) return alert("Nombre requerido");

  familyId = db.ref("familias").push().key;
  const invite = genCode();

  db.ref("familias/"+familyId).set({
    name,
    inviteCode: invite,
    members:{ [uid]:"owner" },
    children:{}
  }).then(()=>{
    localStorage.setItem("familyId",familyId);
    loadFamily();
  });
}

function joinFamily(){
  const code = joinCode.value.trim().toUpperCase();
  if(!code) return;

  db.ref("familias").orderByChild("inviteCode").equalTo(code).once("value",snap=>{
    if(!snap.exists()) return alert("Código inválido");
    const fid = Object.keys(snap.val())[0];
    familyId=fid;
    localStorage.setItem("familyId",fid);
    db.ref(`familias/${fid}/members/${uid}`).set("member");
    loadFamily();
  });
}

function loadFamily(){
  show("loading");
  db.ref("familias/"+familyId).on("value",snap=>{
    familyData=snap.val();
    render();
    show("app");
  });
}

/* CHILDREN */
function render(){
  familyTitle.innerText = familyData.name;
  inviteCode.innerText = familyData.inviteCode;
  children.innerHTML="";
  Object.entries(familyData.children||{}).forEach(([id,c])=>{
    children.innerHTML+=`
    <div class="bg-white p-4 rounded-xl mb-3">
      <input value="${c.name}" onblur="updateChild('${id}','name',this.value)" class="font-black w-full">
      <input type="date" value="${c.birth||''}" onblur="updateChild('${id}','birth',this.value)" class="text-sm">
    </div>`;
  });
}

function addChild(){
  const id=genCode();
  db.ref(`familias/${familyId}/children/${id}`).set({name:"Nuevo hijo"});
}

function updateChild(id,f,v){
  db.ref(`familias/${familyId}/children/${id}/${f}`).set(v);
}

/* INIT */
uid ? checkFamily() : show("login");
</script>
</body>
</html>
